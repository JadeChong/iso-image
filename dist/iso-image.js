!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(r=r||self).IsoImage=t()}(this,function(){"use strict";Object.assign||(Object.assign=function(r){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];for(var o,n=Object(r),a=Object.prototype.hasOwnProperty,i=0,s=t.length;i<s;i++)for(var l in o=Object(t[i]))a.call(o,l)&&(n[l]=o[l]);return n});var r=Math.max,t=Math.min,e=Math.abs,o=Math.floor;function n(r){return r=Number(r),isNaN(r)?0:0===r||r===1/0||r===-1/0?r:(r<0?-1:1)*o(e(r))}Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var r,t;for(r=0,t=0;r<this.length;r++)t+=this[r];return t/this.length},Array.prototype.fill=function(e){var o=arguments[1],a=arguments[2],i=function(r){if(null==r)throw TypeError();return Object(r)}(this),s=function(r){var e=n(r);return e<=0?0:e===1/0?9007199254740991:t(e,9007199254740991)}(i.length);s=r(s,0);var l,f,h,c=n(o);for(l=c<0?r(s+c,0):t(c,s),h=(f=void 0===a?s:n(a))<0?r(s+f,0):t(f,s);l<h;){i[String(l)]=e,l+=1}return i},Array.prototype.rep=function(r){return Array.apply(null,new Array(r)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(r,t){var e,o,n=!1;for(e=0,o=this.length-1;e<this.length;o=e++)this[e][1]>t!=this[o][1]>t&&r<(this[o][0]-this[e][0])*(t-this[e][1])/(this[o][1]-this[e][1])+this[e][0]&&(n=!n);return n};var a=function(){var r={},t=function(r,t){var e,o=new Array(t*t).fill(0);for(e=0;e<t;e++)o[e*t+e]=r;return o},e=function(r,t,e,o){var n,a,i=Array(e*o);for(n=0;n<e;n++)for(a=0;a<o;a++)i[n*o+a]=r[n*o+a]+t[n*o+a];return i},o=function(r,t,e,o,n){var a,i,s,l=Array(e*n);for(a=0;a<e;a++)for(i=0;i<n;i++)for(l[a*n+i]=0,s=0;s<o;s++)l[a*n+i]+=r[a*o+s]*t[s*n+i];return l},n=function(r,t){var e,o,n,a=Array(t);for(e=0;e<t;e++)a[e]=r[e*t+e];for(e=0;e<t;e++){for(o=0;o<e;o++)a[e]-=r[e*t+o]*r[e*t+o];if(a[e]<=0)return!1;for(a[e]=Math.sqrt(a[e]),o=e+1;o<t;o++){for(n=0;n<e;n++)r[o*t+e]-=r[o*t+n]*r[e*t+n];r[o*t+e]/=a[e]}}for(e=0;e<t;e++)r[e*t+e]=a[e];return!0},a=function(r,t){var e,o,n,a;for(e=0;e<t;e++)for(r[e*t+e]=1/r[e*t+e],o=e+1;o<t;o++){for(a=0,n=e;n<o;n++)a-=r[o*t+n]*r[n*t+e];r[o*t+e]=a/r[o*t+o]}for(e=0;e<t;e++)for(o=e+1;o<t;o++)r[e*t+o]=0;for(e=0;e<t;e++){for(r[e*t+e]*=r[e*t+e],n=e+1;n<t;n++)r[e*t+e]+=r[n*t+e]*r[n*t+e];for(o=e+1;o<t;o++)for(n=o;n<t;n++)r[e*t+o]+=r[n*t+e]*r[n*t+o]}for(e=0;e<t;e++)for(o=0;o<e;o++)r[e*t+o]=r[o*t+e]},i=function(r,t){var e,o,n,a,i,s,l,f,h,c,u,p=t,v=Array(t*t),g=Array(t),d=Array(t),y=Array(t);for(e=0;e<t;e++)for(a=0;a<t;a++)v[e*t+a]=e==a?1:0;for(a=0;a<t;a++)y[a]=0;for(e=0;e<t;e++){for(f=0,a=0;a<t;a++)if(1!=y[a])for(i=0;i<t;i++)0==y[i]&&Math.abs(r[a*t+i])>=f&&(f=Math.abs(r[a*t+i]),n=a,o=i);if(++y[o],n!=o){for(s=0;s<t;s++)u=r[n*t+s],r[n*t+s]=r[o*t+s],r[o*t+s]=u;for(s=0;s<p;s++)u=v[n*t+s],v[n*t+s]=v[o*t+s],v[o*t+s]=u}if(d[e]=n,g[e]=o,0==r[o*t+o])return!1;for(c=1/r[o*t+o],r[o*t+o]=1,s=0;s<t;s++)r[o*t+s]*=c;for(s=0;s<p;s++)v[o*t+s]*=c;for(l=0;l<t;l++)if(l!=o){for(h=r[l*t+o],r[l*t+o]=0,s=0;s<t;s++)r[l*t+s]-=r[o*t+s]*h;for(s=0;s<p;s++)v[l*t+s]-=v[o*t+s]*h}}for(s=t-1;s>=0;s--)if(d[s]!=g[s])for(i=0;i<t;i++)u=r[i*t+d[s]],r[i*t+d[s]]=r[i*t+g[s]],r[i*t+g[s]]=u;return!0},s=function(r,t,e,o,n){return t+(o-t)/e*(1-Math.exp(-1/n*Math.pow(r/e,2)))},l=function(r,t,e,o,n){return t+(o-t)/e*(1-Math.exp(-1/n*(r/e)))},f=function(r,t,e,o,n){return r>e?t+(o-t)/e:t+(o-t)/e*(r/e*1.5-.5*Math.pow(r/e,3))};return r.train=function(r,h,c,u,p,v){var g={t:r,x:h,y:c,nugget:0,range:0,sill:0,A:1/3,n:0};switch(u){case"gaussian":g.model=s;break;case"exponential":g.model=l;break;case"spherical":g.model=f}var d,y,b,m,M=r.length,w=Array((M*M-M)/2);for(d=0,b=0;d<M;d++)for(y=0;y<d;y++,b++)w[b]=Array(2),w[b][0]=Math.pow(Math.pow(h[d]-h[y],2)+Math.pow(c[d]-c[y],2),.5),w[b][1]=Math.abs(r[d]-r[y]);w.sort(function(r,t){return r[0]-t[0]}),g.range=w[(M*M-M)/2-1][0];var x=(M*M-M)/2>30?30:(M*M-M)/2,A=g.range/x,k=new Array(x).fill(0),S=new Array(x).fill(0);if(x<30)for(m=0;m<x;m++)k[m]=w[m][0],S[m]=w[m][1];else{for(d=0,y=0,b=0,m=0;d<x&&y<(M*M-M)/2;d++,b=0){for(;w[y][0]<=(d+1)*A&&(k[m]+=w[y][0],S[m]+=w[y][1],b++,!(++y>=(M*M-M)/2)););b>0&&(k[m]/=b,S[m]/=b,m++)}if(m<2)return g}M=m,g.range=k[M-1]-k[0];var O=new Array(2*M).fill(1),I=Array(M),j=g.A;for(d=0;d<M;d++){switch(u){case"gaussian":O[2*d+1]=1-Math.exp(-1/j*Math.pow(k[d]/g.range,2));break;case"exponential":O[2*d+1]=1-Math.exp(-1/j*k[d]/g.range);break;case"spherical":O[2*d+1]=k[d]/g.range*1.5-.5*Math.pow(k[d]/g.range,3)}I[d]=S[d]}var G=function(r,t,e){var o,n,a=Array(e*t);for(o=0;o<t;o++)for(n=0;n<e;n++)a[n*t+o]=r[o*e+n];return a}(O,M,2),L=o(G,O,2,M,2),N=(L=e(L,t(1/v,2),2,2)).slice(0);n(L,2)?a(L,2):(i(N,2),L=N);var R=o(o(L,G,2,2,M),I,2,M,1);g.nugget=R[0],g.sill=R[1]*g.range+g.nugget,g.n=h.length,M=h.length;var C=Array(M*M);for(d=0;d<M;d++){for(y=0;y<d;y++)C[d*M+y]=g.model(Math.pow(Math.pow(h[d]-h[y],2)+Math.pow(c[d]-c[y],2),.5),g.nugget,g.range,g.sill,g.A),C[y*M+d]=C[d*M+y];C[d*M+d]=g.model(0,g.nugget,g.range,g.sill,g.A)}var z=e(C,t(p,M),M,M),J=z.slice(0);n(z,M)?a(z,M):(i(J,M),z=J);C=z.slice(0);var P=o(z,r,M,M,1);return g.K=C,g.M=P,g},r.predict=function(r,t,e){var n,a=Array(e.n);for(n=0;n<e.n;n++)a[n]=e.model(Math.pow(Math.pow(r-e.x[n],2)+Math.pow(t-e.y[n],2),.5),e.nugget,e.range,e.sill,e.A);return o(a,e.M,1,e.n,1)[0]},r}();const i=function(r,t){return r[0]*t[1]-r[1]*t[0]},s=function(r,t,e,o){var n=[r[0]-e[0],r[1]-e[1]],a=[t[0]-e[0],t[1]-e[1]],s=[o[0]-e[0],o[1]-e[1]],l=i(n,s)*i(a,s);return n=[e[0]-r[0],e[1]-r[1]],a=[o[0]-r[0],o[1]-r[1]],s=[t[0]-r[0],t[1]-r[1]],l<=0&&i(n,s)*i(a,s)<=0},l=function(r,t){for(var e,o,n=r,a=[-100,r[1]],i=0,l=0,f=t.length-1;l<f;l++)e=t[l],o=t[l+1],s(n,a,e,o)&&i++;return e=t[t.length-1],o=t[0],s(n,a,e,o)&&i++,i%2!=0},f=function(r,t){return r[0]==t[0]&&r[1]==t[1]};var h=function(r,t,e,o,n,a,i){i=i||[];for(var s,l,c,u,p=o[o.length-1],v="t"==n||"b"==n?0:1,g="t"==n||"l"==n?1:-1,d=a?-1:1,y=0;e[n][y];y++){var b=e[n][y],m=(b.p[v]-p[v])*g*d;m>0&&(!s||s&&l>m)&&(s=b,l=m)}if(s)f(s.p,o[0])?o.push(s.p):(u=function(r){return JSON.parse(JSON.stringify(r))}(r[s.coor].coor),s.d&&u.reverse(),o=o.concat(u)),c=s.t;else if(a)switch(n){case"t":o.push(t.sa),c="r";break;case"r":o.push(t.sb),c="b";break;case"b":o.push(t.sc),c="l";break;case"l":o.push(t.sd),c="t"}else switch(n){case"t":o.push(t.sb),c="r";break;case"r":o.push(t.sc),c="b";break;case"b":o.push(t.sd),c="l";break;case"l":o.push(t.sa),c="t"}return o.length>1&&f(o[0],o[o.length-1])?[o].concat(i):(s&&u&&(i=h(r,t,e,u,c,!a,i)),o=h(r,t,e,o,c,a,i))};const c=Math.abs,u=Math.max,p=function(r,t){return c(r-t)},v=function(r,t){for(var e=0,o=u(p(t[0],t[2]),p(t[1],t[3])),n=0;n<4;n++){var a=p(t[n],r[n%2]);a<o&&(o=a,e=n)}return"lbrt".charAt(e)},g=function(r,t){return r[0]==t[0]&&r[1]==t[1]};function d(r,t,e){var o=null==(e=e||{}).gradient||e.gradient,n=r.size,a=r.cellWidth,i=r.level,s=r.ex,l=e.width||1e3,f=Math.abs(l/n[0]*n[1]),h=document.createElement("canvas");h.width=l,h.height=f;var c=h.getContext("2d");c.clearRect(0,0,l,f);for(var u=t.features,p=Math.abs(a/n[0]*l),v=Math.abs(a/n[1]*f),g=0,d=u.length;g<d;g++){var b=u[g].geometry.coordinates,m=(b[0]-s[0][0])/n[0]*l-p/2,M=(b[1]-s[0][1])/n[1]*f-v/2,w=y(i,u[g].properties.val,o);c.strokeStyle=c.fillStyle="rgb("+w.r+","+w.g+","+w.b+")",c.beginPath(),c.fillRect(m-1,M-1,p+2,v+2)}return h}function y(r,t,e){for(var o=!1,n=0,a=r.length;n<a;n++){if(t<r[n].value){if(!o){o=JSON.parse(JSON.stringify(r[n]));break}var i=(t-o.value)/(r[n].value-o.value),s=function(t){return e?parseInt(o[t]+(r[n][t]-o[t])*i):r[n][t]};o.r=s("r"),o.g=s("g"),o.b=s("b");break}o=JSON.parse(JSON.stringify(r[n]))}return o}function b(r,t,e){e=e||{};var o=r.size,n=r.ex,a=e.width||1e3,i=Math.abs(a/o[0]*o[1]),s=e.isolineColor||"#333",l=document.createElement("canvas");l.width=a,l.height=i;var f=l.getContext("2d");f.clearRect(0,0,a,i),f.lineWidth=1,f.font="12px 微软雅黑",f.textBaseline="middle",f.textAlign="center";for(var h=t.features,c={},u=0,p=h.length;u<p;u++){var v=h[u].geometry.coordinates,g="level"==s?h[u].properties.color:s;f.strokeStyle=f.fillStyle=g;for(var d=0,y=v.length;d<y;d++){f.beginPath();for(var b=0,m=0,M=v[d].length;m<M;m++){var w=(v[d][m][0]-n[0][0])/o[0]*a,x=(v[d][m][1]-n[0][1])/o[1]*i;f[m?"lineTo":"moveTo"](w,x);var A=Math.round(w/16)+"-"+Math.round(x/16);c[A]||b||(c[A]=1,b=1,f.fillText(h[u].properties.val,w,x))}f.stroke()}}return l}const m=Object.prototype.toString,M=function(r){return"[object Array]"===m.call(r)};function w(r,t,e){if(!r[0])return!1;var o=(e=e||{}).opacity||1,n=r[0].width,a=r[0].height,i=document.createElement("canvas");i.width=n,i.height=a;var s=i.getContext("2d");s.clearRect(0,0,n,a),s.globalAlpha=o,s.strokeStyle=e.clipColor||"#333",s.lineWidth=e.clipWidth||1;var l=t.clip;if(l&&M(l)){var f=t.ex,h=t.size,c=t.key||{},u=c.clipX||0,p=c.clipY||1;s.beginPath();var v=function(r){if(M(r[0])&&M(r[0][0]))for(var t=0,e=r.length;t<e;t++)v(r[t]);else if(M(r))for(t=0,e=r.length;t<e;t++){var o=(r[t][u]-f[0][0])/h[0]*n,i=(r[t][p]-f[0][1])/h[1]*a;s[t?"lineTo":"moveTo"](o,i)}};v(l),e.clip&&s.stroke(),s.clip()}for(var g=0;r[g];g++){var d=s.createPattern(r[g],"repeat");s.fillStyle=d,s.fillRect(0,0,n,a)}return i}const x=window.turf,A="IsoImage",k="image/png",S=Object.prototype.toString,O=Math.min,I=Math.max,j=Math.abs,G=Math.round,L={x:"x",y:"y",v:"v",clipX:"0",clipY:"1"};function N(r,t){this.name=A,this.initialize(r,t),this.getLegend=function(){return function(r){if(r.legend<2)return!1;var t=document.createElement("canvas");t.width=200,t.height=30;for(var e=t.getContext("2d"),o=e.createLinearGradient(0,0,200,0),n=0,a=r.length;n<a;n++){var i=r[n].color;o.addColorStop(1/a*n,i)}return e.fillStyle=o,e.fillRect(0,0,200,30),t.toDataURL("image/png")}(this.option.level||[])},this.getIsosurface=function(r){return!!this.alow()&&w([d(this.option,this.pointGrid,r)],this.option,r).toDataURL(k)},this.getIsoline=function(r){return!!this.alow()&&w([b(this.option,this.isoline,r)],this.option,r).toDataURL(k)},this.getIsoImage=function(r){return!!this.alow()&&w([d(this.option,this.pointGrid,r),b(this.option,this.isoline,r)],this.option,r).toDataURL(k)}}return N.prototype={constructor:N,initialize:function(r,t){var e=t.extent,o=t.level;if(!e)return console.log("缺少参数extent(画布左上右下坐标)");if(!o)return console.log("缺少参数level(色阶)");o=this.fmtLevel(o);var n=[O(e[0][0],e[1][0]),O(e[0][1],e[1][1]),I(e[0][0],e[1][0]),I(e[0][1],e[1][1])],a=[e[1][0]-e[0][0],e[1][1]-e[0][1]],i=t.cellWidth||G(j(a[0])/200*1e6)/1e6,s=Object.assign({},L,t.keyConfig);this.option={type:t.type||"idw",pow:t.pow||3,model:t.model||"spherical",clip:t.clip,smooth:t.smooth,ex:e,extent:n,size:a,cellWidth:i,level:o,key:s};var l=[],f=[],h=[],c=[];if(function(r){return"[object Array]"===S.call(r)}(r))for(var u=0,p=r.length;u<p;u++)if(null!=r[u][s.v]){var v=r[u][s.v],g=r[u][s.x],d=r[u][s.y];l.push({x:g,y:d,v:v}),f.push(v),h.push(g),c.push(d)}this.points=l,this._v=f,this._x=h,this._y=c,this.pointGrid=x.pointGrid(n,i,{units:"degrees"}),this.build()},build:function(){this.calcGridValue(),this.calcIsoLines()},calcGridValue:function(){var r=this.option,t=this.pointGrid;switch(r.type){case"kriging":for(var e=a.train(this._v,this._x,this._y,r.model,.1,100),o=0;o<t.features.length;o++){var n=a.predict(t.features[o].geometry.coordinates[0],t.features[o].geometry.coordinates[1],e);t.features[o].properties.val=n}break;default:var i=this.points;this.pointGrid=function(r,t,e){null==e&&(e=3);var o=t.features;if(r.length<3)return t;for(var n=r.length,a=o.length,i=[],s=0;s<a;s++)for(var l=0;l<n;l++){var f=Math.sqrt(Math.pow(o[s].geometry.coordinates[0]-r[l].x,2)+Math.pow(o[s].geometry.coordinates[1]-r[l].y,2));i.push(f)}for(s=0;s<a;s++){var h=!1;for(l=n*s;l<n*s+n;l++)if(Math.abs(i[l])<1e-4){o[s].properties.val=r[l-n*s].v,h=!0;break}if(!h){var c=0,u=0;for(l=n*s;l<n*s+n;l++)c+=r[l-n*s].v/Math.pow(i[l],e),u+=1/Math.pow(i[l],e);o[s].properties.val=c/u}}return t}(i,t,r.pow)}},calcIsoLines:function(){for(var r=this.option,t=this.pointGrid,e=r.level,o=[],n=0,a=e.length;n<a;n++)o.push(e[n].value);var i=x.isolines(t,o,{zProperty:"val"}),s=i.features;for(n=0,a=s.length;n<a;n++)for(var f=s[n].properties.val,c=0;e[c];c++)if(e[c].value==f){s[n].properties.color=e[c].color;break}if(r.smooth){var u=i.features;for(n=0;n<u.length;n++){for(var p=u[n].geometry.coordinates,d=[],y=0;y<p.length;y++){var b=p[y],m=x.lineString(b),M=x.bezierSpline(m);d.push(M.geometry.coordinates)}u[n].geometry.coordinates=d}}this.isoline=i,this.isosurface=function(r,t){for(var e,o=[],n=[],a={t:[],b:[],l:[],r:[]},i=r.features,s=0,f=i.length;s<f;s++)for(var c=i[s],u=c.geometry.coordinates,p=0,d=u.length;p<d;p++){var y=u[p],b=y[0],m=y[y.length-1];if(g(b,m))o.push({coor:y,properties:c.properties});else{n.push({coor:y,properties:c.properties});var M=v(b,t),w=v(m,t);a[M].push({p:b,end:m,d:0,t:w,coor:n.length-1}),a[w].push({p:m,end:b,d:1,t:M,coor:n.length-1})}}for(var x={sa:[t[0],t[3]],sb:[t[2],t[3]],sc:[t[2],t[1]],sd:[t[0],t[1]]},A=[],k=(s=0,(e=h(n,x,a,[x.sa],"t",!1)).length);s<k;s++)A.push({coor:e[s],properties:{type:"open"}});for(console.log(o),console.log(A),console.log(l(o[0].coor[0],o[1].coor)),s=0,f=o.length;s<f;s++)for(var S=0,O=A.length;S<O;S++){var I=o[s].coor[0],j=A[S].coor;l(I,j)}return{features:[],type:"FeatureCollection"}}(i,r.extent)},fmtLevel:function(r){for(var t=0,e=r.length;t<e;t++){var o=r[t].color;r[t].r=parseInt(o.substr(1,2),16),r[t].g=parseInt(o.substr(3,2),16),r[t].b=parseInt(o.substr(5,2),16)}return r},alow:function(){return this.pointGrid&&this.isoline}},N});
