!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t=t||self).IsoImage=r()}(this,function(){"use strict";Object.assign||(Object.assign=function(t){for(var r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];for(var o,n=Object(t),i=Object.prototype.hasOwnProperty,a=0,l=r.length;a<l;a++)for(var s in o=Object(r[a]))i.call(o,s)&&(n[s]=o[s]);return n});var t=Math.max,r=Math.min,e=Math.abs,o=Math.floor;function n(t){return t=Number(t),isNaN(t)?0:0===t||t===1/0||t===-1/0?t:(t<0?-1:1)*o(e(t))}Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var t,r;for(t=0,r=0;t<this.length;t++)r+=this[t];return r/this.length},Array.prototype.fill=function(e){var o=arguments[1],i=arguments[2],a=function(t){if(null==t)throw TypeError();return Object(t)}(this),l=function(t){var e=n(t);return e<=0?0:e===1/0?9007199254740991:r(e,9007199254740991)}(a.length);l=t(l,0);var s,f,h,u=n(o);for(s=u<0?t(l+u,0):r(u,l),h=(f=void 0===i?l:n(i))<0?t(l+f,0):r(f,l);s<h;){a[String(s)]=e,s+=1}return a},Array.prototype.rep=function(t){return Array.apply(null,new Array(t)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(t,r){var e,o,n=!1;for(e=0,o=this.length-1;e<this.length;o=e++)this[e][1]>r!=this[o][1]>r&&t<(this[o][0]-this[e][0])*(r-this[e][1])/(this[o][1]-this[e][1])+this[e][0]&&(n=!n);return n};var i=function(){var t={},r=function(t,r){var e,o=new Array(r*r).fill(0);for(e=0;e<r;e++)o[e*r+e]=t;return o},e=function(t,r,e,o){var n,i,a=Array(e*o);for(n=0;n<e;n++)for(i=0;i<o;i++)a[n*o+i]=t[n*o+i]+r[n*o+i];return a},o=function(t,r,e,o,n){var i,a,l,s=Array(e*n);for(i=0;i<e;i++)for(a=0;a<n;a++)for(s[i*n+a]=0,l=0;l<o;l++)s[i*n+a]+=t[i*o+l]*r[l*n+a];return s},n=function(t,r){var e,o,n,i=Array(r);for(e=0;e<r;e++)i[e]=t[e*r+e];for(e=0;e<r;e++){for(o=0;o<e;o++)i[e]-=t[e*r+o]*t[e*r+o];if(i[e]<=0)return!1;for(i[e]=Math.sqrt(i[e]),o=e+1;o<r;o++){for(n=0;n<e;n++)t[o*r+e]-=t[o*r+n]*t[e*r+n];t[o*r+e]/=i[e]}}for(e=0;e<r;e++)t[e*r+e]=i[e];return!0},i=function(t,r){var e,o,n,i;for(e=0;e<r;e++)for(t[e*r+e]=1/t[e*r+e],o=e+1;o<r;o++){for(i=0,n=e;n<o;n++)i-=t[o*r+n]*t[n*r+e];t[o*r+e]=i/t[o*r+o]}for(e=0;e<r;e++)for(o=e+1;o<r;o++)t[e*r+o]=0;for(e=0;e<r;e++){for(t[e*r+e]*=t[e*r+e],n=e+1;n<r;n++)t[e*r+e]+=t[n*r+e]*t[n*r+e];for(o=e+1;o<r;o++)for(n=o;n<r;n++)t[e*r+o]+=t[n*r+e]*t[n*r+o]}for(e=0;e<r;e++)for(o=0;o<e;o++)t[e*r+o]=t[o*r+e]},a=function(t,r){var e,o,n,i,a,l,s,f,h,u,c,p=r,g=Array(r*r),v=Array(r),y=Array(r),d=Array(r);for(e=0;e<r;e++)for(i=0;i<r;i++)g[e*r+i]=e==i?1:0;for(i=0;i<r;i++)d[i]=0;for(e=0;e<r;e++){for(f=0,i=0;i<r;i++)if(1!=d[i])for(a=0;a<r;a++)0==d[a]&&Math.abs(t[i*r+a])>=f&&(f=Math.abs(t[i*r+a]),n=i,o=a);if(++d[o],n!=o){for(l=0;l<r;l++)c=t[n*r+l],t[n*r+l]=t[o*r+l],t[o*r+l]=c;for(l=0;l<p;l++)c=g[n*r+l],g[n*r+l]=g[o*r+l],g[o*r+l]=c}if(y[e]=n,v[e]=o,0==t[o*r+o])return!1;for(u=1/t[o*r+o],t[o*r+o]=1,l=0;l<r;l++)t[o*r+l]*=u;for(l=0;l<p;l++)g[o*r+l]*=u;for(s=0;s<r;s++)if(s!=o){for(h=t[s*r+o],t[s*r+o]=0,l=0;l<r;l++)t[s*r+l]-=t[o*r+l]*h;for(l=0;l<p;l++)g[s*r+l]-=g[o*r+l]*h}}for(l=r-1;l>=0;l--)if(y[l]!=v[l])for(a=0;a<r;a++)c=t[a*r+y[l]],t[a*r+y[l]]=t[a*r+v[l]],t[a*r+v[l]]=c;return!0},l=function(t,r,e,o,n){return r+(o-r)/e*(1-Math.exp(-1/n*Math.pow(t/e,2)))},s=function(t,r,e,o,n){return r+(o-r)/e*(1-Math.exp(-1/n*(t/e)))},f=function(t,r,e,o,n){return t>e?r+(o-r)/e:r+(o-r)/e*(t/e*1.5-.5*Math.pow(t/e,3))};return t.train=function(t,h,u,c,p,g){var v={t:t,x:h,y:u,nugget:0,range:0,sill:0,A:1/3,n:0};switch(c){case"gaussian":v.model=l;break;case"exponential":v.model=s;break;case"spherical":v.model=f}var y,d,m,b,M=t.length,w=Array((M*M-M)/2);for(y=0,m=0;y<M;y++)for(d=0;d<y;d++,m++)w[m]=Array(2),w[m][0]=Math.pow(Math.pow(h[y]-h[d],2)+Math.pow(u[y]-u[d],2),.5),w[m][1]=Math.abs(t[y]-t[d]);w.sort(function(t,r){return t[0]-r[0]}),v.range=w[(M*M-M)/2-1][0];var x=(M*M-M)/2>30?30:(M*M-M)/2,A=v.range/x,k=new Array(x).fill(0),S=new Array(x).fill(0);if(x<30)for(b=0;b<x;b++)k[b]=w[b][0],S[b]=w[b][1];else{for(y=0,d=0,m=0,b=0;y<x&&d<(M*M-M)/2;y++,m=0){for(;w[d][0]<=(y+1)*A&&(k[b]+=w[d][0],S[b]+=w[d][1],m++,!(++d>=(M*M-M)/2)););m>0&&(k[b]/=m,S[b]/=m,b++)}if(b<2)return v}M=b,v.range=k[M-1]-k[0];var O=new Array(2*M).fill(1),I=Array(M),j=v.A;for(y=0;y<M;y++){switch(c){case"gaussian":O[2*y+1]=1-Math.exp(-1/j*Math.pow(k[y]/v.range,2));break;case"exponential":O[2*y+1]=1-Math.exp(-1/j*k[y]/v.range);break;case"spherical":O[2*y+1]=k[y]/v.range*1.5-.5*Math.pow(k[y]/v.range,3)}I[y]=S[y]}var G=function(t,r,e){var o,n,i=Array(e*r);for(o=0;o<r;o++)for(n=0;n<e;n++)i[n*r+o]=t[o*e+n];return i}(O,M,2),R=o(G,O,2,M,2),z=(R=e(R,r(1/g,2),2,2)).slice(0);n(R,2)?i(R,2):(a(z,2),R=z);var C=o(o(R,G,2,2,M),I,2,M,1);v.nugget=C[0],v.sill=C[1]*v.range+v.nugget,v.n=h.length,M=h.length;var L=Array(M*M);for(y=0;y<M;y++){for(d=0;d<y;d++)L[y*M+d]=v.model(Math.pow(Math.pow(h[y]-h[d],2)+Math.pow(u[y]-u[d],2),.5),v.nugget,v.range,v.sill,v.A),L[d*M+y]=L[y*M+d];L[y*M+y]=v.model(0,v.nugget,v.range,v.sill,v.A)}var N=e(L,r(p,M),M,M),P=N.slice(0);n(N,M)?i(N,M):(a(P,M),N=P);L=N.slice(0);var T=o(N,t,M,M,1);return v.K=L,v.M=T,v},t.predict=function(t,r,e){var n,i=Array(e.n);for(n=0;n<e.n;n++)i[n]=e.model(Math.pow(Math.pow(t-e.x[n],2)+Math.pow(r-e.y[n],2),.5),e.nugget,e.range,e.sill,e.A);return o(i,e.M,1,e.n,1)[0]},t}();function a(t,r,e){var o=null==(e=e||{}).gradient||e.gradient,n=t.size,i=t.cellWidth,a=t.level,s=t.ex,f=e.width||1e3,h=Math.abs(f/n[0]*n[1]),u=document.createElement("canvas");u.width=f,u.height=h;var c=u.getContext("2d");c.clearRect(0,0,f,h);for(var p=r.features,g=Math.abs(i/n[0]*f),v=Math.abs(i/n[1]*h),y=0,d=p.length;y<d;y++){var m=p[y].geometry.coordinates,b=(m[0]-s[0][0])/n[0]*f-g/2,M=(m[1]-s[0][1])/n[1]*h-v/2,w=l(a,p[y].properties.val,o);c.strokeStyle=c.fillStyle="rgb("+w.r+","+w.g+","+w.b+")",c.beginPath(),c.fillRect(b-1,M-1,g+2,v+2)}return u}function l(t,r,e){for(var o=!1,n=0,i=t.length;n<i;n++){if(r<t[n].value){if(!o){o=JSON.parse(JSON.stringify(t[n]));break}var a=(r-o.value)/(t[n].value-o.value),l=function(r){return e?parseInt(o[r]+(t[n][r]-o[r])*a):t[n][r]};o.r=l("r"),o.g=l("g"),o.b=l("b");break}o=JSON.parse(JSON.stringify(t[n]))}return o}function s(t,r,e){e=e||{};var o=t.size,n=t.ex,i=e.width||1e3,a=Math.abs(i/o[0]*o[1]),l=e.isolineColor||"#333",s=document.createElement("canvas");s.width=i,s.height=a;var f=s.getContext("2d");f.clearRect(0,0,i,a),f.lineWidth=1,f.font="12px 微软雅黑",f.textBaseline="middle",f.textAlign="center";for(var h=r.features,u={},c=0,p=h.length;c<p;c++){var g=h[c].geometry.coordinates,v="level"==l?h[c].properties.color:l;f.strokeStyle=f.fillStyle=v;for(var y=0,d=g.length;y<d;y++){f.beginPath();for(var m=0,b=0,M=g[y].length;b<M;b++){var w=(g[y][b][0]-n[0][0])/o[0]*i,x=(g[y][b][1]-n[0][1])/o[1]*a;f[b?"lineTo":"moveTo"](w,x);var A=Math.round(w/16)+"-"+Math.round(x/16);u[A]||m||(u[A]=1,m=1,f.fillText(h[c].properties.val,w,x))}f.stroke()}}return s}const f=Object.prototype.toString,h=function(t){return"[object Array]"===f.call(t)};function u(t,r,e){if(!t[0])return!1;var o=(e=e||{}).opacity||1,n=t[0].width,i=t[0].height,a=document.createElement("canvas");a.width=n,a.height=i;var l=a.getContext("2d");l.clearRect(0,0,n,i),l.globalAlpha=o,l.strokeStyle=e.clipColor||"#333",l.lineWidth=e.clipWidth||1;var s=r.clip;if(s&&h(s)){var f=r.ex,u=r.size,c=r.key||{},p=c.clipX||0,g=c.clipY||1;l.beginPath();var v=function(t){if(h(t[0])&&h(t[0][0]))for(var r=0,e=t.length;r<e;r++)v(t[r]);else if(h(t))for(r=0,e=t.length;r<e;r++){var o=(t[r][p]-f[0][0])/u[0]*n,a=(t[r][g]-f[0][1])/u[1]*i;l[r?"lineTo":"moveTo"](o,a)}};v(s),e.clip&&l.stroke(),l.clip()}for(var y=0;t[y];y++){var d=l.createPattern(t[y],"repeat");l.fillStyle=d,l.fillRect(0,0,n,i)}return a}const c=window.turf,p="IsoImage",g="image/png",v=Object.prototype.toString,y=Math.min,d=Math.max,m=Math.abs,b=Math.round,M={x:"x",y:"y",v:"v",clipX:"0",clipY:"1"};function w(t,r){this.name=p,this.initialize(t,r),this.getLegend=function(){return function(t){if(t.legend<2)return!1;var r=document.createElement("canvas");r.width=200,r.height=30;for(var e=r.getContext("2d"),o=e.createLinearGradient(0,0,200,0),n=0,i=t.length;n<i;n++){var a=t[n].color;o.addColorStop(1/i*n,a)}return e.fillStyle=o,e.fillRect(0,0,200,30),r.toDataURL("image/png")}(this.option.level||[])},this.getIsosurface=function(t){return!!this.alow()&&u([a(this.option,this.pointGrid,t)],this.option,t).toDataURL(g)},this.getIsoline=function(t){return!!this.alow()&&u([s(this.option,this.lines,t)],this.option,t).toDataURL(g)},this.getIsoImage=function(t){return!!this.alow()&&u([a(this.option,this.pointGrid,t),s(this.option,this.lines,t)],this.option,t).toDataURL(g)}}return w.prototype={constructor:w,initialize:function(t,r){var e=r.extent,o=r.level;if(!e)return console.log("缺少参数extent(画布左上右下坐标)");if(!o)return console.log("缺少参数level(色阶)");for(var n=[y(e[0][0],e[1][0]),y(e[0][1],e[1][1]),d(e[0][0],e[1][0]),d(e[0][1],e[1][1])],i=[e[1][0]-e[0][0],e[1][1]-e[0][1]],a=r.cellWidth||b(m(i[0])/200*1e6)/1e6,l=Object.assign({},M,r.keyConfig),s=0,f=o.length;s<f;s++){var h=o[s].color;o[s].r=parseInt(h.substr(1,2),16),o[s].g=parseInt(h.substr(3,2),16),o[s].b=parseInt(h.substr(5,2),16)}this.option={type:r.type||"idw",pow:r.pow||3,model:r.model||"spherical",clip:r.clip,smooth:r.smooth,ex:e,extent:n,size:i,cellWidth:a,level:o,key:l};var u=[],p=[],g=[],w=[];if(function(t){return"[object Array]"===v.call(t)}(t))for(s=0,f=t.length;s<f;s++)if(null!=t[s][l.v]){var x=t[s][l.v],A=t[s][l.x],k=t[s][l.y];u.push({x:A,y:k,v:x}),p.push(x),g.push(A),w.push(k)}this.points=u,this._v=p,this._x=g,this._y=w,this.pointGrid=c.pointGrid(n,a,{units:"degrees"}),this.build()},build:function(){this.calcGridValue(),this.calcIsoLines()},calcGridValue:function(){var t=this.option,r=this.pointGrid;switch(t.type){case"kriging":for(var e=i.train(this._v,this._x,this._y,t.model,.1,100),o=0;o<r.features.length;o++)r.features[o].properties.val=i.predict(r.features[o].geometry.coordinates[0],r.features[o].geometry.coordinates[1],e);break;default:var n=this.points;this.pointGrid=function(t,r,e){null==e&&(e=3);var o=r.features;if(t.length<3)return r;for(var n=t.length,i=o.length,a=[],l=0;l<i;l++)for(var s=0;s<n;s++){var f=Math.sqrt(Math.pow(o[l].geometry.coordinates[0]-t[s].x,2)+Math.pow(o[l].geometry.coordinates[1]-t[s].y,2));a.push(f)}for(l=0;l<i;l++){var h=!1;for(s=n*l;s<n*l+n;s++)if(Math.abs(a[s])<1e-4){o[l].properties.val=t[s-n*l].v,h=!0;break}if(!h){var u=0,c=0;for(s=n*l;s<n*l+n;s++)u+=t[s-n*l].v/Math.pow(a[s],e),c+=1/Math.pow(a[s],e);o[l].properties.val=u/c}}return r}(n,r,t.pow)}},calcIsoLines:function(){for(var t=this.option,r=this.pointGrid,e=t.level,o=[],n=0,i=e.length;n<i;n++)o.push(e[n].value);var a=c.isolines(r,o,{zProperty:"val"}),l=a.features;for(n=0,i=l.length;n<i;n++)for(var s=l[n].properties.val,f=0;e[f];f++)if(e[f].value==s){l[n].properties.color=e[f].color;break}if(t.smooth){var h=a.features;for(n=0;n<h.length;n++){for(var u=h[n].geometry.coordinates,p=[],g=0;g<u.length;g++){var v=u[g],y=c.lineString(v),d=c.bezierSpline(y);p.push(d.geometry.coordinates)}h[n].geometry.coordinates=p}}this.lines=a},alow:function(){return this.pointGrid&&this.lines}},w});
