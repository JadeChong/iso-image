!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(r=r||self).IsoImage=t()}(this,function(){"use strict";Object.assign||(Object.assign=function(r){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];for(var o,n=Object(r),i=Object.prototype.hasOwnProperty,a=0,s=t.length;a<s;a++)for(var l in o=Object(t[a]))i.call(o,l)&&(n[l]=o[l]);return n});var r=Math.max,t=Math.min,e=Math.abs,o=Math.floor;function n(r){return r=Number(r),isNaN(r)?0:0===r||r===1/0||r===-1/0?r:(r<0?-1:1)*o(e(r))}Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var r,t;for(r=0,t=0;r<this.length;r++)t+=this[r];return t/this.length},Array.prototype.fill=function(e){var o=arguments[1],i=arguments[2],a=function(r){if(null==r)throw TypeError();return Object(r)}(this),s=function(r){var e=n(r);return e<=0?0:e===1/0?9007199254740991:t(e,9007199254740991)}(a.length);s=r(s,0);var l,f,u,c=n(o);for(l=c<0?r(s+c,0):t(c,s),u=(f=void 0===i?s:n(i))<0?r(s+f,0):t(f,s);l<u;){a[String(l)]=e,l+=1}return a},Array.prototype.rep=function(r){return Array.apply(null,new Array(r)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(r,t){var e,o,n=!1;for(e=0,o=this.length-1;e<this.length;o=e++)this[e][1]>t!=this[o][1]>t&&r<(this[o][0]-this[e][0])*(t-this[e][1])/(this[o][1]-this[e][1])+this[e][0]&&(n=!n);return n};var i=function(){var r={},t=function(r,t){var e,o=new Array(t*t).fill(0);for(e=0;e<t;e++)o[e*t+e]=r;return o},e=function(r,t,e,o){var n,i,a=Array(e*o);for(n=0;n<e;n++)for(i=0;i<o;i++)a[n*o+i]=r[n*o+i]+t[n*o+i];return a},o=function(r,t,e,o,n){var i,a,s,l=Array(e*n);for(i=0;i<e;i++)for(a=0;a<n;a++)for(l[i*n+a]=0,s=0;s<o;s++)l[i*n+a]+=r[i*o+s]*t[s*n+a];return l},n=function(r,t){var e,o,n,i=Array(t);for(e=0;e<t;e++)i[e]=r[e*t+e];for(e=0;e<t;e++){for(o=0;o<e;o++)i[e]-=r[e*t+o]*r[e*t+o];if(i[e]<=0)return!1;for(i[e]=Math.sqrt(i[e]),o=e+1;o<t;o++){for(n=0;n<e;n++)r[o*t+e]-=r[o*t+n]*r[e*t+n];r[o*t+e]/=i[e]}}for(e=0;e<t;e++)r[e*t+e]=i[e];return!0},i=function(r,t){var e,o,n,i;for(e=0;e<t;e++)for(r[e*t+e]=1/r[e*t+e],o=e+1;o<t;o++){for(i=0,n=e;n<o;n++)i-=r[o*t+n]*r[n*t+e];r[o*t+e]=i/r[o*t+o]}for(e=0;e<t;e++)for(o=e+1;o<t;o++)r[e*t+o]=0;for(e=0;e<t;e++){for(r[e*t+e]*=r[e*t+e],n=e+1;n<t;n++)r[e*t+e]+=r[n*t+e]*r[n*t+e];for(o=e+1;o<t;o++)for(n=o;n<t;n++)r[e*t+o]+=r[n*t+e]*r[n*t+o]}for(e=0;e<t;e++)for(o=0;o<e;o++)r[e*t+o]=r[o*t+e]},a=function(r,t){var e,o,n,i,a,s,l,f,u,c,h,p=t,g=Array(t*t),v=Array(t),d=Array(t),y=Array(t);for(e=0;e<t;e++)for(i=0;i<t;i++)g[e*t+i]=e==i?1:0;for(i=0;i<t;i++)y[i]=0;for(e=0;e<t;e++){for(f=0,i=0;i<t;i++)if(1!=y[i])for(a=0;a<t;a++)0==y[a]&&Math.abs(r[i*t+a])>=f&&(f=Math.abs(r[i*t+a]),n=i,o=a);if(++y[o],n!=o){for(s=0;s<t;s++)h=r[n*t+s],r[n*t+s]=r[o*t+s],r[o*t+s]=h;for(s=0;s<p;s++)h=g[n*t+s],g[n*t+s]=g[o*t+s],g[o*t+s]=h}if(d[e]=n,v[e]=o,0==r[o*t+o])return!1;for(c=1/r[o*t+o],r[o*t+o]=1,s=0;s<t;s++)r[o*t+s]*=c;for(s=0;s<p;s++)g[o*t+s]*=c;for(l=0;l<t;l++)if(l!=o){for(u=r[l*t+o],r[l*t+o]=0,s=0;s<t;s++)r[l*t+s]-=r[o*t+s]*u;for(s=0;s<p;s++)g[l*t+s]-=g[o*t+s]*u}}for(s=t-1;s>=0;s--)if(d[s]!=v[s])for(a=0;a<t;a++)h=r[a*t+d[s]],r[a*t+d[s]]=r[a*t+v[s]],r[a*t+v[s]]=h;return!0},s=function(r,t,e,o,n){return t+(o-t)/e*(1-Math.exp(-1/n*Math.pow(r/e,2)))},l=function(r,t,e,o,n){return t+(o-t)/e*(1-Math.exp(-1/n*(r/e)))},f=function(r,t,e,o,n){return r>e?t+(o-t)/e:t+(o-t)/e*(r/e*1.5-.5*Math.pow(r/e,3))};return r.train=function(r,u,c,h,p,g){var v={t:r,x:u,y:c,nugget:0,range:0,sill:0,A:1/3,n:0};switch(h){case"gaussian":v.model=s;break;case"exponential":v.model=l;break;case"spherical":v.model=f}var d,y,w,m,b=r.length,x=Array((b*b-b)/2);for(d=0,w=0;d<b;d++)for(y=0;y<d;y++,w++)x[w]=Array(2),x[w][0]=Math.pow(Math.pow(u[d]-u[y],2)+Math.pow(c[d]-c[y],2),.5),x[w][1]=Math.abs(r[d]-r[y]);x.sort(function(r,t){return r[0]-t[0]}),v.range=x[(b*b-b)/2-1][0];var M=(b*b-b)/2>30?30:(b*b-b)/2,k=v.range/M,E=new Array(M).fill(0),L=new Array(M).fill(0);if(M<30)for(m=0;m<M;m++)E[m]=x[m][0],L[m]=x[m][1];else{for(d=0,y=0,w=0,m=0;d<M&&y<(b*b-b)/2;d++,w=0){for(;x[y][0]<=(d+1)*k&&(E[m]+=x[y][0],L[m]+=x[y][1],w++,!(++y>=(b*b-b)/2)););w>0&&(E[m]/=w,L[m]/=w,m++)}if(m<2)return v}b=m,v.range=E[b-1]-E[0];var A=new Array(2*b).fill(1),C=Array(b),S=v.A;for(d=0;d<b;d++){switch(h){case"gaussian":A[2*d+1]=1-Math.exp(-1/S*Math.pow(E[d]/v.range,2));break;case"exponential":A[2*d+1]=1-Math.exp(-1/S*E[d]/v.range);break;case"spherical":A[2*d+1]=E[d]/v.range*1.5-.5*Math.pow(E[d]/v.range,3)}C[d]=L[d]}var P=function(r,t,e){var o,n,i=Array(e*t);for(o=0;o<t;o++)for(n=0;n<e;n++)i[n*t+o]=r[o*e+n];return i}(A,b,2),O=o(P,A,2,b,2),I=(O=e(O,t(1/g,2),2,2)).slice(0);n(O,2)?i(O,2):(a(I,2),O=I);var j=o(o(O,P,2,2,b),C,2,b,1);v.nugget=j[0],v.sill=j[1]*v.range+v.nugget,v.n=u.length,b=u.length;var _=Array(b*b);for(d=0;d<b;d++){for(y=0;y<d;y++)_[d*b+y]=v.model(Math.pow(Math.pow(u[d]-u[y],2)+Math.pow(c[d]-c[y],2),.5),v.nugget,v.range,v.sill,v.A),_[y*b+d]=_[d*b+y];_[d*b+d]=v.model(0,v.nugget,v.range,v.sill,v.A)}var T=e(_,t(p,b),b,b),q=T.slice(0);n(T,b)?i(T,b):(a(q,b),T=q);_=T.slice(0);var G=o(T,r,b,b,1);return v.K=_,v.M=G,v},r.predict=function(r,t,e){var n,i=Array(e.n);for(n=0;n<e.n;n++)i[n]=e.model(Math.pow(Math.pow(r-e.x[n],2)+Math.pow(t-e.y[n],2),.5),e.nugget,e.range,e.sill,e.A);return o(i,e.M,1,e.n,1)[0]},r}();const a=function(r,t){for(var e=r[0],o=r[1],n=!1,i=0,a=t.length-1;i<t.length;a=i++){var s=t[i][0],l=t[i][1],f=t[a][0],u=t[a][1];l>o!=u>o&&e<(f-s)*(o-l)/(u-l)+s&&(n=!n)}return n},s=function(r){return JSON.parse(JSON.stringify(r))},l=function(r,t){return r[0]==t[0]&&r[1]==t[1]},f=function(r,t){return Math.abs(r-t)},u=Object.prototype.toString,c=function(r){return"[object Array]"===u.call(r)};var h=function(r,t,e,o,n,i,a){a=a||[];for(var f,u,c,p,g=o[o.length-1],v="t"==n||"b"==n?0:1,d="t"==n||"l"==n?1:-1,y=i?-1:1,w=0;e[n][w];w++){var m=e[n][w],b=(m.p[v]-g[v])*d*y;b>0&&(!f||f&&u>b)&&(f=m,u=b)}if(f)l(f.p,o[0])?o.push(f.p):(p=s(r[f.coor].coor),f.d&&p.reverse(),o=o.concat(p)),c=f.t;else if(i)switch(n){case"t":o.push(t.sa),c="l";break;case"r":o.push(t.sb),c="t";break;case"b":o.push(t.sc),c="r";break;case"l":o.push(t.sd),c="b"}else switch(n){case"t":o.push(t.sb),c="r";break;case"r":o.push(t.sc),c="b";break;case"b":o.push(t.sd),c="l";break;case"l":o.push(t.sa),c="t"}return o.length>1&&l(o[0],o[o.length-1])?[o].concat(a):(f&&p&&(a=h(r,t,e,p,c,!i,a)),o=h(r,t,e,o,c,i,a))};const p=function(r,t,e){for(var o=!1,n=0,i=r.length;n<i;n++){if(t<r[n].value){if(!o){o=JSON.parse(JSON.stringify(r[n]));break}var a=(t-o.value)/(r[n].value-o.value),s=function(t){return e?parseInt(o[t]+(r[n][t]-o[t])*a):r[n][t]};o.r=s("r"),o.g=s("g"),o.b=s("b");break}o=JSON.parse(JSON.stringify(r[n]))}return o},g=Math.abs,v=Math.max,d=Math.min,y=Math.floor,w=function(r,t){for(var e=0,o=v(f(t[0],t[2]),f(t[1],t[3])),n=0;n<4;n++){var i=f(t[n],r[n%2]);i<o&&(o=i,e=n)}return"lbrt".charAt(e)};function m(r,t,e,o){for(var n,i=[],f=[],u={t:[],b:[],l:[],r:[]},c=r.features,m=0,b=c.length;m<b;m++)for(var x=c[m],M=0,k=(X=x.geometry.coordinates).length;M<k;M++){var E=X[M],L=E[0],A=E[E.length-1];if(l(L,A))i.push({coor:E,properties:x.properties,child:[],parent:[],i:i.length});else{f.push({coor:E,properties:x.properties});var C=w(L,t),S=w(A,t);u[C].push({p:L,end:A,d:0,t:S,coor:f.length-1}),u[S].push({p:A,end:L,d:1,t:C,coor:f.length-1})}}for(var P={sa:[t[0],t[3]],sb:[t[2],t[3]],sc:[t[2],t[1]],sd:[t[0],t[1]]},O=(m=0,(n=h(f,P,u,[P.sa],"t",!1)).length);m<O;m++)i.push({coor:n[m],properties:{type:"open"},child:[],parent:[],i:i.length});for(m=0,b=i.length;m<b;m++)for(var I=m+1;I<b;I++){var j=i[m].properties.type,_=i[I].properties.type;"open"!=j&&a(i[m].coor[0],i[I].coor)?(i[I].child.push(m),i[m].parent.push(I)):"open"!=_&&a(i[I].coor[0],i[m].coor)&&(i[m].child.push(I),i[I].parent.push(m))}var T=s(i),q=[],G=[],N=[],R=function(){if(T.length){for(var r=[],t=0,e=T.length;t<e;t++){for(var o=T[t],n=o.child,i=1,a=n.length-1;a>-1;a--)-1==G.indexOf(n[a])&&(i=0);if(i){var s=[];for(a=n.length-1;a>-1;a--){var l=N.indexOf(n[a]);l>-1&&(s.push(n[a]),N.splice(l,1))}N.push(o.i),G.push(o.i),T[t].child=s,q.push(T[t])}else r.push(T[t])}r.length&&(T=r,R())}};R();var F=[],W=e.features,z=W.length,B=W[0].geometry.coordinates,D=1,J=1,U=1;for(m=0;m<z;m++){var V=W[m].geometry.coordinates;if(1==m&&(U=g(V[1]-B[1])),V[0]!=B[0]){D=m,J=g(V[0]-B[0]);break}}for(m=0,b=q.length;m<b;m++){for(var X,Y=[(X=q[m]).coor],K="rgba(0, 0, 0, 0)",H=(I=0,X.child.length);I<H;I++)Y.push(i[X.child[I]].coor);var Q,Z=y(X.coor.length/2),$=X.coor[Z],rr=($[0]-B[0])/J,tr=v(y(rr)*D+y(($[1]-B[1])/U),0),er=rr%1?0:1,or=er?1:D,nr=er?U:J,ir=nr/100;if(W[tr]&&W[tr+or]){var ar=W[tr].geometry.coordinates,sr=W[tr+or].geometry.coordinates,lr=Object.assign([],$,[]);lr[er]=v($[er]-ir,ar[er]);var fr=W[tr].properties.val,ur=W[tr+or].properties.val;a(lr,X.coor)||(lr[er]=d($[er]+2*ir,sr[er])),a(lr,X.coor)&&(Q=fr+(ur-fr)*(g(lr[er]-W[tr].geometry.coordinates[er])/nr))}else W[tr]&&(Q=W[tr].properties.val);if(null!=Q){var cr=p(o,Q,!1);K="rgb("+cr.r+","+cr.g+","+cr.b+")",Q=cr.value}F.push({geometry:{coordinates:Y,type:"MultiLineString"},properties:{val:Q,color:K},type:"Feature"})}return{features:F,type:"FeatureCollection"}}var b={direction:"vertical",backgroundColor:"#fff",color:"#333",gradient:!0};function x(r,t){if(r.legend<2)return!1;var e=(t=Object.assign({},b,t)).gradient?1:0,o="horizontal"==t.direction?0:1,n=t.title||"",i=t.shape||"rect",a=document.createElement("canvas"),s=o?120:340;e||(s+=20);var l=o?240:50;a.width=s,a.height=l;var f=o?[15,30,20,200]:[70,5,200,20],u=o?[f[0],f[1]+f[3],f[0],f[1]]:[f[0],f[1],f[0]+f[2],f[1]],c=a.getContext("2d");c.lineWidth=1,c.strokeStyle="#999",c.fillStyle=t.backgroundColor,c.fillRect(0,0,s,l),c.font="12px 微软雅黑",c.textBaseline="middle",c.textAlign="start",c.fillStyle=t.color;for(var h=c.createLinearGradient(u[0],u[1],u[2],u[3]),p=0,g=r.length;p<g;p++){var v=r[p].color,d=r[p].unit||"",y=r[p].value+d,w=1/(g-1)*p;if(!e&&p>0&&p<g-1){var m=r[p-1].color;h.addColorStop(w,m),h.addColorStop(w,v)}else h.addColorStop(w,v);if(o)c.fillText(y,f[0]+f[2]+5,f[1]+f[3]*(1-w));else if(!p||p==g-1){var x=c.measureText(y).width,M=f[1]+f[3]/2,k=p?f[0]+f[2]+5:f[0]-5-x;c.fillText(y,k,M)}}switch(c.fillStyle=h,i){case"triangle-rect":if(o){var E=f[2]/2;c.beginPath(),c.moveTo(f[0]+E,f[1]),c.lineTo(f[0]+f[2],f[1]+E),c.lineTo(f[0]+f[2],f[1]+f[3]-E),c.lineTo(f[0]+E,f[1]+f[3]),c.lineTo(f[0],f[1]+f[3]-E),c.lineTo(f[0],f[1]+E),c.lineTo(f[0]+E,f[1]),c.stroke(),c.fill()}else{E=f[3]/2;c.beginPath(),c.moveTo(f[0],f[1]+E),c.lineTo(f[0]+E,f[1]),c.lineTo(f[0]+f[2]-E,f[1]),c.lineTo(f[0]+f[2],f[1]+E),c.lineTo(f[0]+f[2]-E,f[1]+f[3]),c.lineTo(f[0]+E,f[1]+f[3]),c.lineTo(f[0],f[1]+E),c.stroke(),c.fill()}break;default:c.fillRect(f[0],f[1],f[2],f[3])}return n.length&&(c.font="14px 微软雅黑",c.fillStyle=t.color,c.textBaseline="top",o?(c.textAlign="start",c.fillText(n,5,5)):(c.textAlign="center",c.fillText(n,s/2,f[1]+f[3]+5))),a}function M(r,t,e,o){var n=null==(o=o||{}).gradient||o.gradient,i=r.size,a=r.cellWidth,s=r.level,l=r.ex,f=o.filter,u=o.width||1e3,c=Math.abs(u/i[0]*i[1]),h=document.createElement("canvas");h.width=u,h.height=c;var g=h.getContext("2d");if(g.clearRect(0,0,u,c),n)for(var v=t.features,d=Math.abs(a/i[0]*u),y=Math.abs(a/i[1]*c),w=0,m=v.length;w<m;w++){var b=v[w].geometry.coordinates,x=(b[0]-l[0][0])/i[0]*u-d/2,M=(b[1]-l[0][1])/i[1]*c-y/2,k=p(s,v[w].properties.val,n),E=k.value;f&&f.indexOf&&-1==f.indexOf(E)||(g.strokeStyle=g.fillStyle="rgb("+k.r+","+k.g+","+k.b+")",g.beginPath(),g.fillRect(x-1,M-1,d+2,y+2))}else{var L=e.features;for(w=0,m=L.length;w<m;w++){E=L[w].properties.val;if(!f||!f.indexOf||-1!=f.indexOf(E)){var A=L[w].geometry.coordinates;g.strokeStyle=g.fillStyle=L[w].properties.color,g.beginPath();for(var C=0,S=A.length;C<S;C++)for(var P=0,O=A[C].length;P<O;P++){x=(A[C][P][0]-l[0][0])/i[0]*u,M=(A[C][P][1]-l[0][1])/i[1]*c;g[P?"lineTo":"moveTo"](x,M)}g.fill("evenodd")}}}return h}function k(r,t,e){e=e||{};var o=r.size,n=r.ex,i=e.width||1e3,a=Math.abs(i/o[0]*o[1]),s=e.isolineColor||"#333",l=e.filter,f=document.createElement("canvas");f.width=i,f.height=a;var u=f.getContext("2d");u.clearRect(0,0,i,a),u.lineWidth=1,u.font="12px 微软雅黑",u.textBaseline="middle",u.textAlign="center";for(var c=t.features,h={},p=0,g=c.length;p<g;p++){var v=c[p].properties.val;if(!l||!l.indexOf||-1!=l.indexOf(v)){var d=c[p].geometry.coordinates,y="level"==s?c[p].properties.color:s;u.strokeStyle=u.fillStyle=y;for(var w=0,m=d.length;w<m;w++){u.beginPath();for(var b=0,x=0,M=d[w].length;x<M;x++){var k=(d[w][x][0]-n[0][0])/o[0]*i,E=(d[w][x][1]-n[0][1])/o[1]*a;u[x?"lineTo":"moveTo"](k,E);var L=Math.round(k/16)+"-"+Math.round(E/16);h[L]||b||(h[L]=1,b=1,u.fillText(v,k,E))}u.stroke()}}}return f}function E(r,t,e){if(!r[0])return!1;var o=(e=e||{}).opacity||1,n=r[0].width,i=r[0].height,a=document.createElement("canvas");a.width=n,a.height=i;var s=a.getContext("2d");s.clearRect(0,0,n,i),s.globalAlpha=o,s.strokeStyle=e.clipColor||"#333",s.lineWidth=e.clipWidth||1;var l=t.clip;if(l&&c(l)){var f=t.ex,u=t.size,h=t.key||{},p=h.clipX||0,g=h.clipY||1;s.beginPath();var v=function(r){if(c(r[0])&&c(r[0][0]))for(var t=0,e=r.length;t<e;t++)v(r[t]);else if(c(r))for(t=0,e=r.length;t<e;t++){var o=(r[t][p]-f[0][0])/u[0]*n,a=(r[t][g]-f[0][1])/u[1]*i;s[t?"lineTo":"moveTo"](o,a)}};v(l),e.clip&&s.stroke(),s.clip()}for(var d=0;r[d];d++){var y=s.createPattern(r[d],"no-repeat");s.fillStyle=y,s.fillRect(0,0,n,i)}return a}const A=function(r,t,e,o){if(void 0===o&&(o=1),void 0===e&&(e=0),!t)return[r[o],r[e]];t--;for(var n=0,i=r.length;n<i;n++)r[n]=A(r[n],t);return r},C=function(r){for(var t=s(r),e=0,o=t.features.length;e<o;e++){var n=t.features[e].geometry.coordinates;t.features[e].geometry.coordinates=A(n,2)}return t},S=function(r){return L.IsoImageCanvasLayer||(L.IsoImageCanvasLayer=L.Canvas.extend({_initContainer:function(){var r=this._container=document.createElement("canvas");this._container.style.opacity=0,L.DomEvent.on(r,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this),L.DomEvent.on(r,"click dblclick mousedown mouseup contextmenu",this._onClick,this),L.DomEvent.on(r,"mouseout",this._handleMouseOut,this),this._ctx=r.getContext("2d")},_draw:function(){var r,t=this._redrawBounds,e=this._ctx;if(e.save(),t){var o=t.getSize();e.beginPath(),e.rect(t.min.x,t.min.y,o.x,o.y),e.clip()}this._drawing=!0;for(var n=this._drawFirst;n;n=n.next)r=n.layer,(!t||r._pxBounds&&r._pxBounds.intersects(t))&&r._updatePath();this._drawing=!1,e.restore(),this.options.clipLayer&&this.options.clipLayer._clip(e)}})),new L.IsoImageCanvasLayer(r)},P=function(r){return L.ClipCanvasLayer||(L.ClipCanvasLayer=L.Canvas.extend({_initContainer:function(){var r=this._container=document.createElement("canvas");L.DomEvent.on(r,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this),L.DomEvent.on(r,"click dblclick mousedown mouseup contextmenu",this._onClick,this),L.DomEvent.on(r,"mouseout",this._handleMouseOut,this),this._ctx=r.getContext("2d")},_clip:function(r){var t=this._ctx;t.fillStyle=t.createPattern(r.canvas,"no-repeat"),t.beginPath();for(var e=this._drawFirst;e;e=e.next)for(var o=e.layer._parts,n=0,i=o.length;n<i;n++)for(var a=0,s=o[n].length;a<s;a++)t[a?"lineTo":"moveTo"](o[n][a].x,o[n][a].y);t.save(),t.translate(this._bounds.min.x,this._bounds.min.y),t.fill(),t.restore()}})),new L.ClipCanvasLayer(r)};function O(r,t,e,o){if(r&&e){for(var n=[],i=o.filter,a=0;r.features[a];a++){var s=r.features[a],l=s.properties.val;if(!(i&&i.indexOf&&-1==i.indexOf(l)||!s.geometry.coordinates.length)){var f=Object.assign({},{stroke:!0,weight:1,opacity:.7,fillOpacity:.7,color:s.properties.color,fillColor:s.properties.color,renderer:e},o),u=L[t](s.geometry.coordinates,f);n.push(u)}}return n}}var I={meters:6371008.8,metres:6371008.8,millimeters:6371008800,millimetres:6371008800,centimeters:637100880,centimetres:637100880,kilometers:6371.0088,kilometres:6371.0088,miles:3958.761333810546,nauticalmiles:6371008.8/1852,inches:6371008.8*39.37,yards:6371008.8/1.0936,feet:20902260.511392,radians:1,degrees:6371008.8/111325};function j(r,t,e){if(!R(e=e||{}))throw new Error("options is invalid");var o=e.bbox,n=e.id;if(void 0===r)throw new Error("geometry is required");if(t&&t.constructor!==Object)throw new Error("properties must be an Object");o&&F(o),n&&W(n);var i={type:"Feature"};return n&&(i.id=n),o&&(i.bbox=o),i.properties=t||{},i.geometry=r,i}function _(r,t,e){if(!r)throw new Error("coordinates is required");if(!Array.isArray(r))throw new Error("coordinates must be an Array");if(r.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!N(r[0])||!N(r[1]))throw new Error("coordinates must contain numbers");return j({type:"Point",coordinates:r},t,e)}function T(r,t){if(!R(t=t||{}))throw new Error("options is invalid");var e=t.bbox,o=t.id;if(!r)throw new Error("No features passed");if(!Array.isArray(r))throw new Error("features must be an Array");e&&F(e),o&&W(o);var n={type:"FeatureCollection"};return o&&(n.id=o),e&&(n.bbox=e),n.features=r,n}function q(r,t,e){if(!r)throw new Error("coordinates is required");return j({type:"MultiLineString",coordinates:r},t,e)}function G(r){if(null==r)throw new Error("degrees is required");return r%360*Math.PI/180}function N(r){return!isNaN(r)&&null!==r&&!Array.isArray(r)}function R(r){return!!r&&r.constructor===Object}function F(r){if(!r)throw new Error("bbox is required");if(!Array.isArray(r))throw new Error("bbox must be an Array");if(4!==r.length&&6!==r.length)throw new Error("bbox must be an Array of 4 or 6 numbers");r.forEach(function(r){if(!N(r))throw new Error("bbox must only contain numbers")})}function W(r){if(!r)throw new Error("id is required");if(-1===["string","number"].indexOf(typeof r))throw new Error("id must be a number or a string")}function z(r,t,e){if(null!==r)for(var o,n,i,a,s,l,f,u,c=0,h=0,p=r.type,g="FeatureCollection"===p,v="Feature"===p,d=g?r.features.length:1,y=0;y<d;y++){s=(u=!!(f=g?r.features[y].geometry:v?r.geometry:r)&&"GeometryCollection"===f.type)?f.geometries.length:1;for(var w=0;w<s;w++){var m=0,b=0;if(null!==(a=u?f.geometries[w]:f)){l=a.coordinates;var x=a.type;switch(c=!e||"Polygon"!==x&&"MultiPolygon"!==x?0:1,x){case null:break;case"Point":t(l,h,y,m,b),h++,m++;break;case"LineString":case"MultiPoint":for(o=0;o<l.length;o++)t(l[o],h,y,m,b),h++,"MultiPoint"===x&&m++;"LineString"===x&&m++;break;case"Polygon":case"MultiLineString":for(o=0;o<l.length;o++){for(n=0;n<l[o].length-c;n++)t(l[o][n],h,y,m,b),h++;"MultiLineString"===x&&m++,"Polygon"===x&&b++}"Polygon"===x&&m++;break;case"MultiPolygon":for(o=0;o<l.length;o++){for("MultiPolygon"===x&&(b=0),n=0;n<l[o].length;n++){for(i=0;i<l[o][n].length-c;i++)t(l[o][n][i],h,y,m,b),h++;b++}m++}break;case"GeometryCollection":for(o=0;o<a.geometries.length;o++)z(a.geometries[o],t,e);break;default:throw new Error("Unknown Geometry Type")}}}}}function B(r){var t=[1/0,1/0,-1/0,-1/0];return z(r,function(r){t[0]>r[0]&&(t[0]=r[0]),t[1]>r[1]&&(t[1]=r[1]),t[2]<r[0]&&(t[2]=r[0]),t[3]<r[1]&&(t[3]=r[1])}),t}function D(r){if(!r)throw new Error("obj is required");var t=J(r);if(t.length>1&&N(t[0])&&N(t[1]))return t;throw new Error("Coordinate is not a valid Point")}function J(r){if(!r)throw new Error("obj is required");var t;if(r.length?t=r:r.coordinates?t=r.coordinates:r.geometry&&r.geometry.coordinates&&(t=r.geometry.coordinates),t)return function r(t){if(t.length>1&&N(t[0])&&N(t[1]))return!0;if(Array.isArray(t[0])&&t[0].length)return r(t[0]);throw new Error("coordinates must only contain numbers")}(t),t;throw new Error("No valid coordinates")}function U(r,t,e){if(!r)throw new Error("No featureCollection passed");if(!e)throw new Error(".collectionOf() requires a name");if(!r||"FeatureCollection"!==r.type)throw new Error("Invalid input to "+e+", FeatureCollection required");for(var o=0;o<r.features.length;o++){var n=r.features[o];if(!n||"Feature"!==n.type||!n.geometry)throw new Error("Invalid input to "+e+", Feature with geometry required");if(!n.geometry||n.geometry.type!==t)throw new Error("Invalid input to "+e+": must be a "+t+", given "+n.geometry.type)}}function V(r){if(!r)throw new Error("geojson is required");if(void 0!==r.geometry)return r.geometry;if(r.coordinates||r.geometries)return r;throw new Error("geojson must be a valid Feature or Geometry Object")}function X(r,t){if(!r)throw new Error((t||"geojson")+" is required");if(r.geometry&&r.geometry.type)return r.geometry.type;if(r.type)return r.type;throw new Error((t||"geojson")+" is invalid")}function Y(r,t,e){var o=(e=e||{}).ignoreEndVertices;if(!R(e))throw new Error("invalid options");if(!r)throw new Error("pt is required");if(!t)throw new Error("line is required");for(var n=D(r),i=J(t),a=0;a<i.length-1;a++){var s=!1;if(o&&(0===a&&(s="start"),a===i.length-2&&(s="end"),0===a&&a+1===i.length-1&&(s="both")),K(i[a],i[a+1],n,s))return!0}return!1}function K(r,t,e,o){var n=e[0],i=e[1],a=r[0],s=r[1],l=t[0],f=t[1],u=l-a,c=f-s;return 0==(e[0]-a)*c-(e[1]-s)*u&&(o?"start"===o?Math.abs(u)>=Math.abs(c)?u>0?a<n&&n<=l:l<=n&&n<a:c>0?s<i&&i<=f:f<=i&&i<s:"end"===o?Math.abs(u)>=Math.abs(c)?u>0?a<=n&&n<l:l<n&&n<=a:c>0?s<=i&&i<f:f<i&&i<=s:"both"===o?Math.abs(u)>=Math.abs(c)?u>0?a<n&&n<l:l<n&&n<a:c>0?s<i&&i<f:f<i&&i<s:void 0:Math.abs(u)>=Math.abs(c)?u>0?a<=n&&n<=l:l<=n&&n<=a:c>0?s<=i&&i<=f:f<=i&&i<=s)}function H(r,t,e){if("object"!=typeof(e=e||{}))throw new Error("options is invalid");var o=e.ignoreBoundary;if(!r)throw new Error("point is required");if(!t)throw new Error("polygon is required");var n=D(r),i=J(t),a=t.geometry?t.geometry.type:t.type,s=t.bbox;if(s&&!1===function(r,t){return t[0]<=r[0]&&t[1]<=r[1]&&t[2]>=r[0]&&t[3]>=r[1]}(n,s))return!1;"Polygon"===a&&(i=[i]);for(var l=0,f=!1;l<i.length&&!f;l++)if(Q(n,i[l][0],o)){for(var u=!1,c=1;c<i[l].length&&!u;)Q(n,i[l][c],!o)&&(u=!0),c++;u||(f=!0)}return f}function Q(r,t,e){var o=!1;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]&&(t=t.slice(0,t.length-1));for(var n=0,i=t.length-1;n<t.length;i=n++){var a=t[n][0],s=t[n][1],l=t[i][0],f=t[i][1];if(r[1]*(a-l)+s*(l-r[0])+f*(r[0]-a)==0&&(a-r[0])*(l-r[0])<=0&&(s-r[1])*(f-r[1])<=0)return!e;s>r[1]!=f>r[1]&&r[0]<(l-a)*(r[1]-s)/(f-s)+a&&(o=!o)}return o}function Z(r,t){var e=X(r),o=X(t),n=V(r),i=V(t);switch(e){case"Point":switch(o){case"MultiPoint":return function(r,t){var e,o=!1;for(e=0;e<t.coordinates.length;e++)if(rr(t.coordinates[e],r.coordinates)){o=!0;break}return o}(n,i);case"LineString":return Y(n,i,{ignoreEndVertices:!0});case"Polygon":return H(n,i,{ignoreBoundary:!0});default:throw new Error("feature2 "+o+" geometry not supported")}case"MultiPoint":switch(o){case"MultiPoint":return function(r,t){for(var e=0;e<r.coordinates.length;e++){for(var o=!1,n=0;n<t.coordinates.length;n++)rr(r.coordinates[e],t.coordinates[n])&&(o=!0);if(!o)return!1}return!0}(n,i);case"LineString":return function(r,t){for(var e=!1,o=0;o<r.coordinates.length;o++){if(!Y(r.coordinates[o],t))return!1;e||(e=Y(r.coordinates[o],t,{ignoreEndVertices:!0}))}return e}(n,i);case"Polygon":return function(r,t){for(var e=!0,o=0;o<r.coordinates.length;o++){var n=H(r.coordinates[1],t);if(!n){e=!1;break}n=H(r.coordinates[1],t,{ignoreBoundary:!0})}return e&&n}(n,i);default:throw new Error("feature2 "+o+" geometry not supported")}case"LineString":switch(o){case"LineString":return function(r,t){for(var e=0;e<r.coordinates.length;e++)if(!Y(r.coordinates[e],t))return!1;return!0}(n,i);case"Polygon":return function(r,t){var e=B(t),o=B(r);if(!$(e,o))return!1;for(var n=!1,i=0;i<r.coordinates.length-1;i++){if(!H(r.coordinates[i],t))return!1;if(n||(n=H(r.coordinates[i],t,{ignoreBoundary:!0})),!n){var a=(s=r.coordinates[i],l=r.coordinates[i+1],[(s[0]+l[0])/2,(s[1]+l[1])/2]);n=H(a,t,{ignoreBoundary:!0})}}var s,l;return n}(n,i);default:throw new Error("feature2 "+o+" geometry not supported")}case"Polygon":switch(o){case"Polygon":return function(r,t){var e=B(r);if(!$(B(t),e))return!1;for(var o=0;o<r.coordinates[0].length;o++)if(!H(r.coordinates[0][o],t))return!1;return!0}(n,i);default:throw new Error("feature2 "+o+" geometry not supported")}default:throw new Error("feature1 "+e+" geometry not supported")}}function $(r,t){return!(r[0]>t[0])&&(!(r[2]<t[2])&&(!(r[1]>t[1])&&!(r[3]<t[3])))}function rr(r,t){return r[0]===t[0]&&r[1]===t[1]}function tr(r,t,e){if(!R(e=e||{}))throw new Error("options is invalid");var o=e.units,n=D(r),i=D(t),a=G(i[1]-n[1]),s=G(i[0]-n[0]),l=G(n[1]),f=G(i[1]),u=Math.pow(Math.sin(a/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(l)*Math.cos(f);return function(r,t){if(null==r)throw new Error("radians is required");if(t&&"string"!=typeof t)throw new Error("units must be a string");var e=I[t||"kilometers"];if(!e)throw new Error(t+" units is invalid");return r*e}(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),o)}var er={successCallback:null,verbose:!1},or={};function nr(r,t,e){e=e||{};for(var o=Object.keys(er),n=0;n<o.length;n++){var i=o[n],a=e[i];a=null!=a?a:er[i],or[i]=a}or.verbose&&console.log("MarchingSquaresJS-isoContours: computing isocontour for "+t);var s=function(r){var t=[],e=0;r.rows,r.cols;return r.cells.forEach(function(o,n){o.forEach(function(o,i){if(void 0!==o&&5!==(h=o).cval&&10!==h.cval&&!ar(o)){var a=function(r,t,e){var o,n,i,a=r.length,s=[],l=[0,0,1,1,0,0,0,0,-1,0,1,1,-1,0,-1,0],f=[0,-1,0,0,1,1,1,1,0,-1,0,0,0,-1,0,0],u=["none","bottom","right","right","top","top","top","top","left","bottom","right","right","left","bottom","left","none"],c=(r[t][e],r[t][e]),h=c.cval,p=lr(c,i=["none","left","bottom","left","right","none","bottom","left","top","top","none","top","right","right","bottom","none"][h]);s.push([e+p[0],t+p[1]]),p=lr(c,i=u[h]),s.push([e+p[0],t+p[1]]),sr(c);for(var g=e+l[h],v=t+f[h],d=h;g>=0&&v>=0&&v<a&&(g!=e||v!=t)&&void 0!==(c=r[v][g]);){if(0===(h=c.cval)||15===h)return{path:s,info:"mergeable"};i=u[h],o=l[h],n=f[h],5!==h&&10!==h||(5===h?c.flipped?-1===f[d]?(i="left",o=-1,n=0):(i="right",o=1,n=0):-1===l[d]&&(i="bottom",o=0,n=-1):10===h&&(c.flipped?-1===l[d]?(i="top",o=0,n=1):(i="bottom",o=0,n=-1):1===f[d]&&(i="left",o=-1,n=0))),p=lr(c,i),s.push([g+p[0],v+p[1]]),sr(c),g+=o,v+=n,d=h}return{path:s,info:"closed"}}(r.cells,n,i),s=!1;if("mergeable"===a.info)for(var l=a.path[a.path.length-1][0],f=a.path[a.path.length-1][1],u=e-1;u>=0;u--)if(Math.abs(t[u][0][0]-l)<=1e-7&&Math.abs(t[u][0][1]-f)<=1e-7){for(var c=a.path.length-2;c>=0;--c)t[u].unshift(a.path[c]);s=!0;break}s||(t[e++]=a.path)}var h})}),t}(function(r,t){for(var e=r.length-1,o=r[0].length-1,n={rows:e,cols:o,cells:[]},i=0;i<e;++i){n.cells[i]=[];for(var a=0;a<o;++a){var s=0,l=r[i+1][a],f=r[i+1][a+1],u=r[i][a+1],c=r[i][a];if(!(isNaN(l)||isNaN(f)||isNaN(u)||isNaN(c))){s|=l>=t?8:0,s|=f>=t?4:0,s|=u>=t?2:0;var h,p,g,v,d=!1;if(5===(s|=c>=t?1:0)||10===s){var y=(l+f+u+c)/4;5===s&&y<t?(s=10,d=!0):10===s&&y<t&&(s=5,d=!0)}if(0!==s&&15!==s)h=p=g=v=.5,1===s?(g=1-ir(t,l,c),p=1-ir(t,u,c)):2===s?(p=ir(t,c,u),v=1-ir(t,f,u)):3===s?(g=1-ir(t,l,c),v=1-ir(t,f,u)):4===s?(h=ir(t,l,f),v=ir(t,u,f)):5===s?(h=ir(t,l,f),v=ir(t,u,f),p=1-ir(t,u,c),g=1-ir(t,l,c)):6===s?(p=ir(t,c,u),h=ir(t,l,f)):7===s?(g=1-ir(t,l,c),h=ir(t,l,f)):8===s?(g=ir(t,c,l),h=1-ir(t,f,l)):9===s?(p=1-ir(t,u,c),h=1-ir(t,f,l)):10===s?(h=1-ir(t,f,l),v=1-ir(t,f,u),p=ir(t,c,u),g=ir(t,c,l)):11===s?(h=1-ir(t,f,l),v=1-ir(t,f,u)):12===s?(g=ir(t,c,l),v=ir(t,u,f)):13===s?(p=1-ir(t,u,c),v=ir(t,u,f)):14===s?(g=ir(t,c,l),p=ir(t,c,u)):console.log("MarchingSquaresJS-isoContours: Illegal cval detected: "+s),n.cells[i][a]={cval:s,flipped:d,top:h,right:v,bottom:p,left:g}}}}return n}(r,t));return"function"==typeof or.successCallback&&or.successCallback(s),s}function ir(r,t,e){return(r-t)/(e-t)}function ar(r){return 0===r.cval||15===r.cval}function sr(r){ar(r)||5===r.cval||10===r.cval||(r.cval=15)}function lr(r,t){return"top"===t?[r.top,1]:"bottom"===t?[r.bottom,0]:"right"===t?[1,r.right]:"left"===t?[0,r.left]:void 0}function fr(r,t){if(!R(t=t||{}))throw new Error("options is invalid");var e=t.zProperty||"elevation",o=t.flip,n=t.flags;U(r,"Point","input must contain Points");for(var i=function(r,t){var e={};return function(r,t){if("Feature"===r.type)t(r,0);else if("FeatureCollection"===r.type)for(var e=0;e<r.features.length;e++)t(r.features[e],e)}(r,function(r){var t=J(r)[1];e[t]||(e[t]=[]),e[t].push(r)}),Object.keys(e).map(function(r){return e[r].sort(function(r,t){return J(r)[0]-J(t)[0]})}).sort(function(r,e){return t?J(r[0])[1]-J(e[0])[1]:J(e[0])[1]-J(r[0])[1]})}(r,o),a=[],s=0;s<i.length;s++){for(var l=i[s],f=[],u=0;u<l.length;u++){var c=l[u];c.properties[e]?f.push(c.properties[e]):f.push(0),!0===n&&(c.properties.matrixPosition=[s,u])}a.push(f)}return a}function ur(r,t,e){if(!R(e=e||{}))throw new Error("options is invalid");var o=e.zProperty||"elevation",n=e.commonProperties||{},i=e.breaksProperties||[];if(U(r,"Point","Input must contain Points"),!t)throw new Error("breaks is required");if(!Array.isArray(t))throw new Error("breaks must be an Array");if(!R(n))throw new Error("commonProperties must be an Object");if(!Array.isArray(i))throw new Error("breaksProperties must be an Array");var a=fr(r,{zProperty:o,flip:!0});return T(function(r,t,e){var o=B(e),n=o[2]-o[0],i=o[3]-o[1],a=o[0],s=o[1],l=t[0].length-1,f=t.length-1,u=n/l,c=i/f,h=function(r){r[0]=r[0]*u+a,r[1]=r[1]*c+s};return r.forEach(function(r){z(r,h)}),r}(function(r,t,e,o,n){for(var i=[],a=1;a<t.length;a++){var s=+t[a],l=Object.assign({},o,n[a]);l[e]=s;var f=q(nr(r,s),l);i.push(f)}return i}(a,t,o,n,i),a,r))}const cr="IsoImage",hr="image/png",pr=Object.prototype.toString,gr="ActiveXObject"in window,vr=Math.min,dr=Math.max,yr=Math.abs,wr=Math.round,mr={x:"x",y:"y",v:"v",clipX:"0",clipY:"1"},br=function(){var r="L"in window;return r||console.log("未加载leaflet"),r};function xr(r,t,e){this.name=cr,this.initialize(r,t,e),this.getIsosurface=function(r,t){if(!this.alow())return!1;var e=E([M(this.option,this.pointGrid,this.isosurface,r)],this.option,r);return t?e:e.toDataURL(hr)},this.getIsoline=function(r,t){if(!this.alow())return!1;var e=E([k(this.option,this.isoline,r)],this.option,r);return t?e:e.toDataURL(hr)},this.getIsoImage=function(r,t){if(!this.alow())return!1;var e=E([M(this.option,this.pointGrid,this.isosurface,r),k(this.option,this.isoline,r)],this.option,r);return t?e:e.toDataURL(hr)},this.getLegend=function(r,t){var e=x(this.option.level||[],r);return!!e&&(t?e:e.toDataURL("image/png"))},this.layer=function(r,t){if(br()){t=Object.assign({},{padding:.5,opacity:.1},t);var e=P(t),o={stroke:!0,weight:1,opacity:.7,fillOpacity:0,color:"#ff0000",fillColor:"#ff0000",renderer:e};return L.polygon(this.option.fmtClip,o).addTo(r),t.clipLayer=e,S(t)}},this.getLeafletIsosurface=function(r,t){if(br()){var e=O(this.fmtLatlngsIsosurface,"polygon",r,t);return L.featureGroup(e)}},this.getLeafletIsoline=function(r,t){if(br()){var e=O(this.fmtLatlngsIsoline,"polyline",r,t);return L.featureGroup(e)}},this.getLeafletIsoImage=function(r,t){if(br()){var e=this.fmtLatlngsIsosurface,o=this.fmtLatlngsIsoline,n=O(e,"polygon",r,t),i=O(o,"polyline",r,t),a=n.concat(i);return L.featureGroup(a)}},this.getLeafletLegend=function(r){if(br()){r=Object.assign({},{position:"bottomleft",gradient:!0},r);var t=x(this.option.level||[],r);return!!t&&(r.canvas=t,function(r){return L.Control.IsoLegendCortrol||(L.Control.IsoLegendCortrol=L.Control.extend({options:{position:"bottomleft",canvas:""},initialize:function(r){L.Util.extend(this.options,r)},onAdd:function(){return this._container=L.DomUtil.create("div","leaflet-control-iso-legend"),this._container.appendChild(this.options.canvas),this._container}})),new L.Control.IsoLegendCortrol(r)}(r))}}}return xr.prototype={constructor:xr,initialize:function(r,t,e){var o=t.extent,n=t.level;if(!o)return console.log("缺少参数extent(画布左上右下坐标)");if(!n)return console.log("缺少参数level(色阶)");n=function(r){for(var t=0,e=r.length;t<e;t++){var o=r[t].color;r[t].r=parseInt(o.substr(1,2),16),r[t].g=parseInt(o.substr(3,2),16),r[t].b=parseInt(o.substr(5,2),16)}return r}(n);var i=[vr(o[0][0],o[1][0]),vr(o[0][1],o[1][1]),dr(o[0][0],o[1][0]),dr(o[0][1],o[1][1])],a=[o[1][0]-o[0][0],o[1][1]-o[0][1]],s=t.cellWidth||wr(yr(a[0])/200*1e6)/1e6;gr&&(s*=3);var l=Object.assign({},mr,t.keyConfig);this.option={worker:t.worker,type:t.type||"idw",pow:t.pow||3,model:t.model||"spherical",clip:t.clip,fmtClip:A(JSON.parse(JSON.stringify(t.clip)),2,l.clipX,l.clipY),smooth:t.smooth,ex:o,extent:i,size:a,cellWidth:s,level:n,key:l};var f=[],u=[],c=[],h=[];if(function(r){return"[object Array]"===pr.call(r)}(r))for(var p=0,g=r.length;p<g;p++)if(null!=r[p][l.v]){var v=r[p][l.v],d=r[p][l.x],y=r[p][l.y];f.push({x:d,y:y,v:v}),u.push(v),c.push(d),h.push(y)}this.points=f,this._v=u,this._x=c,this._y=h;var w=this;if(t.worker&&window.Worker&&!gr){var m=new Worker(t.worker+"/turf.js");return m.onmessage=function(r){w.pointGrid=r.data,w.calcGridValue(),e&&w.initReady(e)},void m.postMessage(["pointGrid",i,s,{units:"degrees"}])}this.pointGrid=function(r,t,e){if(!R(e=e||{}))throw new Error("options is invalid");var o=e.mask,n=e.properties,i=[];if(null==t)throw new Error("cellSide is required");if(!N(t))throw new Error("cellSide is invalid");if(!r)throw new Error("bbox is required");if(!Array.isArray(r))throw new Error("bbox must be array");if(4!==r.length)throw new Error("bbox must contain 4 numbers");if(o&&-1===["Polygon","MultiPolygon"].indexOf(X(o)))throw new Error("options.mask must be a (Multi)Polygon");for(var a=r[0],s=r[1],l=r[2],f=r[3],u=t/tr([a,s],[l,s],e)*(l-a),c=t/tr([a,s],[a,f],e)*(f-s),h=l-a,p=f-s,g=Math.floor(h/u),v=(p-Math.floor(p/c)*c)/2,d=a+(h-g*u)/2;d<=l;){for(var y=s+v;y<=f;){var w=_([d,y],n);o?Z(w,o)&&i.push(w):i.push(w),y+=c}d+=u}return T(i)}(i,s,{units:"degrees"}),this.calcGridValue(),e&&this.initReady(e)},calcGridValue:function(){var r=this.option,t=this.pointGrid,e=this._v,o=this._x,n=this._y,a=r.model;switch(r.type){case"kriging":if(r.worker&&window.Worker&&!gr){var s=new Worker(r.worker+"/"+r.type+".js"),l=this;return s.onmessage=function(r){l.pointGrid=r.data,l.pointGridState=!0,l.calcIso()},void s.postMessage([t,e,o,n,a,.1,100])}for(var f=i.train(e,o,n,a,.1,100),u=0;u<t.features.length;u++){var c=i.predict(t.features[u].geometry.coordinates[0],t.features[u].geometry.coordinates[1],f);t.features[u].properties.val=c}this.pointGridState=!0,this.calcIso();break;default:var h=this.points;if(r.worker&&window.Worker&&!gr){var p=new Worker(r.worker+"/"+r.type+".js");l=this;return p.onmessage=function(r){l.pointGrid=r.data,l.pointGridState=!0,l.calcIso()},void p.postMessage([h,t,r.pow])}this.pointGrid=function(r,t,e){null==e&&(e=3);var o=t.features;if(r.length<3)return t;for(var n=r.length,i=o.length,a=[],s=0;s<i;s++)for(var l=0;l<n;l++){var f=Math.sqrt(Math.pow(o[s].geometry.coordinates[0]-r[l].x,2)+Math.pow(o[s].geometry.coordinates[1]-r[l].y,2));a.push(f)}for(s=0;s<i;s++){var u=!1;for(l=n*s;l<n*s+n;l++)if(Math.abs(a[l])<1e-4){o[s].properties.val=r[l-n*s].v,u=!0;break}if(!u){var c=0,h=0;for(l=n*s;l<n*s+n;l++)c+=r[l-n*s].v/Math.pow(a[l],e),h+=1/Math.pow(a[l],e);o[s].properties.val=c/h}}return t}(h,t,r.pow),this.pointGridState=!0,this.calcIso()}},calcIso:function(){for(var r=this.option,t=this.pointGrid,e=r.level,o=[],n=this,i=0,a=e.length;i<a;i++)o.push(e[i].value);if(r.worker&&window.Worker&&!gr){var s=new Worker(r.worker+"/turf.js");n=this;return s.onmessage=function(o){var i=o.data;n.isoline=i,n.isosurface=m(i,r.extent,t,e),n.fmtLatlngsIsoline=C(n.isoline),n.fmtLatlngsIsosurface=C(n.isosurface),n.isoLinesState=!0},void s.postMessage(["isolines",t,o,{zProperty:"val"},e])}var l=ur(t,o,{zProperty:"val"}),f=l.features;for(i=0,a=f.length;i<a;i++)for(var u=f[i].properties.val,c=0;e[c];c++)if(e[c].value==u){f[i].properties.color=e[c].color;break}this.isoline=l,this.isosurface=m(l,r.extent,t,e),this.fmtLatlngsIsoline=C(this.isoline),this.fmtLatlngsIsosurface=C(this.isosurface),this.isoLinesState=!0},alow:function(){return this.pointGrid&&this.isoline},initReady:function(r,t){var e=null,o=this;e=setInterval(function(){o.pointGridState&&o.isoLinesState&&(clearInterval(e),r&&r(o,t))},10)},remove:function(){for(var r in this)delete this[r];return this}},xr.merge=function(r,t,e){var o=c(r)?r:[],n=Object.assign({},{width:800,height:600,child:[]},t);if(!e||!o.length||!n.child.length)return!1;var i=n.child,a=0,s=n.width,l=n.height,f=document.createElement("canvas");f.width=s,f.height=l;var u=f.getContext("2d");u.clearRect(0,0,s,l);for(var h=0,p=i.length;h<p;h++){var g=i[h],v=o[g.target];v&&(a++,v[g.type]&&v.initReady(function(r,t){var o=r[t.type](t.config,1),n=t.scale||1;a--;var i=u.createPattern(o,"no-repeat");if(u.fillStyle=i,u.save(),u.translate(t.x,t.y),u.scale(n,n),u.fillRect(0,0,o.width,o.height),u.restore(),!a)return e(f)},g))}},xr});
