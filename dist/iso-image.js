!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(r=r||self).IsoImage=e()}(this,function(){"use strict";Object.assign||(Object.assign=function(r){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];for(var o,n=Object(r),i=Object.prototype.hasOwnProperty,a=0,s=e.length;a<s;a++)for(var l in o=Object(e[a]))i.call(o,l)&&(n[l]=o[l]);return n});var r=Math.max,e=Math.min,t=Math.abs,o=Math.floor;function n(r){return r=Number(r),isNaN(r)?0:0===r||r===1/0||r===-1/0?r:(r<0?-1:1)*o(t(r))}Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var r,e;for(r=0,e=0;r<this.length;r++)e+=this[r];return e/this.length},Array.prototype.fill=function(t){var o=arguments[1],i=arguments[2],a=function(r){if(null==r)throw TypeError();return Object(r)}(this),s=function(r){var t=n(r);return t<=0?0:t===1/0?9007199254740991:e(t,9007199254740991)}(a.length);s=r(s,0);var l,f,u,c=n(o);for(l=c<0?r(s+c,0):e(c,s),u=(f=void 0===i?s:n(i))<0?r(s+f,0):e(f,s);l<u;){a[String(l)]=t,l+=1}return a},Array.prototype.rep=function(r){return Array.apply(null,new Array(r)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(r,e){var t,o,n=!1;for(t=0,o=this.length-1;t<this.length;o=t++)this[t][1]>e!=this[o][1]>e&&r<(this[o][0]-this[t][0])*(e-this[t][1])/(this[o][1]-this[t][1])+this[t][0]&&(n=!n);return n};var i=function(){var r={},e=function(r,e){var t,o=new Array(e*e).fill(0);for(t=0;t<e;t++)o[t*e+t]=r;return o},t=function(r,e,t,o){var n,i,a=Array(t*o);for(n=0;n<t;n++)for(i=0;i<o;i++)a[n*o+i]=r[n*o+i]+e[n*o+i];return a},o=function(r,e,t,o,n){var i,a,s,l=Array(t*n);for(i=0;i<t;i++)for(a=0;a<n;a++)for(l[i*n+a]=0,s=0;s<o;s++)l[i*n+a]+=r[i*o+s]*e[s*n+a];return l},n=function(r,e){var t,o,n,i=Array(e);for(t=0;t<e;t++)i[t]=r[t*e+t];for(t=0;t<e;t++){for(o=0;o<t;o++)i[t]-=r[t*e+o]*r[t*e+o];if(i[t]<=0)return!1;for(i[t]=Math.sqrt(i[t]),o=t+1;o<e;o++){for(n=0;n<t;n++)r[o*e+t]-=r[o*e+n]*r[t*e+n];r[o*e+t]/=i[t]}}for(t=0;t<e;t++)r[t*e+t]=i[t];return!0},i=function(r,e){var t,o,n,i;for(t=0;t<e;t++)for(r[t*e+t]=1/r[t*e+t],o=t+1;o<e;o++){for(i=0,n=t;n<o;n++)i-=r[o*e+n]*r[n*e+t];r[o*e+t]=i/r[o*e+o]}for(t=0;t<e;t++)for(o=t+1;o<e;o++)r[t*e+o]=0;for(t=0;t<e;t++){for(r[t*e+t]*=r[t*e+t],n=t+1;n<e;n++)r[t*e+t]+=r[n*e+t]*r[n*e+t];for(o=t+1;o<e;o++)for(n=o;n<e;n++)r[t*e+o]+=r[n*e+t]*r[n*e+o]}for(t=0;t<e;t++)for(o=0;o<t;o++)r[t*e+o]=r[o*e+t]},a=function(r,e){var t,o,n,i,a,s,l,f,u,c,h,p=e,g=Array(e*e),v=Array(e),d=Array(e),y=Array(e);for(t=0;t<e;t++)for(i=0;i<e;i++)g[t*e+i]=t==i?1:0;for(i=0;i<e;i++)y[i]=0;for(t=0;t<e;t++){for(f=0,i=0;i<e;i++)if(1!=y[i])for(a=0;a<e;a++)0==y[a]&&Math.abs(r[i*e+a])>=f&&(f=Math.abs(r[i*e+a]),n=i,o=a);if(++y[o],n!=o){for(s=0;s<e;s++)h=r[n*e+s],r[n*e+s]=r[o*e+s],r[o*e+s]=h;for(s=0;s<p;s++)h=g[n*e+s],g[n*e+s]=g[o*e+s],g[o*e+s]=h}if(d[t]=n,v[t]=o,0==r[o*e+o])return!1;for(c=1/r[o*e+o],r[o*e+o]=1,s=0;s<e;s++)r[o*e+s]*=c;for(s=0;s<p;s++)g[o*e+s]*=c;for(l=0;l<e;l++)if(l!=o){for(u=r[l*e+o],r[l*e+o]=0,s=0;s<e;s++)r[l*e+s]-=r[o*e+s]*u;for(s=0;s<p;s++)g[l*e+s]-=g[o*e+s]*u}}for(s=e-1;s>=0;s--)if(d[s]!=v[s])for(a=0;a<e;a++)h=r[a*e+d[s]],r[a*e+d[s]]=r[a*e+v[s]],r[a*e+v[s]]=h;return!0},s=function(r,e,t,o,n){return e+(o-e)/t*(1-Math.exp(-1/n*Math.pow(r/t,2)))},l=function(r,e,t,o,n){return e+(o-e)/t*(1-Math.exp(-1/n*(r/t)))},f=function(r,e,t,o,n){return r>t?e+(o-e)/t:e+(o-e)/t*(r/t*1.5-.5*Math.pow(r/t,3))};return r.train=function(r,u,c,h,p,g){var v={t:r,x:u,y:c,nugget:0,range:0,sill:0,A:1/3,n:0};switch(h){case"gaussian":v.model=s;break;case"exponential":v.model=l;break;case"spherical":v.model=f}var d,y,w,m,b=r.length,x=Array((b*b-b)/2);for(d=0,w=0;d<b;d++)for(y=0;y<d;y++,w++)x[w]=Array(2),x[w][0]=Math.pow(Math.pow(u[d]-u[y],2)+Math.pow(c[d]-c[y],2),.5),x[w][1]=Math.abs(r[d]-r[y]);x.sort(function(r,e){return r[0]-e[0]}),v.range=x[(b*b-b)/2-1][0];var M=(b*b-b)/2>30?30:(b*b-b)/2,k=v.range/M,E=new Array(M).fill(0),L=new Array(M).fill(0);if(M<30)for(m=0;m<M;m++)E[m]=x[m][0],L[m]=x[m][1];else{for(d=0,y=0,w=0,m=0;d<M&&y<(b*b-b)/2;d++,w=0){for(;x[y][0]<=(d+1)*k&&(E[m]+=x[y][0],L[m]+=x[y][1],w++,!(++y>=(b*b-b)/2)););w>0&&(E[m]/=w,L[m]/=w,m++)}if(m<2)return v}b=m,v.range=E[b-1]-E[0];var A=new Array(2*b).fill(1),C=Array(b),P=v.A;for(d=0;d<b;d++){switch(h){case"gaussian":A[2*d+1]=1-Math.exp(-1/P*Math.pow(E[d]/v.range,2));break;case"exponential":A[2*d+1]=1-Math.exp(-1/P*E[d]/v.range);break;case"spherical":A[2*d+1]=E[d]/v.range*1.5-.5*Math.pow(E[d]/v.range,3)}C[d]=L[d]}var S=function(r,e,t){var o,n,i=Array(t*e);for(o=0;o<e;o++)for(n=0;n<t;n++)i[n*e+o]=r[o*t+n];return i}(A,b,2),O=o(S,A,2,b,2),I=(O=t(O,e(1/g,2),2,2)).slice(0);n(O,2)?i(O,2):(a(I,2),O=I);var _=o(o(O,S,2,2,b),C,2,b,1);v.nugget=_[0],v.sill=_[1]*v.range+v.nugget,v.n=u.length,b=u.length;var j=Array(b*b);for(d=0;d<b;d++){for(y=0;y<d;y++)j[d*b+y]=v.model(Math.pow(Math.pow(u[d]-u[y],2)+Math.pow(c[d]-c[y],2),.5),v.nugget,v.range,v.sill,v.A),j[y*b+d]=j[d*b+y];j[d*b+d]=v.model(0,v.nugget,v.range,v.sill,v.A)}var T=t(j,e(p,b),b,b),q=T.slice(0);n(T,b)?i(T,b):(a(q,b),T=q);j=T.slice(0);var G=o(T,r,b,b,1);return v.K=j,v.M=G,v},r.predict=function(r,e,t){var n,i=Array(t.n);for(n=0;n<t.n;n++)i[n]=t.model(Math.pow(Math.pow(r-t.x[n],2)+Math.pow(e-t.y[n],2),.5),t.nugget,t.range,t.sill,t.A);return o(i,t.M,1,t.n,1)[0]},r}(),a=function(r,e){for(var t=r[0],o=r[1],n=!1,i=0,a=e.length-1;i<e.length;a=i++){var s=e[i][0],l=e[i][1],f=e[a][0],u=e[a][1];l>o!=u>o&&t<(f-s)*(o-l)/(u-l)+s&&(n=!n)}return n},s=function(r){return JSON.parse(JSON.stringify(r))},l=function(r,e){return r[0]==e[0]&&r[1]==e[1]},f=function(r,e){return Math.abs(r-e)},u=Object.prototype.toString,c=function(r){return"[object Array]"===u.call(r)},h=function(r,e,t,o,n,i,a){a=a||[];for(var f,u,c,p,g=o[o.length-1],v="t"==n||"b"==n?0:1,d="t"==n||"l"==n?1:-1,y=i?-1:1,w=0;t[n][w];w++){var m=t[n][w],b=(m.p[v]-g[v])*d*y;b>0&&(!f||f&&u>b)&&(f=m,u=b)}if(f)l(f.p,o[0])?o.push(f.p):(p=s(r[f.coor].coor),f.d&&p.reverse(),o=o.concat(p)),c=f.t;else if(i)switch(n){case"t":o.push(e.sa),c="l";break;case"r":o.push(e.sb),c="t";break;case"b":o.push(e.sc),c="r";break;case"l":o.push(e.sd),c="b"}else switch(n){case"t":o.push(e.sb),c="r";break;case"r":o.push(e.sc),c="b";break;case"b":o.push(e.sd),c="l";break;case"l":o.push(e.sa),c="t"}return o.length>1&&l(o[0],o[o.length-1])?[o].concat(a):(f&&p&&(a=h(r,e,t,p,c,!i,a)),o=h(r,e,t,o,c,i,a))},p=function(r,e,t){for(var o=!1,n=0,i=r.length;n<i;n++){if(e<r[n].value){if(!o){o=JSON.parse(JSON.stringify(r[n]));break}var a=(e-o.value)/(r[n].value-o.value),s=function(e){return t?parseInt(o[e]+(r[n][e]-o[e])*a):r[n][e]};o.r=s("r"),o.g=s("g"),o.b=s("b");break}o=JSON.parse(JSON.stringify(r[n]))}return o},g=Math.abs,v=Math.max,d=Math.min,y=Math.floor,w=function(r,e){for(var t=0,o=v(f(e[0],e[2]),f(e[1],e[3])),n=0;n<4;n++){var i=f(e[n],r[n%2]);i<o&&(o=i,t=n)}return"lbrt".charAt(t)};function m(r,e,t,o){for(var n,i=[],f=[],u={t:[],b:[],l:[],r:[]},c=r.features,m=0,b=c.length;m<b;m++)for(var x=c[m],M=0,k=(X=x.geometry.coordinates).length;M<k;M++){var E=X[M],L=E[0],A=E[E.length-1];if(l(L,A))i.push({coor:E,properties:x.properties,child:[],parent:[],i:i.length});else{f.push({coor:E,properties:x.properties});var C=w(L,e),P=w(A,e);u[C].push({p:L,end:A,d:0,t:P,coor:f.length-1}),u[P].push({p:A,end:L,d:1,t:C,coor:f.length-1})}}for(var S={sa:[e[0],e[3]],sb:[e[2],e[3]],sc:[e[2],e[1]],sd:[e[0],e[1]]},O=(m=0,(n=h(f,S,u,[S.sa],"t",!1)).length);m<O;m++)i.push({coor:n[m],properties:{type:"open"},child:[],parent:[],i:i.length});for(m=0,b=i.length;m<b;m++)for(var I=m+1;I<b;I++){var _=i[m].properties.type,j=i[I].properties.type;"open"!=_&&a(i[m].coor[0],i[I].coor)?(i[I].child.push(m),i[m].parent.push(I)):"open"!=j&&a(i[I].coor[0],i[m].coor)&&(i[m].child.push(I),i[I].parent.push(m))}var T=s(i),q=[],G=[],N=[],R=function(){if(!T.length)return!1;for(var r=[],e=0,t=T.length;e<t;e++){for(var o=T[e],n=o.child,i=1,a=n.length-1;a>-1;a--)-1==G.indexOf(n[a])&&(i=0);if(i){var s=[];for(a=n.length-1;a>-1;a--){var l=N.indexOf(n[a]);l>-1&&(s.push(n[a]),N.splice(l,1))}N.push(o.i),G.push(o.i),T[e].child=s,q.push(T[e])}else r.push(T[e])}if(!r.length)return!1;T=r,R()};R();var F=[],W=t.features,z=W.length,B=W[0].geometry.coordinates,D=1,J=1,U=1;for(m=0;m<z;m++){var V=W[m].geometry.coordinates;if(1==m&&(U=g(V[1]-B[1])),V[0]!=B[0]){D=m,J=g(V[0]-B[0]);break}}for(m=0,b=q.length;m<b;m++){for(var X,Y=[(X=q[m]).coor],K="rgba(0, 0, 0, 0)",H=(I=0,X.child.length);I<H;I++)Y.push(i[X.child[I]].coor);var Q,Z=y(X.coor.length/2),$=X.coor[Z],rr=($[0]-B[0])/J,er=v(y(rr)*D+y(($[1]-B[1])/U),0),tr=rr%1?0:1,or=tr?1:D,nr=tr?U:J,ir=nr/100;if(W[er]&&W[er+or]){var ar=W[er].geometry.coordinates,sr=W[er+or].geometry.coordinates,lr=Object.assign([],$,[]);lr[tr]=v($[tr]-ir,ar[tr]);var fr=W[er].properties.val,ur=W[er+or].properties.val;a(lr,X.coor)||(lr[tr]=d($[tr]+2*ir,sr[tr])),a(lr,X.coor)&&(Q=fr+(ur-fr)*(g(lr[tr]-W[er].geometry.coordinates[tr])/nr))}else W[er]&&(Q=W[er].properties.val);if(null!=Q){var cr=p(o,Q,!1);K="rgb("+cr.r+","+cr.g+","+cr.b+")",Q=cr.value}F.push({geometry:{coordinates:Y,type:"MultiLineString"},properties:{val:Q,color:K},type:"Feature"})}return{features:F,type:"FeatureCollection"}}var b={direction:"vertical",backgroundColor:"#fff",color:"#333",gradient:!0};function M(r,e){if(r.legend<2)return!1;var t=(e=Object.assign({},b,e)).gradient?1:0,o="horizontal"==e.direction?0:1,n=e.title||"",i=e.shape||"rect",a=document.createElement("canvas"),s=o?120:340;t||(s+=20);var l=o?240:50;a.width=s,a.height=l;var f=o?[15,30,20,200]:[70,5,200,20],u=o?[f[0],f[1]+f[3],f[0],f[1]]:[f[0],f[1],f[0]+f[2],f[1]],c=a.getContext("2d");c.lineWidth=1,c.strokeStyle="#999",c.fillStyle=e.backgroundColor,c.fillRect(0,0,s,l),c.font="12px 微软雅黑",c.textBaseline="middle",c.textAlign="start",c.fillStyle=e.color;for(var h=c.createLinearGradient(u[0],u[1],u[2],u[3]),p=0,g=r.length;p<g;p++){var v=r[p].color,d=r[p].unit||"",y=r[p].value+d,w=1/(g-1)*p;if(!t&&p>0&&p<g-1){var m=r[p-1].color;h.addColorStop(w,m),h.addColorStop(w,v)}else h.addColorStop(w,v);if(o)c.fillText(y,f[0]+f[2]+5,f[1]+f[3]*(1-w));else if(!p||p==g-1){var x=c.measureText(y).width,M=f[1]+f[3]/2,k=p?f[0]+f[2]+5:f[0]-5-x;c.fillText(y,k,M)}}switch(c.fillStyle=h,i){case"triangle-rect":if(o){var E=f[2]/2;c.beginPath(),c.moveTo(f[0]+E,f[1]),c.lineTo(f[0]+f[2],f[1]+E),c.lineTo(f[0]+f[2],f[1]+f[3]-E),c.lineTo(f[0]+E,f[1]+f[3]),c.lineTo(f[0],f[1]+f[3]-E),c.lineTo(f[0],f[1]+E),c.lineTo(f[0]+E,f[1]),c.stroke(),c.fill()}else{E=f[3]/2;c.beginPath(),c.moveTo(f[0],f[1]+E),c.lineTo(f[0]+E,f[1]),c.lineTo(f[0]+f[2]-E,f[1]),c.lineTo(f[0]+f[2],f[1]+E),c.lineTo(f[0]+f[2]-E,f[1]+f[3]),c.lineTo(f[0]+E,f[1]+f[3]),c.lineTo(f[0],f[1]+E),c.stroke(),c.fill()}break;default:c.fillRect(f[0],f[1],f[2],f[3])}return n.length&&(c.font="14px 微软雅黑",c.fillStyle=e.color,c.textBaseline="top",o?(c.textAlign="start",c.fillText(n,5,5)):(c.textAlign="center",c.fillText(n,s/2,f[1]+f[3]+5))),a}function k(r,e,t,o){var n=null==(o=o||{}).gradient||o.gradient,i=r.size,a=r.cellWidth,s=r.level,l=r.ex,f=o.filter,u=o.width||1e3,c=Math.abs(u/i[0]*i[1]),h=document.createElement("canvas");h.width=u,h.height=c;var g=h.getContext("2d");if(g.clearRect(0,0,u,c),n)for(var v=e.features,d=Math.abs(a/i[0]*u),y=Math.abs(a/i[1]*c),w=0,m=v.length;w<m;w++){var b=v[w].geometry.coordinates,x=(b[0]-l[0][0])/i[0]*u-d/2,M=(b[1]-l[0][1])/i[1]*c-y/2,k=p(s,v[w].properties.val,n),E=k.value;f&&f.indexOf&&-1==f.indexOf(E)||(g.strokeStyle=g.fillStyle="rgb("+k.r+","+k.g+","+k.b+")",g.beginPath(),g.fillRect(x-1,M-1,d+2,y+2))}else{var L=t.features;for(w=0,m=L.length;w<m;w++){E=L[w].properties.val;if(!f||!f.indexOf||-1!=f.indexOf(E)){var A=L[w].geometry.coordinates;g.strokeStyle=g.fillStyle=L[w].properties.color,g.beginPath();for(var C=0,P=A.length;C<P;C++)for(var S=0,O=A[C].length;S<O;S++){x=(A[C][S][0]-l[0][0])/i[0]*u,M=(A[C][S][1]-l[0][1])/i[1]*c;g[S?"lineTo":"moveTo"](x,M)}g.fill("evenodd")}}}return h}function E(r,e,t){t=t||{};var o=r.size,n=r.ex,i=t.width||1e3,a=Math.abs(i/o[0]*o[1]),s=t.isolineColor||"#333",l=t.filter,f=document.createElement("canvas");f.width=i,f.height=a;var u=f.getContext("2d");u.clearRect(0,0,i,a),u.lineWidth=1,u.font="12px 微软雅黑",u.textBaseline="middle",u.textAlign="center";for(var c=e.features,h={},p=0,g=c.length;p<g;p++){var v=c[p].properties.val;if(!l||!l.indexOf||-1!=l.indexOf(v)){var d=c[p].geometry.coordinates,y="level"==s?c[p].properties.color:s;u.strokeStyle=u.fillStyle=y;for(var w=0,m=d.length;w<m;w++){u.beginPath();for(var b=0,x=0,M=d[w].length;x<M;x++){var k=(d[w][x][0]-n[0][0])/o[0]*i,E=(d[w][x][1]-n[0][1])/o[1]*a;u[x?"lineTo":"moveTo"](k,E);var L=Math.round(k/16)+"-"+Math.round(E/16);h[L]||b||(h[L]=1,b=1,u.fillText(v,k,E))}u.stroke()}}}return f}function A(r,e,t){if(!r[0])return!1;var o=(t=t||{}).opacity||1,n=r[0].width,i=r[0].height,a=document.createElement("canvas");a.width=n,a.height=i;var s=a.getContext("2d");s.clearRect(0,0,n,i),s.globalAlpha=o,s.strokeStyle=t.clipColor||"#333",s.lineWidth=t.clipWidth||1;var l=e.clip;if(l&&c(l)){var f=e.ex,u=e.size,h=e.key||{},p=h.clipX||0,g=h.clipY||1;s.beginPath();var v=function(r){if(c(r[0])&&c(r[0][0])){for(var e=0,t=r.length;e<t;e++)v(r[e]);return!1}if(c(r))for(e=0,t=r.length;e<t;e++){var o=(r[e][p]-f[0][0])/u[0]*n,a=(r[e][g]-f[0][1])/u[1]*i;s[e?"lineTo":"moveTo"](o,a)}};v(l),t.clip&&s.stroke(),s.clip()}for(var d=0;r[d];d++){var y=s.createPattern(r[d],"no-repeat");s.fillStyle=y,s.fillRect(0,0,n,i)}return a}var C=function(r,e,t,o){if(void 0===o&&(o=1),void 0===t&&(t=0),!e)return[r[o],r[t]];e--;for(var n=0,i=r.length;n<i;n++)r[n]=C(r[n],e);return r},P=function(r){for(var e=s(r),t=0,o=e.features.length;t<o;t++){var n=e.features[t].geometry.coordinates;e.features[t].geometry.coordinates=C(n,2)}return e},S=function(r){return L.IsoImageCanvasLayer||(L.IsoImageCanvasLayer=L.Canvas.extend({_initContainer:function(){var r=this._container=document.createElement("canvas");this._container.style.opacity=0,L.DomEvent.on(r,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this),L.DomEvent.on(r,"click dblclick mousedown mouseup contextmenu",this._onClick,this),L.DomEvent.on(r,"mouseout",this._handleMouseOut,this),this._ctx=r.getContext("2d")},_draw:function(){var r,e=this._redrawBounds,t=this._ctx;if(t.save(),e){var o=e.getSize();t.beginPath(),t.rect(e.min.x,e.min.y,o.x,o.y),t.clip()}this._drawing=!0;for(var n=this._drawFirst;n;n=n.next)r=n.layer,(!e||r._pxBounds&&r._pxBounds.intersects(e))&&r._updatePath();this._drawing=!1,t.restore(),this.options.clipLayer&&this.options.clipLayer._clip(t)}})),new L.IsoImageCanvasLayer(r)},O=function(r){return L.ClipCanvasLayer||(L.ClipCanvasLayer=L.Canvas.extend({_initContainer:function(){var r=this._container=document.createElement("canvas");L.DomEvent.on(r,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this),L.DomEvent.on(r,"click dblclick mousedown mouseup contextmenu",this._onClick,this),L.DomEvent.on(r,"mouseout",this._handleMouseOut,this),this._ctx=r.getContext("2d")},_clip:function(r){var e=this._ctx;e.fillStyle=e.createPattern(r.canvas,"no-repeat"),e.beginPath();for(var t=this._drawFirst;t;t=t.next)for(var o=t.layer._parts,n=0,i=o.length;n<i;n++)for(var a=0,s=o[n].length;a<s;a++)e[a?"lineTo":"moveTo"](o[n][a].x,o[n][a].y);e.save(),e.translate(this._bounds.min.x,this._bounds.min.y),e.fill(),e.restore()}})),new L.ClipCanvasLayer(r)};function I(r,e,t,o){if(!r||!t)return!1;for(var n=[],i=o.filter,a=0;r.features[a];a++){var s=r.features[a],l=s.properties.val;if(!(i&&i.indexOf&&-1==i.indexOf(l)||!s.geometry.coordinates.length)){var f=Object.assign({},{stroke:!0,weight:1,opacity:.7,fillOpacity:.7,color:s.properties.color,fillColor:s.properties.color,renderer:t},o),u=L[e](s.geometry.coordinates,f);n.push(u)}}return n}var _={meters:6371008.8,metres:6371008.8,millimeters:6371008800,millimetres:6371008800,centimeters:637100880,centimetres:637100880,kilometers:6371.0088,kilometres:6371.0088,miles:3958.761333810546,nauticalmiles:6371008.8/1852,inches:6371008.8*39.37,yards:6371008.8/1.0936,feet:20902260.511392,radians:1,degrees:6371008.8/111325};function j(r,e,t){if(!F(t=t||{}))throw new Error("options is invalid");var o=t.bbox,n=t.id;if(void 0===r)throw new Error("geometry is required");if(e&&e.constructor!==Object)throw new Error("properties must be an Object");o&&W(o),n&&z(n);var i={type:"Feature"};return n&&(i.id=n),o&&(i.bbox=o),i.properties=e||{},i.geometry=r,i}function T(r,e,t){if(!r)throw new Error("coordinates is required");if(!Array.isArray(r))throw new Error("coordinates must be an Array");if(r.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!R(r[0])||!R(r[1]))throw new Error("coordinates must contain numbers");return j({type:"Point",coordinates:r},e,t)}function q(r,e){if(!F(e=e||{}))throw new Error("options is invalid");var t=e.bbox,o=e.id;if(!r)throw new Error("No features passed");if(!Array.isArray(r))throw new Error("features must be an Array");t&&W(t),o&&z(o);var n={type:"FeatureCollection"};return o&&(n.id=o),t&&(n.bbox=t),n.features=r,n}function G(r,e,t){if(!r)throw new Error("coordinates is required");return j({type:"MultiLineString",coordinates:r},e,t)}function N(r){if(null==r)throw new Error("degrees is required");return r%360*Math.PI/180}function R(r){return!isNaN(r)&&null!==r&&!Array.isArray(r)}function F(r){return!!r&&r.constructor===Object}function W(r){if(!r)throw new Error("bbox is required");if(!Array.isArray(r))throw new Error("bbox must be an Array");if(4!==r.length&&6!==r.length)throw new Error("bbox must be an Array of 4 or 6 numbers");r.forEach(function(r){if(!R(r))throw new Error("bbox must only contain numbers")})}function z(r){if(!r)throw new Error("id is required");if(-1===["string","number"].indexOf(typeof r))throw new Error("id must be a number or a string")}function B(r,e,t){if(null!==r)for(var o,n,i,a,s,l,f,u,c=0,h=0,p=r.type,g="FeatureCollection"===p,v="Feature"===p,d=g?r.features.length:1,y=0;y<d;y++){s=(u=!!(f=g?r.features[y].geometry:v?r.geometry:r)&&"GeometryCollection"===f.type)?f.geometries.length:1;for(var w=0;w<s;w++){var m=0,b=0;if(null!==(a=u?f.geometries[w]:f)){l=a.coordinates;var x=a.type;switch(c=!t||"Polygon"!==x&&"MultiPolygon"!==x?0:1,x){case null:break;case"Point":e(l,h,y,m,b),h++,m++;break;case"LineString":case"MultiPoint":for(o=0;o<l.length;o++)e(l[o],h,y,m,b),h++,"MultiPoint"===x&&m++;"LineString"===x&&m++;break;case"Polygon":case"MultiLineString":for(o=0;o<l.length;o++){for(n=0;n<l[o].length-c;n++)e(l[o][n],h,y,m,b),h++;"MultiLineString"===x&&m++,"Polygon"===x&&b++}"Polygon"===x&&m++;break;case"MultiPolygon":for(o=0;o<l.length;o++){for("MultiPolygon"===x&&(b=0),n=0;n<l[o].length;n++){for(i=0;i<l[o][n].length-c;i++)e(l[o][n][i],h,y,m,b),h++;b++}m++}break;case"GeometryCollection":for(o=0;o<a.geometries.length;o++)B(a.geometries[o],e,t);break;default:throw new Error("Unknown Geometry Type")}}}}}function D(r){var e=[1/0,1/0,-1/0,-1/0];return B(r,function(r){e[0]>r[0]&&(e[0]=r[0]),e[1]>r[1]&&(e[1]=r[1]),e[2]<r[0]&&(e[2]=r[0]),e[3]<r[1]&&(e[3]=r[1])}),e}function J(r){if(!r)throw new Error("obj is required");var e=U(r);if(e.length>1&&R(e[0])&&R(e[1]))return e;throw new Error("Coordinate is not a valid Point")}function U(r){if(!r)throw new Error("obj is required");var e;if(r.length?e=r:r.coordinates?e=r.coordinates:r.geometry&&r.geometry.coordinates&&(e=r.geometry.coordinates),e)return function r(e){if(e.length>1&&R(e[0])&&R(e[1]))return!0;if(Array.isArray(e[0])&&e[0].length)return r(e[0]);throw new Error("coordinates must only contain numbers")}(e),e;throw new Error("No valid coordinates")}function V(r,e,t){if(!r)throw new Error("No featureCollection passed");if(!t)throw new Error(".collectionOf() requires a name");if(!r||"FeatureCollection"!==r.type)throw new Error("Invalid input to "+t+", FeatureCollection required");for(var o=0;o<r.features.length;o++){var n=r.features[o];if(!n||"Feature"!==n.type||!n.geometry)throw new Error("Invalid input to "+t+", Feature with geometry required");if(!n.geometry||n.geometry.type!==e)throw new Error("Invalid input to "+t+": must be a "+e+", given "+n.geometry.type)}}function X(r){if(!r)throw new Error("geojson is required");if(void 0!==r.geometry)return r.geometry;if(r.coordinates||r.geometries)return r;throw new Error("geojson must be a valid Feature or Geometry Object")}function Y(r,e){if(!r)throw new Error((e||"geojson")+" is required");if(r.geometry&&r.geometry.type)return r.geometry.type;if(r.type)return r.type;throw new Error((e||"geojson")+" is invalid")}function K(r,e,t){var o=(t=t||{}).ignoreEndVertices;if(!F(t))throw new Error("invalid options");if(!r)throw new Error("pt is required");if(!e)throw new Error("line is required");for(var n=J(r),i=U(e),a=0;a<i.length-1;a++){var s=!1;if(o&&(0===a&&(s="start"),a===i.length-2&&(s="end"),0===a&&a+1===i.length-1&&(s="both")),H(i[a],i[a+1],n,s))return!0}return!1}function H(r,e,t,o){var n=t[0],i=t[1],a=r[0],s=r[1],l=e[0],f=e[1],u=l-a,c=f-s;return 0==(t[0]-a)*c-(t[1]-s)*u&&(o?"start"===o?Math.abs(u)>=Math.abs(c)?u>0?a<n&&n<=l:l<=n&&n<a:c>0?s<i&&i<=f:f<=i&&i<s:"end"===o?Math.abs(u)>=Math.abs(c)?u>0?a<=n&&n<l:l<n&&n<=a:c>0?s<=i&&i<f:f<i&&i<=s:"both"===o?Math.abs(u)>=Math.abs(c)?u>0?a<n&&n<l:l<n&&n<a:c>0?s<i&&i<f:f<i&&i<s:void 0:Math.abs(u)>=Math.abs(c)?u>0?a<=n&&n<=l:l<=n&&n<=a:c>0?s<=i&&i<=f:f<=i&&i<=s)}function Q(r,e,t){if("object"!=typeof(t=t||{}))throw new Error("options is invalid");var o=t.ignoreBoundary;if(!r)throw new Error("point is required");if(!e)throw new Error("polygon is required");var n=J(r),i=U(e),a=e.geometry?e.geometry.type:e.type,s=e.bbox;if(s&&!1===function(r,e){return e[0]<=r[0]&&e[1]<=r[1]&&e[2]>=r[0]&&e[3]>=r[1]}(n,s))return!1;"Polygon"===a&&(i=[i]);for(var l=0,f=!1;l<i.length&&!f;l++)if(Z(n,i[l][0],o)){for(var u=!1,c=1;c<i[l].length&&!u;)Z(n,i[l][c],!o)&&(u=!0),c++;u||(f=!0)}return f}function Z(r,e,t){var o=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var n=0,i=e.length-1;n<e.length;i=n++){var a=e[n][0],s=e[n][1],l=e[i][0],f=e[i][1];if(r[1]*(a-l)+s*(l-r[0])+f*(r[0]-a)==0&&(a-r[0])*(l-r[0])<=0&&(s-r[1])*(f-r[1])<=0)return!t;s>r[1]!=f>r[1]&&r[0]<(l-a)*(r[1]-s)/(f-s)+a&&(o=!o)}return o}function $(r,e){var t=Y(r),o=Y(e),n=X(r),i=X(e);switch(t){case"Point":switch(o){case"MultiPoint":return function(r,e){var t,o=!1;for(t=0;t<e.coordinates.length;t++)if(er(e.coordinates[t],r.coordinates)){o=!0;break}return o}(n,i);case"LineString":return K(n,i,{ignoreEndVertices:!0});case"Polygon":return Q(n,i,{ignoreBoundary:!0});default:throw new Error("feature2 "+o+" geometry not supported")}case"MultiPoint":switch(o){case"MultiPoint":return function(r,e){for(var t=0;t<r.coordinates.length;t++){for(var o=!1,n=0;n<e.coordinates.length;n++)er(r.coordinates[t],e.coordinates[n])&&(o=!0);if(!o)return!1}return!0}(n,i);case"LineString":return function(r,e){for(var t=!1,o=0;o<r.coordinates.length;o++){if(!K(r.coordinates[o],e))return!1;t||(t=K(r.coordinates[o],e,{ignoreEndVertices:!0}))}return t}(n,i);case"Polygon":return function(r,e){for(var t=!0,o=0;o<r.coordinates.length;o++){var n=Q(r.coordinates[1],e);if(!n){t=!1;break}n=Q(r.coordinates[1],e,{ignoreBoundary:!0})}return t&&n}(n,i);default:throw new Error("feature2 "+o+" geometry not supported")}case"LineString":switch(o){case"LineString":return function(r,e){for(var t=0;t<r.coordinates.length;t++)if(!K(r.coordinates[t],e))return!1;return!0}(n,i);case"Polygon":return function(r,e){var t=D(e),o=D(r);if(!rr(t,o))return!1;for(var n=!1,i=0;i<r.coordinates.length-1;i++){if(!Q(r.coordinates[i],e))return!1;if(n||(n=Q(r.coordinates[i],e,{ignoreBoundary:!0})),!n){var a=(s=r.coordinates[i],l=r.coordinates[i+1],[(s[0]+l[0])/2,(s[1]+l[1])/2]);n=Q(a,e,{ignoreBoundary:!0})}}var s,l;return n}(n,i);default:throw new Error("feature2 "+o+" geometry not supported")}case"Polygon":switch(o){case"Polygon":return function(r,e){var t=D(r);if(!rr(D(e),t))return!1;for(var o=0;o<r.coordinates[0].length;o++)if(!Q(r.coordinates[0][o],e))return!1;return!0}(n,i);default:throw new Error("feature2 "+o+" geometry not supported")}default:throw new Error("feature1 "+t+" geometry not supported")}}function rr(r,e){return!(r[0]>e[0])&&(!(r[2]<e[2])&&(!(r[1]>e[1])&&!(r[3]<e[3])))}function er(r,e){return r[0]===e[0]&&r[1]===e[1]}function tr(r,e,t){if(!F(t=t||{}))throw new Error("options is invalid");var o=t.units,n=J(r),i=J(e),a=N(i[1]-n[1]),s=N(i[0]-n[0]),l=N(n[1]),f=N(i[1]),u=Math.pow(Math.sin(a/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(l)*Math.cos(f);return function(r,e){if(null==r)throw new Error("radians is required");if(e&&"string"!=typeof e)throw new Error("units must be a string");var t=_[e||"kilometers"];if(!t)throw new Error(e+" units is invalid");return r*t}(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),o)}var or={successCallback:null,verbose:!1},nr={};function ir(r,e,t){t=t||{};for(var o=Object.keys(or),n=0;n<o.length;n++){var i=o[n],a=t[i];a=null!=a?a:or[i],nr[i]=a}nr.verbose&&console.log("MarchingSquaresJS-isoContours: computing isocontour for "+e);var s=function(r){var e=[],t=0;r.rows,r.cols;return r.cells.forEach(function(o,n){o.forEach(function(o,i){if(void 0!==o&&5!==(h=o).cval&&10!==h.cval&&!sr(o)){var a=function(r,e,t){var o,n,i,a=r.length,s=[],l=[0,0,1,1,0,0,0,0,-1,0,1,1,-1,0,-1,0],f=[0,-1,0,0,1,1,1,1,0,-1,0,0,0,-1,0,0],u=["none","bottom","right","right","top","top","top","top","left","bottom","right","right","left","bottom","left","none"],c=(r[e][t],r[e][t]),h=c.cval,p=fr(c,i=["none","left","bottom","left","right","none","bottom","left","top","top","none","top","right","right","bottom","none"][h]);s.push([t+p[0],e+p[1]]),p=fr(c,i=u[h]),s.push([t+p[0],e+p[1]]),lr(c);for(var g=t+l[h],v=e+f[h],d=h;g>=0&&v>=0&&v<a&&(g!=t||v!=e)&&void 0!==(c=r[v][g]);){if(0===(h=c.cval)||15===h)return{path:s,info:"mergeable"};i=u[h],o=l[h],n=f[h],5!==h&&10!==h||(5===h?c.flipped?-1===f[d]?(i="left",o=-1,n=0):(i="right",o=1,n=0):-1===l[d]&&(i="bottom",o=0,n=-1):10===h&&(c.flipped?-1===l[d]?(i="top",o=0,n=1):(i="bottom",o=0,n=-1):1===f[d]&&(i="left",o=-1,n=0))),p=fr(c,i),s.push([g+p[0],v+p[1]]),lr(c),g+=o,v+=n,d=h}return{path:s,info:"closed"}}(r.cells,n,i),s=!1;if("mergeable"===a.info)for(var l=a.path[a.path.length-1][0],f=a.path[a.path.length-1][1],u=t-1;u>=0;u--)if(Math.abs(e[u][0][0]-l)<=1e-7&&Math.abs(e[u][0][1]-f)<=1e-7){for(var c=a.path.length-2;c>=0;--c)e[u].unshift(a.path[c]);s=!0;break}s||(e[t++]=a.path)}var h})}),e}(function(r,e){for(var t=r.length-1,o=r[0].length-1,n={rows:t,cols:o,cells:[]},i=0;i<t;++i){n.cells[i]=[];for(var a=0;a<o;++a){var s=0,l=r[i+1][a],f=r[i+1][a+1],u=r[i][a+1],c=r[i][a];if(!(isNaN(l)||isNaN(f)||isNaN(u)||isNaN(c))){s|=l>=e?8:0,s|=f>=e?4:0,s|=u>=e?2:0;var h,p,g,v,d=!1;if(5===(s|=c>=e?1:0)||10===s){var y=(l+f+u+c)/4;5===s&&y<e?(s=10,d=!0):10===s&&y<e&&(s=5,d=!0)}if(0!==s&&15!==s)h=p=g=v=.5,1===s?(g=1-ar(e,l,c),p=1-ar(e,u,c)):2===s?(p=ar(e,c,u),v=1-ar(e,f,u)):3===s?(g=1-ar(e,l,c),v=1-ar(e,f,u)):4===s?(h=ar(e,l,f),v=ar(e,u,f)):5===s?(h=ar(e,l,f),v=ar(e,u,f),p=1-ar(e,u,c),g=1-ar(e,l,c)):6===s?(p=ar(e,c,u),h=ar(e,l,f)):7===s?(g=1-ar(e,l,c),h=ar(e,l,f)):8===s?(g=ar(e,c,l),h=1-ar(e,f,l)):9===s?(p=1-ar(e,u,c),h=1-ar(e,f,l)):10===s?(h=1-ar(e,f,l),v=1-ar(e,f,u),p=ar(e,c,u),g=ar(e,c,l)):11===s?(h=1-ar(e,f,l),v=1-ar(e,f,u)):12===s?(g=ar(e,c,l),v=ar(e,u,f)):13===s?(p=1-ar(e,u,c),v=ar(e,u,f)):14===s?(g=ar(e,c,l),p=ar(e,c,u)):console.log("MarchingSquaresJS-isoContours: Illegal cval detected: "+s),n.cells[i][a]={cval:s,flipped:d,top:h,right:v,bottom:p,left:g}}}}return n}(r,e));return"function"==typeof nr.successCallback&&nr.successCallback(s),s}function ar(r,e,t){return(r-e)/(t-e)}function sr(r){return 0===r.cval||15===r.cval}function lr(r){sr(r)||5===r.cval||10===r.cval||(r.cval=15)}function fr(r,e){return"top"===e?[r.top,1]:"bottom"===e?[r.bottom,0]:"right"===e?[1,r.right]:"left"===e?[0,r.left]:void 0}function ur(r,e){if(!F(e=e||{}))throw new Error("options is invalid");var t=e.zProperty||"elevation",o=e.flip,n=e.flags;V(r,"Point","input must contain Points");for(var i=function(r,e){var t={};return function(r,e){if("Feature"===r.type)e(r,0);else if("FeatureCollection"===r.type)for(var t=0;t<r.features.length;t++)e(r.features[t],t)}(r,function(r){var e=U(r)[1];t[e]||(t[e]=[]),t[e].push(r)}),Object.keys(t).map(function(r){return t[r].sort(function(r,e){return U(r)[0]-U(e)[0]})}).sort(function(r,t){return e?U(r[0])[1]-U(t[0])[1]:U(t[0])[1]-U(r[0])[1]})}(r,o),a=[],s=0;s<i.length;s++){for(var l=i[s],f=[],u=0;u<l.length;u++){var c=l[u];c.properties[t]?f.push(c.properties[t]):f.push(0),!0===n&&(c.properties.matrixPosition=[s,u])}a.push(f)}return a}function cr(r,e,t){if(!F(t=t||{}))throw new Error("options is invalid");var o=t.zProperty||"elevation",n=t.commonProperties||{},i=t.breaksProperties||[];if(V(r,"Point","Input must contain Points"),!e)throw new Error("breaks is required");if(!Array.isArray(e))throw new Error("breaks must be an Array");if(!F(n))throw new Error("commonProperties must be an Object");if(!Array.isArray(i))throw new Error("breaksProperties must be an Array");var a=ur(r,{zProperty:o,flip:!0});return q(function(r,e,t){var o=D(t),n=o[2]-o[0],i=o[3]-o[1],a=o[0],s=o[1],l=e[0].length-1,f=e.length-1,u=n/l,c=i/f,h=function(r){r[0]=r[0]*u+a,r[1]=r[1]*c+s};return r.forEach(function(r){B(r,h)}),r}(function(r,e,t,o,n){for(var i=[],a=1;a<e.length;a++){var s=+e[a],l=Object.assign({},o,n[a]);l[t]=s;var f=G(ir(r,s),l);i.push(f)}return i}(a,e,o,n,i),a,r))}var hr="IsoImage",pr="image/png",gr="ActiveXObject"in window,vr=Math.min,dr=Math.max,yr=Math.abs,wr=Math.round,mr={x:"x",y:"y",v:"v",clipX:"0",clipY:"1"},br=function(){var r="L"in window;return r||console.log("未加载leaflet"),r};function xr(r,e,t){this.name=hr,this.initialize(r,e,t),this.getIsosurface=function(r,e){if(!this.alow())return!1;var t=A([k(this.option,this.pointGrid,this.isosurface,r)],this.option,r);return e?t:t.toDataURL(pr)},this.getIsoline=function(r,e){if(!this.alow())return!1;var t=A([E(this.option,this.isoline,r)],this.option,r);return e?t:t.toDataURL(pr)},this.getIsoImage=function(r,e){if(!this.alow())return!1;var t=A([k(this.option,this.pointGrid,this.isosurface,r),E(this.option,this.isoline,r)],this.option,r);return e?t:t.toDataURL(pr)},this.getLegend=function(r,e){var t=M(this.option.level||[],r);return!!t&&(e?t:t.toDataURL("image/png"))},this.layer=function(r,e){if(!br())return!1;e=Object.assign({},{padding:.5,opacity:.1},e);var t=O(e),o={stroke:!0,weight:1,opacity:.7,fillOpacity:0,color:"#ff0000",fillColor:"#ff0000",renderer:t};return L.polygon(this.option.fmtClip,o).addTo(r),e.clipLayer=t,S(e)},this.getLeafletIsosurface=function(r,e){if(br()){var t=I(this.fmtLatlngsIsosurface,"polygon",r,e);return L.featureGroup(t)}},this.getLeafletIsoline=function(r,e){if(!br())return!1;var t=I(this.fmtLatlngsIsoline,"polyline",r,e);return L.featureGroup(t)},this.getLeafletIsoImage=function(r,e){if(!br())return!1;var t=this.fmtLatlngsIsosurface,o=this.fmtLatlngsIsoline,n=I(t,"polygon",r,e),i=I(o,"polyline",r,e),a=n.concat(i);return L.featureGroup(a)},this.getLeafletLegend=function(r){if(!br())return!1;r=Object.assign({},{position:"bottomleft",gradient:!0},r);var e=M(this.option.level||[],r);return!!e&&(r.canvas=e,function(r){return L.Control.IsoLegendCortrol||(L.Control.IsoLegendCortrol=L.Control.extend({options:{position:"bottomleft",canvas:""},initialize:function(r){L.Util.extend(this.options,r)},onAdd:function(){return this._container=L.DomUtil.create("div","leaflet-control-iso-legend"),this._container.appendChild(this.options.canvas),this._container}})),new L.Control.IsoLegendCortrol(r)}(r))}}return xr.prototype={constructor:xr,initialize:function(r,e,t){var o=e.extent,n=e.level;if(!o)return console.log("缺少参数extent(画布左上右下坐标)");if(!n)return console.log("缺少参数level(色阶)");n=function(r){for(var e=0,t=r.length;e<t;e++){var o=r[e].color;r[e].r=parseInt(o.substr(1,2),16),r[e].g=parseInt(o.substr(3,2),16),r[e].b=parseInt(o.substr(5,2),16)}return r}(n);var i=[vr(o[0][0],o[1][0]),vr(o[0][1],o[1][1]),dr(o[0][0],o[1][0]),dr(o[0][1],o[1][1])],a=[o[1][0]-o[0][0],o[1][1]-o[0][1]],s=e.cellWidth||wr(yr(a[0])/200*1e6)/1e6;gr&&(s*=3);var l=Object.assign({},mr,e.keyConfig);this.option={worker:e.worker,type:e.type||"idw",pow:e.pow||3,model:e.model||"spherical",clip:e.clip,fmtClip:C(JSON.parse(JSON.stringify(e.clip)),2,l.clipX,l.clipY),smooth:e.smooth,ex:o,extent:i,size:a,cellWidth:s,level:n,key:l};var f=[],u=[],h=[];if(c(r))for(var p=0,g=r.length;p<g;p++)if(null!=r[p][l.v]){var v=r[p][l.v],d=r[p][l.x],y=r[p][l.y];f.push({x:d,y:y,v:v}),u.push(v),h.push(y)}this.points=f,this._v=u,this._y=h;var w=this;if(e.worker&&window.Worker&&!gr){var m=new Worker(e.worker+"/turf.js");return m.onmessage=function(r){w.pointGrid=r.data,w.calcGridValue(),t&&w.initReady(t)},m.postMessage(["pointGrid",i,s,{units:"degrees"}]),!1}this.pointGrid=function(r,e,t){if(!F(t=t||{}))throw new Error("options is invalid");var o=t.mask,n=t.properties,i=[];if(null==e)throw new Error("cellSide is required");if(!R(e))throw new Error("cellSide is invalid");if(!r)throw new Error("bbox is required");if(!Array.isArray(r))throw new Error("bbox must be array");if(4!==r.length)throw new Error("bbox must contain 4 numbers");if(o&&-1===["Polygon","MultiPolygon"].indexOf(Y(o)))throw new Error("options.mask must be a (Multi)Polygon");for(var a=r[0],s=r[1],l=r[2],f=r[3],u=e/tr([a,s],[l,s],t)*(l-a),c=e/tr([a,s],[a,f],t)*(f-s),h=l-a,p=f-s,g=Math.floor(h/u),v=(p-Math.floor(p/c)*c)/2,d=a+(h-g*u)/2;d<=l;){for(var y=s+v;y<=f;){var w=T([d,y],n);o?$(w,o)&&i.push(w):i.push(w),y+=c}d+=u}return q(i)}(i,s,{units:"degrees"}),this.calcGridValue(),t&&this.initReady(t)},calcGridValue:function(){var r=this.option,e=this.pointGrid,t=this._v,o=this._x,n=this._y,a=r.model;switch(r.type){case"kriging":if(r.worker&&window.Worker&&!gr){var s=new Worker(r.worker+"/"+r.type+".js"),l=this;return s.onmessage=function(r){l.pointGrid=r.data,this._x=x,l.pointGridState=!0,l.calcIso()},s.postMessage([e,t,o,n,a,.1,100]),!1}for(var f=i.train(t,o,n,a,.1,100),u=0;u<e.features.length;u++){var c=i.predict(e.features[u].geometry.coordinates[0],e.features[u].geometry.coordinates[1],f);e.features[u].properties.val=c}this.pointGridState=!0,this.calcIso();break;default:var h=this.points;if(r.worker&&window.Worker&&!gr){var p=new Worker(r.worker+"/"+r.type+".js");l=this;return p.onmessage=function(r){l.pointGrid=r.data,l.pointGridState=!0,l.calcIso()},p.postMessage([h,e,r.pow]),!1}this.pointGrid=function(r,e,t){null==t&&(t=3);var o=e.features;if(r.length<3)return e;for(var n=r.length,i=o.length,a=[],s=0;s<i;s++)for(var l=0;l<n;l++){var f=Math.sqrt(Math.pow(o[s].geometry.coordinates[0]-r[l].x,2)+Math.pow(o[s].geometry.coordinates[1]-r[l].y,2));a.push(f)}for(s=0;s<i;s++){var u=!1;for(l=n*s;l<n*s+n;l++)if(Math.abs(a[l])<1e-4){o[s].properties.val=r[l-n*s].v,u=!0;break}if(!u){var c=0,h=0;for(l=n*s;l<n*s+n;l++)c+=r[l-n*s].v/Math.pow(a[l],t),h+=1/Math.pow(a[l],t);o[s].properties.val=c/h}}return e}(h,e,r.pow),this.pointGridState=!0,this.calcIso()}},calcIso:function(){for(var r=this.option,e=this.pointGrid,t=r.level,o=[],n=this,i=0,a=t.length;i<a;i++)o.push(t[i].value);if(r.worker&&window.Worker&&!gr){var s=new Worker(r.worker+"/turf.js");n=this;return s.onmessage=function(o){var i=o.data;n.isoline=i,n.isosurface=m(i,r.extent,e,t),n.fmtLatlngsIsoline=P(n.isoline),n.fmtLatlngsIsosurface=P(n.isosurface),n.isoLinesState=!0},s.postMessage(["isolines",e,o,{zProperty:"val"},t]),!1}var l=cr(e,o,{zProperty:"val"}),f=l.features;for(i=0,a=f.length;i<a;i++)for(var u=f[i].properties.val,c=0;t[c];c++)if(t[c].value==u){f[i].properties.color=t[c].color;break}this.isoline=l,this.isosurface=m(l,r.extent,e,t),this.fmtLatlngsIsoline=P(this.isoline),this.fmtLatlngsIsosurface=P(this.isosurface),this.isoLinesState=!0},alow:function(){return this.pointGrid&&this.isoline},initReady:function(r,e){var t=null,o=this;t=setInterval(function(){o.pointGridState&&o.isoLinesState&&(clearInterval(t),r&&r(o,e))},10)},remove:function(){for(var r in this)delete this[r];return this}},xr.merge=function(r,e,t){var o=c(r)?r:[],n=Object.assign({},{width:800,height:600,child:[]},e);if(!t||!o.length||!n.child.length)return!1;var i=n.child,a=0,s=n.width,l=n.height,f=document.createElement("canvas");f.width=s,f.height=l;var u=f.getContext("2d");u.clearRect(0,0,s,l);for(var h=0,p=i.length;h<p;h++){var g=i[h],v=o[g.target];v&&(a++,v[g.type]&&v.initReady(function(r,e){var o=r[e.type](e.config,1),n=e.scale||1;a--;var i=u.createPattern(o,"no-repeat");if(u.fillStyle=i,u.save(),u.translate(e.x,e.y),u.scale(n,n),u.fillRect(0,0,o.width,o.height),u.restore(),!a)return t(f)},g))}},xr});
