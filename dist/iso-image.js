!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t=t||self).IsoImage=r()}(this,function(){"use strict";Object.assign||(Object.assign=function(t){for(var r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];for(var o,n=Object(t),i=Object.prototype.hasOwnProperty,s=0,a=r.length;s<a;s++)for(var l in o=Object(r[s]))i.call(o,l)&&(n[l]=o[l]);return n});var t=Math.max,r=Math.min,e=Math.abs,o=Math.floor;function n(t){return t=Number(t),isNaN(t)?0:0===t||t===1/0||t===-1/0?t:(t<0?-1:1)*o(e(t))}Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var t,r;for(t=0,r=0;t<this.length;t++)r+=this[t];return r/this.length},Array.prototype.fill=function(e){var o=arguments[1],i=arguments[2],s=function(t){if(null==t)throw TypeError();return Object(t)}(this),a=function(t){var e=n(t);return e<=0?0:e===1/0?9007199254740991:r(e,9007199254740991)}(s.length);a=t(a,0);var l,h,u,c=n(o);for(l=c<0?t(a+c,0):r(c,a),u=(h=void 0===i?a:n(i))<0?t(a+h,0):r(h,a);l<u;){s[String(l)]=e,l+=1}return s},Array.prototype.rep=function(t){return Array.apply(null,new Array(t)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(t,r){var e,o,n=!1;for(e=0,o=this.length-1;e<this.length;o=e++)this[e][1]>r!=this[o][1]>r&&t<(this[o][0]-this[e][0])*(r-this[e][1])/(this[o][1]-this[e][1])+this[e][0]&&(n=!n);return n};var i=function(){var t={},r=function(t,r){var e,o=new Array(r*r).fill(0);for(e=0;e<r;e++)o[e*r+e]=t;return o},e=function(t,r,e,o){var n,i,s=Array(e*o);for(n=0;n<e;n++)for(i=0;i<o;i++)s[n*o+i]=t[n*o+i]+r[n*o+i];return s},o=function(t,r,e,o,n){var i,s,a,l=Array(e*n);for(i=0;i<e;i++)for(s=0;s<n;s++)for(l[i*n+s]=0,a=0;a<o;a++)l[i*n+s]+=t[i*o+a]*r[a*n+s];return l},n=function(t,r){var e,o,n,i=Array(r);for(e=0;e<r;e++)i[e]=t[e*r+e];for(e=0;e<r;e++){for(o=0;o<e;o++)i[e]-=t[e*r+o]*t[e*r+o];if(i[e]<=0)return!1;for(i[e]=Math.sqrt(i[e]),o=e+1;o<r;o++){for(n=0;n<e;n++)t[o*r+e]-=t[o*r+n]*t[e*r+n];t[o*r+e]/=i[e]}}for(e=0;e<r;e++)t[e*r+e]=i[e];return!0},i=function(t,r){var e,o,n,i;for(e=0;e<r;e++)for(t[e*r+e]=1/t[e*r+e],o=e+1;o<r;o++){for(i=0,n=e;n<o;n++)i-=t[o*r+n]*t[n*r+e];t[o*r+e]=i/t[o*r+o]}for(e=0;e<r;e++)for(o=e+1;o<r;o++)t[e*r+o]=0;for(e=0;e<r;e++){for(t[e*r+e]*=t[e*r+e],n=e+1;n<r;n++)t[e*r+e]+=t[n*r+e]*t[n*r+e];for(o=e+1;o<r;o++)for(n=o;n<r;n++)t[e*r+o]+=t[n*r+e]*t[n*r+o]}for(e=0;e<r;e++)for(o=0;o<e;o++)t[e*r+o]=t[o*r+e]},s=function(t,r){var e,o,n,i,s,a,l,h,u,c,f,p=r,g=Array(r*r),v=Array(r),d=Array(r),y=Array(r);for(e=0;e<r;e++)for(i=0;i<r;i++)g[e*r+i]=e==i?1:0;for(i=0;i<r;i++)y[i]=0;for(e=0;e<r;e++){for(h=0,i=0;i<r;i++)if(1!=y[i])for(s=0;s<r;s++)0==y[s]&&Math.abs(t[i*r+s])>=h&&(h=Math.abs(t[i*r+s]),n=i,o=s);if(++y[o],n!=o){for(a=0;a<r;a++)f=t[n*r+a],t[n*r+a]=t[o*r+a],t[o*r+a]=f;for(a=0;a<p;a++)f=g[n*r+a],g[n*r+a]=g[o*r+a],g[o*r+a]=f}if(d[e]=n,v[e]=o,0==t[o*r+o])return!1;for(c=1/t[o*r+o],t[o*r+o]=1,a=0;a<r;a++)t[o*r+a]*=c;for(a=0;a<p;a++)g[o*r+a]*=c;for(l=0;l<r;l++)if(l!=o){for(u=t[l*r+o],t[l*r+o]=0,a=0;a<r;a++)t[l*r+a]-=t[o*r+a]*u;for(a=0;a<p;a++)g[l*r+a]-=g[o*r+a]*u}}for(a=r-1;a>=0;a--)if(d[a]!=v[a])for(s=0;s<r;s++)f=t[s*r+d[a]],t[s*r+d[a]]=t[s*r+v[a]],t[s*r+v[a]]=f;return!0},a=function(t,r,e,o,n){return r+(o-r)/e*(1-Math.exp(-1/n*Math.pow(t/e,2)))},l=function(t,r,e,o,n){return r+(o-r)/e*(1-Math.exp(-1/n*(t/e)))},h=function(t,r,e,o,n){return t>e?r+(o-r)/e:r+(o-r)/e*(t/e*1.5-.5*Math.pow(t/e,3))};return t.train=function(t,u,c,f,p,g){var v={t:t,x:u,y:c,nugget:0,range:0,sill:0,A:1/3,n:0};switch(f){case"gaussian":v.model=a;break;case"exponential":v.model=l;break;case"spherical":v.model=h}var d,y,m,w,b=t.length,x=Array((b*b-b)/2);for(d=0,m=0;d<b;d++)for(y=0;y<d;y++,m++)x[m]=Array(2),x[m][0]=Math.pow(Math.pow(u[d]-u[y],2)+Math.pow(c[d]-c[y],2),.5),x[m][1]=Math.abs(t[d]-t[y]);x.sort(function(t,r){return t[0]-r[0]}),v.range=x[(b*b-b)/2-1][0];var M=(b*b-b)/2>30?30:(b*b-b)/2,E=v.range/M,L=new Array(M).fill(0),k=new Array(M).fill(0);if(M<30)for(w=0;w<M;w++)L[w]=x[w][0],k[w]=x[w][1];else{for(d=0,y=0,m=0,w=0;d<M&&y<(b*b-b)/2;d++,m=0){for(;x[y][0]<=(d+1)*E&&(L[w]+=x[y][0],k[w]+=x[y][1],m++,!(++y>=(b*b-b)/2)););m>0&&(L[w]/=m,k[w]/=m,w++)}if(w<2)return v}b=w,v.range=L[b-1]-L[0];var A=new Array(2*b).fill(1),P=Array(b),C=v.A;for(d=0;d<b;d++){switch(f){case"gaussian":A[2*d+1]=1-Math.exp(-1/C*Math.pow(L[d]/v.range,2));break;case"exponential":A[2*d+1]=1-Math.exp(-1/C*L[d]/v.range);break;case"spherical":A[2*d+1]=L[d]/v.range*1.5-.5*Math.pow(L[d]/v.range,3)}P[d]=k[d]}var S=function(t,r,e){var o,n,i=Array(e*r);for(o=0;o<r;o++)for(n=0;n<e;n++)i[n*r+o]=t[o*e+n];return i}(A,b,2),z=o(S,A,2,b,2),O=(z=e(z,r(1/g,2),2,2)).slice(0);n(z,2)?i(z,2):(s(O,2),z=O);var I=o(o(z,S,2,2,b),P,2,b,1);v.nugget=I[0],v.sill=I[1]*v.range+v.nugget,v.n=u.length,b=u.length;var T=Array(b*b);for(d=0;d<b;d++){for(y=0;y<d;y++)T[d*b+y]=v.model(Math.pow(Math.pow(u[d]-u[y],2)+Math.pow(c[d]-c[y],2),.5),v.nugget,v.range,v.sill,v.A),T[y*b+d]=T[d*b+y];T[d*b+d]=v.model(0,v.nugget,v.range,v.sill,v.A)}var _=e(T,r(p,b),b,b),j=_.slice(0);n(_,b)?i(_,b):(s(j,b),_=j);T=_.slice(0);var q=o(_,t,b,b,1);return v.K=T,v.M=q,v},t.predict=function(t,r,e){var n,i=Array(e.n);for(n=0;n<e.n;n++)i[n]=e.model(Math.pow(Math.pow(t-e.x[n],2)+Math.pow(r-e.y[n],2),.5),e.nugget,e.range,e.sill,e.A);return o(i,e.M,1,e.n,1)[0]},t}(),s=function(t,r){for(var e=t[0],o=t[1],n=!1,i=0,s=r.length-1;i<r.length;s=i++){var a=r[i][0],l=r[i][1],h=r[s][0],u=r[s][1];l>o!=u>o&&e<(h-a)*(o-l)/(u-l)+a&&(n=!n)}return n},a=function(t){return JSON.parse(JSON.stringify(t))},l=function(t,r){return t[0]==r[0]&&t[1]==r[1]},h=function(t,r){return Math.abs(t-r)},u=Object.prototype.toString,c=function(t){return"[object Array]"===u.call(t)},f=function(t,r,e,o,n,i,s){s=s||[];for(var h,u,c,p,g=o[o.length-1],v="t"==n||"b"==n?0:1,d="t"==n||"l"==n?1:-1,y=i?-1:1,m=0;e[n][m];m++){var w=e[n][m],b=(w.p[v]-g[v])*d*y;b>0&&(!h||h&&u>b)&&(h=w,u=b)}if(h)l(h.p,o[0])?o.push(h.p):(p=a(t[h.coor].coor),h.d&&p.reverse(),o=o.concat(p)),c=h.t;else if(i)switch(n){case"t":o.push(r.sa),c="l";break;case"r":o.push(r.sb),c="t";break;case"b":o.push(r.sc),c="r";break;case"l":o.push(r.sd),c="b"}else switch(n){case"t":o.push(r.sb),c="r";break;case"r":o.push(r.sc),c="b";break;case"b":o.push(r.sd),c="l";break;case"l":o.push(r.sa),c="t"}return o.length>1&&l(o[0],o[o.length-1])?[o].concat(s):(h&&p&&(s=f(t,r,e,p,c,!i,s)),o=f(t,r,e,o,c,i,s))},p=function(t,r,e){for(var o=!1,n=0,i=t.length;n<i;n++){if(r<t[n].value){if(!o){o=JSON.parse(JSON.stringify(t[n]));break}var s=(r-o.value)/(t[n].value-o.value),a=function(r){return e?parseInt(o[r]+(t[n][r]-o[r])*s):t[n][r]};o.r=a("r"),o.g=a("g"),o.b=a("b");break}o=JSON.parse(JSON.stringify(t[n]))}return o},g=Math.abs,v=Math.max,d=Math.min,y=Math.floor,m=function(t,r){for(var e=0,o=v(h(r[0],r[2]),h(r[1],r[3])),n=0;n<4;n++){var i=h(r[n],t[n%2]);i<o&&(o=i,e=n)}return"lbrt".charAt(e)};function w(t,r,e,o){for(var n,i=[],h=[],u={t:[],b:[],l:[],r:[]},c=t.features,w=0,b=c.length;w<b;w++)for(var x=c[w],M=0,E=(X=x.geometry.coordinates).length;M<E;M++){var L=X[M],k=L[0],A=L[L.length-1];if(l(k,A))i.push({coor:L,properties:x.properties,child:[],parent:[],i:i.length});else{h.push({coor:L,properties:x.properties});var P=m(k,r),C=m(A,r);u[P].push({p:k,end:A,d:0,t:C,coor:h.length-1}),u[C].push({p:A,end:k,d:1,t:P,coor:h.length-1})}}for(var S={sa:[r[0],r[3]],sb:[r[2],r[3]],sc:[r[2],r[1]],sd:[r[0],r[1]]},z=(w=0,(n=f(h,S,u,[S.sa],"t",!1)).length);w<z;w++)i.push({coor:n[w],properties:{type:"open"},child:[],parent:[],i:i.length});for(w=0,b=i.length;w<b;w++)for(var O=w+1;O<b;O++){var I=i[w].properties.type,T=i[O].properties.type;"open"!=I&&s(i[w].coor[0],i[O].coor)?(i[O].child.push(w),i[w].parent.push(O)):"open"!=T&&s(i[O].coor[0],i[w].coor)&&(i[w].child.push(O),i[O].parent.push(w))}var _=a(i),j=[],q=[],N=[],G=function(){if(!_.length)return!1;for(var t=[],r=0,e=_.length;r<e;r++){for(var o=_[r],n=o.child,i=1,s=n.length-1;s>-1;s--)-1==q.indexOf(n[s])&&(i=0);if(i){var a=[];for(s=n.length-1;s>-1;s--){var l=N.indexOf(n[s]);l>-1&&(a.push(n[s]),N.splice(l,1))}N.push(o.i),q.push(o.i),_[r].child=a,j.push(_[r])}else t.push(_[r])}if(!t.length)return!1;_=t,G()};G();var R=[],U=e.features,F=U.length,W=U[0].geometry.coordinates,D=1,B=1,V=1;for(w=0;w<F;w++){var J=U[w].geometry.coordinates;if(1==w&&(V=g(J[1]-W[1])),J[0]!=W[0]){D=w,B=g(J[0]-W[0]);break}}for(w=0,b=j.length;w<b;w++){for(var X,Y=[(X=j[w]).coor],K="rgba(0, 0, 0, 0)",Q=(O=0,X.child.length);O<Q;O++)Y.push(i[X.child[O]].coor);var H,Z=y(X.coor.length/2),$=X.coor[Z],tt=($[0]-W[0])/B,rt=v(y(tt)*D+y(($[1]-W[1])/V),0),et=tt%1?0:1,ot=et?1:D,nt=et?V:B,it=nt/100;if(U[rt]&&U[rt+ot]){var st=U[rt].geometry.coordinates,at=U[rt+ot].geometry.coordinates,lt=Object.assign([],$,[]);lt[et]=v($[et]-it,st[et]);var ht=U[rt].properties.val,ut=U[rt+ot].properties.val;s(lt,X.coor)||(lt[et]=d($[et]+2*it,at[et])),s(lt,X.coor)&&(H=ht+(ut-ht)*(g(lt[et]-U[rt].geometry.coordinates[et])/nt))}else U[rt]&&(H=U[rt].properties.val);if(null!=H){var ct=p(o,H,!1);K="rgb("+ct.r+","+ct.g+","+ct.b+")",H=ct.value}R.push({geometry:{coordinates:Y,type:"MultiLineString"},properties:{val:H,color:K},type:"Feature"})}return{features:R,type:"FeatureCollection"}}var b={direction:"vertical",backgroundColor:"#fff",color:"#333",gradient:!0};function x(t,r){if(t.legend<2)return!1;var e=(r=Object.assign({},b,r)).gradient?1:0,o="horizontal"==r.direction?0:1,n=r.title||"",i=r.shape||"rect",s=document.createElement("canvas"),a=o?120:340;e||(a+=20);var l=o?240:50;s.width=a,s.height=l;var h=o?[15,30,20,200]:[70,5,200,20],u=o?[h[0],h[1]+h[3],h[0],h[1]]:[h[0],h[1],h[0]+h[2],h[1]],c=s.getContext("2d");c.lineWidth=1,c.strokeStyle="#999",c.fillStyle=r.backgroundColor,c.fillRect(0,0,a,l),c.font="12px 微软雅黑",c.textBaseline="middle",c.textAlign="start",c.fillStyle=r.color;for(var f=c.createLinearGradient(u[0],u[1],u[2],u[3]),p=0,g=t.length;p<g;p++){var v=t[p].color,d=t[p].unit||"",y=t[p].value+d,m=1/(g-1)*p;if(!e&&p>0&&p<g-1){var w=t[p-1].color;f.addColorStop(m,w),f.addColorStop(m,v)}else f.addColorStop(m,v);if(o)c.fillText(y,h[0]+h[2]+5,h[1]+h[3]*(1-m));else if(!p||p==g-1){var x=c.measureText(y).width,M=h[1]+h[3]/2,E=p?h[0]+h[2]+5:h[0]-5-x;c.fillText(y,E,M)}}switch(c.fillStyle=f,i){case"triangle-rect":if(o){var L=h[2]/2;c.beginPath(),c.moveTo(h[0]+L,h[1]),c.lineTo(h[0]+h[2],h[1]+L),c.lineTo(h[0]+h[2],h[1]+h[3]-L),c.lineTo(h[0]+L,h[1]+h[3]),c.lineTo(h[0],h[1]+h[3]-L),c.lineTo(h[0],h[1]+L),c.lineTo(h[0]+L,h[1]),c.stroke(),c.fill()}else{L=h[3]/2;c.beginPath(),c.moveTo(h[0],h[1]+L),c.lineTo(h[0]+L,h[1]),c.lineTo(h[0]+h[2]-L,h[1]),c.lineTo(h[0]+h[2],h[1]+L),c.lineTo(h[0]+h[2]-L,h[1]+h[3]),c.lineTo(h[0]+L,h[1]+h[3]),c.lineTo(h[0],h[1]+L),c.stroke(),c.fill()}break;default:c.fillRect(h[0],h[1],h[2],h[3])}return n.length&&(c.font="14px 微软雅黑",c.fillStyle=r.color,c.textBaseline="top",o?(c.textAlign="start",c.fillText(n,5,5)):(c.textAlign="center",c.fillText(n,a/2,h[1]+h[3]+5))),s}function M(t,r,e,o){var n=null==(o=o||{}).gradient||o.gradient,i=t.size,s=t.cellWidth,a=t.level,l=t.ex,h=o.filter,u=o.width||1e3,c=Math.abs(u/i[0]*i[1]),f=document.createElement("canvas");f.width=u,f.height=c;var g=f.getContext("2d");if(g.clearRect(0,0,u,c),n)for(var v=r.features,d=i[0]/s>1?v[Math.abs(Math.ceil(i[1]/s))+1].geometry.coordinates[0]-v[0].geometry.coordinates[0]:s,y=i[1]/s>1?v[1].geometry.coordinates[1]-v[0].geometry.coordinates[1]:s,m=Math.abs(d/i[0]*u),w=Math.abs(y/i[1]*c),b=0,x=v.length;b<x;b++){var M=v[b].geometry.coordinates,E=(M[0]-l[0][0])/i[0]*u-m/2,L=(M[1]-l[0][1])/i[1]*c-w/2,k=p(a,v[b].properties.val,n),A=k.value;h&&h.indexOf&&-1==h.indexOf(A)||(g.strokeStyle=g.fillStyle="rgb("+k.r+","+k.g+","+k.b+")",g.beginPath(),g.fillRect(E-1,L-1,m+2,w+2))}else{var P=e.features;for(b=0,x=P.length;b<x;b++){A=P[b].properties.val;if(!h||!h.indexOf||-1!=h.indexOf(A)){var C=P[b].geometry.coordinates;g.strokeStyle=g.fillStyle=P[b].properties.color,g.beginPath();for(var S=0,z=C.length;S<z;S++)for(var O=0,I=C[S].length;O<I;O++){E=(C[S][O][0]-l[0][0])/i[0]*u,L=(C[S][O][1]-l[0][1])/i[1]*c;g[O?"lineTo":"moveTo"](E,L)}g.fill("evenodd")}}}return f}function E(t,r,e){e=e||{};var o=t.size,n=t.ex,i=e.width||1e3,s=Math.abs(i/o[0]*o[1]),a=e.isolineColor||"#333",l=e.filter,h=document.createElement("canvas");h.width=i,h.height=s;var u=h.getContext("2d");u.clearRect(0,0,i,s),u.lineWidth=1,u.font="12px 微软雅黑",u.textBaseline="middle",u.textAlign="center";for(var c=r.features,f={},p=0,g=c.length;p<g;p++){var v=c[p].properties.val;if(!l||!l.indexOf||-1!=l.indexOf(v)){var d=c[p].geometry.coordinates,y="level"==a?c[p].properties.color:a;u.strokeStyle=u.fillStyle=y;for(var m=0,w=d.length;m<w;m++){u.beginPath();for(var b=0,x=0,M=d[m].length;x<M;x++){var E=(d[m][x][0]-n[0][0])/o[0]*i,L=(d[m][x][1]-n[0][1])/o[1]*s;u[x?"lineTo":"moveTo"](E,L);var k=Math.round(E/16)+"-"+Math.round(L/16);f[k]||b||(f[k]=1,b=1,u.fillText(v,E,L))}u.stroke()}}}return h}function k(t,r,e){if(!t[0])return!1;var o=(e=e||{}).opacity||1,n=t[0].width,i=t[0].height,s=document.createElement("canvas");s.width=n,s.height=i;var a=s.getContext("2d");a.clearRect(0,0,n,i),a.globalAlpha=o,a.strokeStyle=e.clipColor||"#333",a.lineWidth=e.clipWidth||1;var l=r.clip;if(l&&c(l)){var h=r.ex,u=r.size,f=r.key||{},p=f.clipX||0,g=f.clipY||1;a.beginPath();var v=function(t){if(c(t[0])&&c(t[0][0])){for(var r=0,e=t.length;r<e;r++)v(t[r]);return!1}if(c(t))for(r=0,e=t.length;r<e;r++){var o=(t[r][p]-h[0][0])/u[0]*n,s=(t[r][g]-h[0][1])/u[1]*i;a[r?"lineTo":"moveTo"](o,s)}};v(l),e.clip&&a.stroke(),a.clip()}for(var d=0;t[d];d++){var y=a.createPattern(t[d],"no-repeat");a.fillStyle=y,a.fillRect(0,0,n,i)}return s}var A=function(t,r,e,o){if(void 0===o&&(o=1),void 0===e&&(e=0),!r)return[t[o],t[e]];r--;for(var n=0,i=t.length;n<i;n++)t[n]=A(t[n],r);return t},P=function(t){for(var r=a(t),e=0,o=r.features.length;e<o;e++){var n=r.features[e].geometry.coordinates;r.features[e].geometry.coordinates=A(n,2)}return r},C=function(t){return L.IsoImageCanvasLayer||(L.IsoImageCanvasLayer=L.Canvas.extend({_initContainer:function(){var t=this._container=document.createElement("canvas");this._container.style.opacity=0,L.DomEvent.on(t,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this),L.DomEvent.on(t,"click dblclick mousedown mouseup contextmenu",this._onClick,this),L.DomEvent.on(t,"mouseout",this._handleMouseOut,this),this._ctx=t.getContext("2d")},_draw:function(){var t,r=this._redrawBounds,e=this._ctx;if(e.save(),r){var o=r.getSize();e.beginPath(),e.rect(r.min.x,r.min.y,o.x,o.y),e.clip()}this._drawing=!0;for(var n=this._drawFirst;n;n=n.next)t=n.layer,(!r||t._pxBounds&&t._pxBounds.intersects(r))&&t._updatePath();this._drawing=!1,e.restore(),this.options.clipLayer&&this.options.clipLayer._clip(e)}})),new L.IsoImageCanvasLayer(t)},S=function(t){return L.ClipCanvasLayer||(L.ClipCanvasLayer=L.Canvas.extend({_initContainer:function(){var t=this._container=document.createElement("canvas");L.DomEvent.on(t,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this),L.DomEvent.on(t,"click dblclick mousedown mouseup contextmenu",this._onClick,this),L.DomEvent.on(t,"mouseout",this._handleMouseOut,this),this._ctx=t.getContext("2d")},_clip:function(t){var r=this._ctx;r.fillStyle=r.createPattern(t.canvas,"no-repeat"),r.beginPath();for(var e=this._drawFirst;e;e=e.next)for(var o=e.layer._parts,n=0,i=o.length;n<i;n++)for(var s=0,a=o[n].length;s<a;s++)r[s?"lineTo":"moveTo"](o[n][s].x,o[n][s].y);r.save(),r.translate(this._bounds.min.x,this._bounds.min.y),r.fill(),r.restore()}})),new L.ClipCanvasLayer(t)};function z(t,r,e,o){if(!t||!e)return!1;for(var n=[],i=o.filter,s=0;t.features[s];s++){var a=t.features[s],l=a.properties.val;if(!(i&&i.indexOf&&-1==i.indexOf(l)||!a.geometry.coordinates.length)){var h=Object.assign({},{stroke:!0,weight:1,opacity:.7,fillOpacity:.7,color:a.properties.color,fillColor:a.properties.color,renderer:e,smoothFactor:.5},o),u=L[r](a.geometry.coordinates,h);n.push(u)}}return n}var O={meters:6371008.8,metres:6371008.8,millimeters:6371008800,millimetres:6371008800,centimeters:637100880,centimetres:637100880,kilometers:6371.0088,kilometres:6371.0088,miles:3958.761333810546,nauticalmiles:6371008.8/1852,inches:6371008.8*39.37,yards:6371008.8/1.0936,feet:20902260.511392,radians:1,degrees:6371008.8/111325};function I(t,r,e){if(!R(e=e||{}))throw new Error("options is invalid");var o=e.bbox,n=e.id;if(void 0===t)throw new Error("geometry is required");if(r&&r.constructor!==Object)throw new Error("properties must be an Object");o&&U(o),n&&F(n);var i={type:"Feature"};return n&&(i.id=n),o&&(i.bbox=o),i.properties=r||{},i.geometry=t,i}function T(t,r,e){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!G(t[0])||!G(t[1]))throw new Error("coordinates must contain numbers");return I({type:"Point",coordinates:t},r,e)}function _(t,r,e){if(!t)throw new Error("coordinates is required");if(t.length<2)throw new Error("coordinates must be an array of two or more positions");if(!G(t[0][1])||!G(t[0][1]))throw new Error("coordinates must contain numbers");return I({type:"LineString",coordinates:t},r,e)}function j(t,r){if(!R(r=r||{}))throw new Error("options is invalid");var e=r.bbox,o=r.id;if(!t)throw new Error("No features passed");if(!Array.isArray(t))throw new Error("features must be an Array");e&&U(e),o&&F(o);var n={type:"FeatureCollection"};return o&&(n.id=o),e&&(n.bbox=e),n.features=t,n}function q(t,r,e){if(!t)throw new Error("coordinates is required");return I({type:"MultiLineString",coordinates:t},r,e)}function N(t){if(null==t)throw new Error("degrees is required");return t%360*Math.PI/180}function G(t){return!isNaN(t)&&null!==t&&!Array.isArray(t)}function R(t){return!!t&&t.constructor===Object}function U(t){if(!t)throw new Error("bbox is required");if(!Array.isArray(t))throw new Error("bbox must be an Array");if(4!==t.length&&6!==t.length)throw new Error("bbox must be an Array of 4 or 6 numbers");t.forEach(function(t){if(!G(t))throw new Error("bbox must only contain numbers")})}function F(t){if(!t)throw new Error("id is required");if(-1===["string","number"].indexOf(typeof t))throw new Error("id must be a number or a string")}function W(t,r,e){if(null!==t)for(var o,n,i,s,a,l,h,u,c=0,f=0,p=t.type,g="FeatureCollection"===p,v="Feature"===p,d=g?t.features.length:1,y=0;y<d;y++){a=(u=!!(h=g?t.features[y].geometry:v?t.geometry:t)&&"GeometryCollection"===h.type)?h.geometries.length:1;for(var m=0;m<a;m++){var w=0,b=0;if(null!==(s=u?h.geometries[m]:h)){l=s.coordinates;var x=s.type;switch(c=!e||"Polygon"!==x&&"MultiPolygon"!==x?0:1,x){case null:break;case"Point":r(l,f,y,w,b),f++,w++;break;case"LineString":case"MultiPoint":for(o=0;o<l.length;o++)r(l[o],f,y,w,b),f++,"MultiPoint"===x&&w++;"LineString"===x&&w++;break;case"Polygon":case"MultiLineString":for(o=0;o<l.length;o++){for(n=0;n<l[o].length-c;n++)r(l[o][n],f,y,w,b),f++;"MultiLineString"===x&&w++,"Polygon"===x&&b++}"Polygon"===x&&w++;break;case"MultiPolygon":for(o=0;o<l.length;o++){for("MultiPolygon"===x&&(b=0),n=0;n<l[o].length;n++){for(i=0;i<l[o][n].length-c;i++)r(l[o][n][i],f,y,w,b),f++;b++}w++}break;case"GeometryCollection":for(o=0;o<s.geometries.length;o++)W(s.geometries[o],r,e);break;default:throw new Error("Unknown Geometry Type")}}}}}function D(t){var r=[1/0,1/0,-1/0,-1/0];return W(t,function(t){r[0]>t[0]&&(r[0]=t[0]),r[1]>t[1]&&(r[1]=t[1]),r[2]<t[0]&&(r[2]=t[0]),r[3]<t[1]&&(r[3]=t[1])}),r}function B(t){if(!t)throw new Error("obj is required");var r=V(t);if(r.length>1&&G(r[0])&&G(r[1]))return r;throw new Error("Coordinate is not a valid Point")}function V(t){if(!t)throw new Error("obj is required");var r;if(t.length?r=t:t.coordinates?r=t.coordinates:t.geometry&&t.geometry.coordinates&&(r=t.geometry.coordinates),r)return function t(r){if(r.length>1&&G(r[0])&&G(r[1]))return!0;if(Array.isArray(r[0])&&r[0].length)return t(r[0]);throw new Error("coordinates must only contain numbers")}(r),r;throw new Error("No valid coordinates")}function J(t,r,e){if(!t)throw new Error("No featureCollection passed");if(!e)throw new Error(".collectionOf() requires a name");if(!t||"FeatureCollection"!==t.type)throw new Error("Invalid input to "+e+", FeatureCollection required");for(var o=0;o<t.features.length;o++){var n=t.features[o];if(!n||"Feature"!==n.type||!n.geometry)throw new Error("Invalid input to "+e+", Feature with geometry required");if(!n.geometry||n.geometry.type!==r)throw new Error("Invalid input to "+e+": must be a "+r+", given "+n.geometry.type)}}function X(t){if(!t)throw new Error("geojson is required");if(void 0!==t.geometry)return t.geometry;if(t.coordinates||t.geometries)return t;throw new Error("geojson must be a valid Feature or Geometry Object")}function Y(t,r){if(!t)throw new Error((r||"geojson")+" is required");if(t.geometry&&t.geometry.type)return t.geometry.type;if(t.type)return t.type;throw new Error((r||"geojson")+" is invalid")}function K(t,r,e){var o=(e=e||{}).ignoreEndVertices;if(!R(e))throw new Error("invalid options");if(!t)throw new Error("pt is required");if(!r)throw new Error("line is required");for(var n=B(t),i=V(r),s=0;s<i.length-1;s++){var a=!1;if(o&&(0===s&&(a="start"),s===i.length-2&&(a="end"),0===s&&s+1===i.length-1&&(a="both")),Q(i[s],i[s+1],n,a))return!0}return!1}function Q(t,r,e,o){var n=e[0],i=e[1],s=t[0],a=t[1],l=r[0],h=r[1],u=l-s,c=h-a;return 0==(e[0]-s)*c-(e[1]-a)*u&&(o?"start"===o?Math.abs(u)>=Math.abs(c)?u>0?s<n&&n<=l:l<=n&&n<s:c>0?a<i&&i<=h:h<=i&&i<a:"end"===o?Math.abs(u)>=Math.abs(c)?u>0?s<=n&&n<l:l<n&&n<=s:c>0?a<=i&&i<h:h<i&&i<=a:"both"===o?Math.abs(u)>=Math.abs(c)?u>0?s<n&&n<l:l<n&&n<s:c>0?a<i&&i<h:h<i&&i<a:void 0:Math.abs(u)>=Math.abs(c)?u>0?s<=n&&n<=l:l<=n&&n<=s:c>0?a<=i&&i<=h:h<=i&&i<=a)}function H(t,r,e){if("object"!=typeof(e=e||{}))throw new Error("options is invalid");var o=e.ignoreBoundary;if(!t)throw new Error("point is required");if(!r)throw new Error("polygon is required");var n=B(t),i=V(r),s=r.geometry?r.geometry.type:r.type,a=r.bbox;if(a&&!1===function(t,r){return r[0]<=t[0]&&r[1]<=t[1]&&r[2]>=t[0]&&r[3]>=t[1]}(n,a))return!1;"Polygon"===s&&(i=[i]);for(var l=0,h=!1;l<i.length&&!h;l++)if(Z(n,i[l][0],o)){for(var u=!1,c=1;c<i[l].length&&!u;)Z(n,i[l][c],!o)&&(u=!0),c++;u||(h=!0)}return h}function Z(t,r,e){var o=!1;r[0][0]===r[r.length-1][0]&&r[0][1]===r[r.length-1][1]&&(r=r.slice(0,r.length-1));for(var n=0,i=r.length-1;n<r.length;i=n++){var s=r[n][0],a=r[n][1],l=r[i][0],h=r[i][1];if(t[1]*(s-l)+a*(l-t[0])+h*(t[0]-s)==0&&(s-t[0])*(l-t[0])<=0&&(a-t[1])*(h-t[1])<=0)return!e;a>t[1]!=h>t[1]&&t[0]<(l-s)*(t[1]-a)/(h-a)+s&&(o=!o)}return o}function $(t,r){var e=Y(t),o=Y(r),n=X(t),i=X(r);switch(e){case"Point":switch(o){case"MultiPoint":return function(t,r){var e,o=!1;for(e=0;e<r.coordinates.length;e++)if(rt(r.coordinates[e],t.coordinates)){o=!0;break}return o}(n,i);case"LineString":return K(n,i,{ignoreEndVertices:!0});case"Polygon":return H(n,i,{ignoreBoundary:!0});default:throw new Error("feature2 "+o+" geometry not supported")}case"MultiPoint":switch(o){case"MultiPoint":return function(t,r){for(var e=0;e<t.coordinates.length;e++){for(var o=!1,n=0;n<r.coordinates.length;n++)rt(t.coordinates[e],r.coordinates[n])&&(o=!0);if(!o)return!1}return!0}(n,i);case"LineString":return function(t,r){for(var e=!1,o=0;o<t.coordinates.length;o++){if(!K(t.coordinates[o],r))return!1;e||(e=K(t.coordinates[o],r,{ignoreEndVertices:!0}))}return e}(n,i);case"Polygon":return function(t,r){for(var e=!0,o=0;o<t.coordinates.length;o++){var n=H(t.coordinates[1],r);if(!n){e=!1;break}n=H(t.coordinates[1],r,{ignoreBoundary:!0})}return e&&n}(n,i);default:throw new Error("feature2 "+o+" geometry not supported")}case"LineString":switch(o){case"LineString":return function(t,r){for(var e=0;e<t.coordinates.length;e++)if(!K(t.coordinates[e],r))return!1;return!0}(n,i);case"Polygon":return function(t,r){var e=D(r),o=D(t);if(!tt(e,o))return!1;for(var n=!1,i=0;i<t.coordinates.length-1;i++){if(!H(t.coordinates[i],r))return!1;if(n||(n=H(t.coordinates[i],r,{ignoreBoundary:!0})),!n){var s=(a=t.coordinates[i],l=t.coordinates[i+1],[(a[0]+l[0])/2,(a[1]+l[1])/2]);n=H(s,r,{ignoreBoundary:!0})}}var a,l;return n}(n,i);default:throw new Error("feature2 "+o+" geometry not supported")}case"Polygon":switch(o){case"Polygon":return function(t,r){var e=D(t);if(!tt(D(r),e))return!1;for(var o=0;o<t.coordinates[0].length;o++)if(!H(t.coordinates[0][o],r))return!1;return!0}(n,i);default:throw new Error("feature2 "+o+" geometry not supported")}default:throw new Error("feature1 "+e+" geometry not supported")}}function tt(t,r){return!(t[0]>r[0])&&(!(t[2]<r[2])&&(!(t[1]>r[1])&&!(t[3]<r[3])))}function rt(t,r){return t[0]===r[0]&&t[1]===r[1]}function et(t,r,e){if(!R(e=e||{}))throw new Error("options is invalid");var o=e.units,n=B(t),i=B(r),s=N(i[1]-n[1]),a=N(i[0]-n[0]),l=N(n[1]),h=N(i[1]),u=Math.pow(Math.sin(s/2),2)+Math.pow(Math.sin(a/2),2)*Math.cos(l)*Math.cos(h);return function(t,r){if(null==t)throw new Error("radians is required");if(r&&"string"!=typeof r)throw new Error("units must be a string");var e=O[r||"kilometers"];if(!e)throw new Error(r+" units is invalid");return t*e}(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),o)}var ot={successCallback:null,verbose:!1},nt={};function it(t,r,e){e=e||{};for(var o=Object.keys(ot),n=0;n<o.length;n++){var i=o[n],s=e[i];s=null!=s?s:ot[i],nt[i]=s}nt.verbose&&console.log("MarchingSquaresJS-isoContours: computing isocontour for "+r);var a=function(t){var r=[],e=0;t.rows,t.cols;return t.cells.forEach(function(o,n){o.forEach(function(o,i){if(void 0!==o&&5!==(f=o).cval&&10!==f.cval&&!at(o)){var s=function(t,r,e){var o,n,i,s=t.length,a=[],l=[0,0,1,1,0,0,0,0,-1,0,1,1,-1,0,-1,0],h=[0,-1,0,0,1,1,1,1,0,-1,0,0,0,-1,0,0],u=["none","bottom","right","right","top","top","top","top","left","bottom","right","right","left","bottom","left","none"],c=(t[r][e],t[r][e]),f=c.cval,p=ht(c,i=["none","left","bottom","left","right","none","bottom","left","top","top","none","top","right","right","bottom","none"][f]);a.push([e+p[0],r+p[1]]),p=ht(c,i=u[f]),a.push([e+p[0],r+p[1]]),lt(c);for(var g=e+l[f],v=r+h[f],d=f;g>=0&&v>=0&&v<s&&(g!=e||v!=r)&&void 0!==(c=t[v][g]);){if(0===(f=c.cval)||15===f)return{path:a,info:"mergeable"};i=u[f],o=l[f],n=h[f],5!==f&&10!==f||(5===f?c.flipped?-1===h[d]?(i="left",o=-1,n=0):(i="right",o=1,n=0):-1===l[d]&&(i="bottom",o=0,n=-1):10===f&&(c.flipped?-1===l[d]?(i="top",o=0,n=1):(i="bottom",o=0,n=-1):1===h[d]&&(i="left",o=-1,n=0))),p=ht(c,i),a.push([g+p[0],v+p[1]]),lt(c),g+=o,v+=n,d=f}return{path:a,info:"closed"}}(t.cells,n,i),a=!1;if("mergeable"===s.info)for(var l=s.path[s.path.length-1][0],h=s.path[s.path.length-1][1],u=e-1;u>=0;u--)if(Math.abs(r[u][0][0]-l)<=1e-7&&Math.abs(r[u][0][1]-h)<=1e-7){for(var c=s.path.length-2;c>=0;--c)r[u].unshift(s.path[c]);a=!0;break}a||(r[e++]=s.path)}var f})}),r}(function(t,r){for(var e=t.length-1,o=t[0].length-1,n={rows:e,cols:o,cells:[]},i=0;i<e;++i){n.cells[i]=[];for(var s=0;s<o;++s){var a=0,l=t[i+1][s],h=t[i+1][s+1],u=t[i][s+1],c=t[i][s];if(!(isNaN(l)||isNaN(h)||isNaN(u)||isNaN(c))){a|=l>=r?8:0,a|=h>=r?4:0,a|=u>=r?2:0;var f,p,g,v,d=!1;if(5===(a|=c>=r?1:0)||10===a){var y=(l+h+u+c)/4;5===a&&y<r?(a=10,d=!0):10===a&&y<r&&(a=5,d=!0)}if(0!==a&&15!==a)f=p=g=v=.5,1===a?(g=1-st(r,l,c),p=1-st(r,u,c)):2===a?(p=st(r,c,u),v=1-st(r,h,u)):3===a?(g=1-st(r,l,c),v=1-st(r,h,u)):4===a?(f=st(r,l,h),v=st(r,u,h)):5===a?(f=st(r,l,h),v=st(r,u,h),p=1-st(r,u,c),g=1-st(r,l,c)):6===a?(p=st(r,c,u),f=st(r,l,h)):7===a?(g=1-st(r,l,c),f=st(r,l,h)):8===a?(g=st(r,c,l),f=1-st(r,h,l)):9===a?(p=1-st(r,u,c),f=1-st(r,h,l)):10===a?(f=1-st(r,h,l),v=1-st(r,h,u),p=st(r,c,u),g=st(r,c,l)):11===a?(f=1-st(r,h,l),v=1-st(r,h,u)):12===a?(g=st(r,c,l),v=st(r,u,h)):13===a?(p=1-st(r,u,c),v=st(r,u,h)):14===a?(g=st(r,c,l),p=st(r,c,u)):console.log("MarchingSquaresJS-isoContours: Illegal cval detected: "+a),n.cells[i][s]={cval:a,flipped:d,top:f,right:v,bottom:p,left:g}}}}return n}(t,r));return"function"==typeof nt.successCallback&&nt.successCallback(a),a}function st(t,r,e){return(t-r)/(e-r)}function at(t){return 0===t.cval||15===t.cval}function lt(t){at(t)||5===t.cval||10===t.cval||(t.cval=15)}function ht(t,r){return"top"===r?[t.top,1]:"bottom"===r?[t.bottom,0]:"right"===r?[1,t.right]:"left"===r?[0,t.left]:void 0}function ut(t,r){if(!R(r=r||{}))throw new Error("options is invalid");var e=r.zProperty||"elevation",o=r.flip,n=r.flags;J(t,"Point","input must contain Points");for(var i=function(t,r){var e={};return function(t,r){if("Feature"===t.type)r(t,0);else if("FeatureCollection"===t.type)for(var e=0;e<t.features.length;e++)r(t.features[e],e)}(t,function(t){var r=V(t)[1];e[r]||(e[r]=[]),e[r].push(t)}),Object.keys(e).map(function(t){return e[t].sort(function(t,r){return V(t)[0]-V(r)[0]})}).sort(function(t,e){return r?V(t[0])[1]-V(e[0])[1]:V(e[0])[1]-V(t[0])[1]})}(t,o),s=[],a=0;a<i.length;a++){for(var l=i[a],h=[],u=0;u<l.length;u++){var c=l[u];c.properties[e]?h.push(c.properties[e]):h.push(0),!0===n&&(c.properties.matrixPosition=[a,u])}s.push(h)}return s}function ct(t,r,e){if(!R(e=e||{}))throw new Error("options is invalid");var o=e.zProperty||"elevation",n=e.commonProperties||{},i=e.breaksProperties||[];if(J(t,"Point","Input must contain Points"),!r)throw new Error("breaks is required");if(!Array.isArray(r))throw new Error("breaks must be an Array");if(!R(n))throw new Error("commonProperties must be an Object");if(!Array.isArray(i))throw new Error("breaksProperties must be an Array");var s=ut(t,{zProperty:o,flip:!0});return j(function(t,r,e){var o=D(e),n=o[2]-o[0],i=o[3]-o[1],s=o[0],a=o[1],l=r[0].length-1,h=r.length-1,u=n/l,c=i/h,f=function(t){t[0]=t[0]*u+s,t[1]=t[1]*c+a};return t.forEach(function(t){W(t,f)}),t}(function(t,r,e,o,n){for(var i=[],s=1;s<r.length;s++){var a=+r[s],l=Object.assign({},o,n[s]);l[e]=a;var h=q(it(t,a),l);i.push(h)}return i}(s,r,o,n,i),s,t))}var ft=function(t){this.points=t.points||[],this.duration=t.duration||1e4,this.sharpness=t.sharpness||.85,this.centers=[],this.controls=[],this.stepLength=t.stepLength||60,this.length=this.points.length,this.delay=0;for(var r=0;r<this.length;r++)this.points[r].z=this.points[r].z||0;for(r=0;r<this.length-1;r++){var e=this.points[r],o=this.points[r+1];this.centers.push({x:(e.x+o.x)/2,y:(e.y+o.y)/2,z:(e.z+o.z)/2})}this.controls.push([this.points[0],this.points[0]]);for(r=0;r<this.centers.length-1;r++){e=this.centers[r],o=this.centers[r+1];var n=this.points[r+1].x-(this.centers[r].x+this.centers[r+1].x)/2,i=this.points[r+1].y-(this.centers[r].y+this.centers[r+1].y)/2,s=this.points[r+1].z-(this.centers[r].y+this.centers[r+1].z)/2;this.controls.push([{x:(1-this.sharpness)*this.points[r+1].x+this.sharpness*(this.centers[r].x+n),y:(1-this.sharpness)*this.points[r+1].y+this.sharpness*(this.centers[r].y+i),z:(1-this.sharpness)*this.points[r+1].z+this.sharpness*(this.centers[r].z+s)},{x:(1-this.sharpness)*this.points[r+1].x+this.sharpness*(this.centers[r+1].x+n),y:(1-this.sharpness)*this.points[r+1].y+this.sharpness*(this.centers[r+1].y+i),z:(1-this.sharpness)*this.points[r+1].z+this.sharpness*(this.centers[r+1].z+s)}])}return this.controls.push([this.points[this.length-1],this.points[this.length-1]]),this.steps=this.cacheSteps(this.stepLength),this};function pt(t,r){if(!R(r=r||{}))throw new Error("options is invalid");var e=r.resolution||1e4,o=r.sharpness||.85;if(!t)throw new Error("line is required");if(!G(e))throw new Error("resolution must be an number");if(!G(o))throw new Error("sharpness must be an number");for(var n=[],i=new ft({points:X(t).coordinates.map(function(t){return{x:t[0],y:t[1]}}),duration:e,sharpness:o}),s=0;s<i.duration;s+=10){var a=i.pos(s);Math.floor(s/100)%2==0&&n.push([a.x,a.y])}return _(n,t.properties)}ft.prototype.cacheSteps=function(t){var r=[],e=this.pos(0);r.push(0);for(var o=0;o<this.duration;o+=10){var n=this.pos(o);Math.sqrt((n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y)+(n.z-e.z)*(n.z-e.z))>t&&(r.push(o),e=n)}return r},ft.prototype.vector=function(t){var r=this.pos(t+10),e=this.pos(t-10);return{angle:180*Math.atan2(r.y-e.y,r.x-e.x)/3.14,speed:Math.sqrt((e.x-r.x)*(e.x-r.x)+(e.y-r.y)*(e.y-r.y)+(e.z-r.z)*(e.z-r.z))}},ft.prototype.pos=function(t){var r=t-this.delay;r<0&&(r=0),r>this.duration&&(r=this.duration-1);var e=r/this.duration;if(e>=1)return this.points[this.length-1];var o=Math.floor((this.points.length-1)*e);return function(t,r,e,o,n){var i=function(t){var r=t*t;return[r*t,3*r*(1-t),3*t*(1-t)*(1-t),(1-t)*(1-t)*(1-t)]}(t);return{x:n.x*i[0]+o.x*i[1]+e.x*i[2]+r.x*i[3],y:n.y*i[0]+o.y*i[1]+e.y*i[2]+r.y*i[3],z:n.z*i[0]+o.z*i[1]+e.z*i[2]+r.z*i[3]}}((this.length-1)*e-o,this.points[o],this.controls[o][1],this.controls[o+1][0],this.points[o+1])};var gt=function(t,r,e){this.x=t||0,this.y=r||0,this.z=e||0};gt.prototype={constructor:gt,add:function(t,r){return void 0!==r?(console.warn("DEPRECATED: Vector3's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,r)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},subVectors:function(t,r){return this.x=t.x-r.x,this.y=t.y-r.y,this.z=t.z-r.z,this},distanceToSquared:function(t){var r=this.x-t.x,e=this.y-t.y;return r*r+e*e+(t=this.z-t.z)*t}};var vt=function(){var t=function(){};t.prototype={getPoint:function(){return console.log("Warning, getPoint() not implemented!"),null},getPointAt:function(t){return t=this.getUtoTmapping(t),this.getPoint(t)},getPoints:function(t){var r;t||(t=5);var e=[];for(r=0;r<=t;r++)e.push(this.getPoint(r/t));return e},getSpacedPoints:function(t){var r;t||(t=5);var e=[];for(r=0;r<=t;r++)e.push(this.getPointAt(r/t));return e},getLength:function(){var t=this.getLengths();return t[t.length-1]},getLengths:function(t){if(t||(t=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length==t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var r,e,o=[],n=this.getPoint(0),i=0;for(o.push(0),e=1;e<=t;e++)i+=(r=this.getPoint(e/t)).distanceTo(n),o.push(i),n=r;return this.cacheArcLengths=o},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(t,r){var e,o=this.getLengths(),n=0,i=o.length;e=r||t*o[i-1];for(var s,a=0,l=i-1;a<=l;)if(0>(s=o[n=Math.floor(a+(l-a)/2)]-e))a=n+1;else{if(!(0<s)){l=n;break}l=n-1}return o[n=l]==e?n/(i-1):(n+(e-(a=o[n]))/(o[n+1]-a))/(i-1)},getTangent:function(t){var r=t-1e-4;return 0>r&&(r=0),1<(t=t+1e-4)&&(t=1),r=this.getPoint(r),this.getPoint(t).clone().sub(r).normalize()},getTangentAt:function(t){return t=this.getUtoTmapping(t),this.getTangent(t)}},t.Utils={tangentQuadraticBezier:function(t,r,e,o){return 2*(1-t)*(e-r)+2*t*(o-e)},tangentCubicBezier:function(t,r,e,o,n){return-3*r*(1-t)*(1-t)+3*e*(1-t)*(1-t)-6*t*e*(1-t)+6*t*o*(1-t)-3*t*t*o+3*t*t*n},tangentSpline:function(t){return 6*t*t-6*t+(3*t*t-4*t+1)+(-6*t*t+6*t)+(3*t*t-2*t)},interpolate:function(t,r,e,o,n){var i=n*n;return(2*r-2*e+(t=.5*(e-t))+(o=.5*(o-r)))*n*i+(-3*r+3*e-2*t-o)*i+t*n+r}},t.create=function(r,e){return r.prototype=Object.create(t.prototype),r.prototype.getPoint=e,r};var r=function(){};r.prototype={init:function(t,r,e,o){this.c0=t,this.c1=e,this.c2=-3*t+3*r-2*e-o,this.c3=2*t-2*r+e+o},initNonuniformCatmullRom:function(t,r,e,o,n,i,s){var a=(r-t)/n-(e-t)/(n+i)+(e-r)/i,l=(e-r)/i-(o-r)/(i+s)+(o-e)/s;a*=i,l*=i,this.init(r,e,a,l)},initCatmullRom:function(t,r,e,o,n){this.init(r,e,n*(e-t),n*(o-r))},calc:function(t){var r=t*t,e=r*t;return this.c0+this.c1*t+this.c2*r+this.c3*e}};var e=new gt,o=new r,n=new r,i=new r;return t.create(function(t){this.points=t||[],this.closed=!1},function(t){var r,s,a,l,h,u,c,f=this.points,p=f.length;if(p<2&&console.log("duh, you need at least 2 points"),a=(r=(p-(this.closed?0:1))*t)-(s=Math.floor(r)),this.closed?s+=s>0?0:(Math.floor(Math.abs(s)/f.length)+1)*f.length:0===a&&s===p-1&&(s=p-2,a=1),this.closed||s>0?l=f[(s-1)%p]:(e.subVectors(f[0],f[1]).add(f[0]),l=e),h=f[s%p],u=f[(s+1)%p],this.closed||s+2<p?c=f[(s+2)%p]:(e.subVectors(f[p-1],f[p-2]).add(f[p-1]),c=e),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){var g="chordal"===this.type?.5:.25,v=Math.pow(l.distanceToSquared(h),g),d=Math.pow(h.distanceToSquared(u),g),y=Math.pow(u.distanceToSquared(c),g);d<1e-4&&(d=1),v<1e-4&&(v=d),y<1e-4&&(y=d),o.initNonuniformCatmullRom(l.x,h.x,u.x,c.x,v,d,y),n.initNonuniformCatmullRom(l.y,h.y,u.y,c.y,v,d,y),i.initNonuniformCatmullRom(l.z,h.z,u.z,c.z,v,d,y)}else if("catmullrom"===this.type){var m=void 0!==this.tension?this.tension:.5;o.initCatmullRom(l.x,h.x,u.x,c.x,m),n.initCatmullRom(l.y,h.y,u.y,c.y,m),i.initCatmullRom(l.z,h.z,u.z,c.z,m)}return new gt(o.calc(a),n.calc(a),i.calc(a))})}(),dt=function(t,r){for(var e=new Array,o=0;o<t.length;o++)e[o]=new gt(t[o][0],t[o][1],0);var n=new vt(e).getPoints(r*e.length),i=new Array;for(o=0;o<n.length;o++)i.push([n[o].x,n[o].y]);return i},yt="IsoImage",mt="image/png",wt="ActiveXObject"in window,bt=Math.min,xt=Math.max,Mt=Math.abs,Et=Math.round,Lt={x:"x",y:"y",v:"v",clipX:"0",clipY:"1"},kt=function(){var t="L"in window;return t||console.log("未加载leaflet"),t};function At(t,r,e){this.name=yt,this.initialize(t,r,e),this.getIsosurface=function(t,r){if(!this.alow())return!1;var e=k([M(this.option,this.pointGrid,this.isosurface,t)],this.option,t);return r?e:e.toDataURL(mt)},this.getIsoline=function(t,r){if(!this.alow())return!1;var e=k([E(this.option,this.isoline,t)],this.option,t);return r?e:e.toDataURL(mt)},this.getIsoImage=function(t,r){if(!this.alow())return!1;var e=k([M(this.option,this.pointGrid,this.isosurface,t),E(this.option,this.isoline,t)],this.option,t);return r?e:e.toDataURL(mt)},this.getLegend=function(t,r){var e=x(this.option.level||[],t);return!!e&&(r?e:e.toDataURL("image/png"))},this.layer=function(t,r){if(!kt())return!1;r=Object.assign({},{padding:.5,opacity:.1},r);var e=S(r),o={stroke:!0,weight:1,opacity:.7,fillOpacity:0,color:"#ff0000",fillColor:"#ff0000",renderer:e};return L.polygon(this.option.fmtClip,o).addTo(t),r.clipLayer=e,C(r)},this.getLeafletIsosurface=function(t,r){if(kt()){var e=z(this.fmtLatlngsIsosurface,"polygon",t,r);return L.featureGroup(e)}},this.getLeafletIsoline=function(t,r){if(!kt())return!1;var e=z(this.fmtLatlngsIsoline,"polyline",t,r);return L.featureGroup(e)},this.getLeafletIsoImage=function(t,r){if(!kt())return!1;var e=this.fmtLatlngsIsosurface,o=this.fmtLatlngsIsoline,n=z(e,"polygon",t,r),i=z(o,"polyline",t,r),s=n.concat(i);return L.featureGroup(s)},this.getLeafletLegend=function(t){if(!kt())return!1;t=Object.assign({},{position:"bottomleft",gradient:!0},t);var r=x(this.option.level||[],t);return!!r&&(t.canvas=r,function(t){return L.Control.IsoLegendCortrol||(L.Control.IsoLegendCortrol=L.Control.extend({options:{position:"bottomleft",canvas:""},initialize:function(t){L.Util.extend(this.options,t)},onAdd:function(){return this._container=L.DomUtil.create("div","leaflet-control-iso-legend"),this._container.appendChild(this.options.canvas),this._container}})),new L.Control.IsoLegendCortrol(t)}(t))}}return At.prototype={constructor:At,initialize:function(t,r,e){var o=r.extent,n=r.level;if(!o)return console.log("缺少参数extent(画布左上右下坐标)");if(!n)return console.log("缺少参数level(色阶)");n=function(t){for(var r=0,e=t.length;r<e;r++){var o=t[r].color;t[r].r=parseInt(o.substr(1,2),16),t[r].g=parseInt(o.substr(3,2),16),t[r].b=parseInt(o.substr(5,2),16)}return t}(n);var i=[bt(o[0][0],o[1][0]),bt(o[0][1],o[1][1]),xt(o[0][0],o[1][0]),xt(o[0][1],o[1][1])],s=[o[1][0]-o[0][0],o[1][1]-o[0][1]],a=r.cellWidth||Et(Mt(s[0])/200*1e6)/1e6;wt&&(a*=3);var l=Object.assign({},Lt,r.keyConfig);this.option={worker:r.worker,type:r.type||"idw",pow:r.pow||3,model:r.model||"spherical",clip:r.clip,fmtClip:r.clip?A(JSON.parse(JSON.stringify(r.clip)),2,l.clipX,l.clipY):[],smooth:r.smooth,ex:o,extent:i,size:s,cellWidth:a,level:n,key:l};var h=[],u=[],f=[],p=[];if(c(t))for(var g=0,v=t.length;g<v;g++)if(null!=t[g][l.v]){var d=t[g][l.v],y=t[g][l.x],m=t[g][l.y];h.push({x:y,y:m,v:d}),u.push(d),f.push(y),p.push(m)}this.points=h,this._v=u,this._x=f,this._y=p;var w=this;if(r.worker&&window.Worker&&!wt){var b=new Worker(r.worker+"/turf.js");return b.onmessage=function(t){w.pointGrid=t.data,w.calcGridValue(),e&&w.initReady(e)},b.postMessage(["pointGrid",i,a,{units:"degrees"}]),!1}this.pointGrid=function(t,r,e){if(!R(e=e||{}))throw new Error("options is invalid");var o=e.mask,n=e.properties,i=[];if(null==r)throw new Error("cellSide is required");if(!G(r))throw new Error("cellSide is invalid");if(!t)throw new Error("bbox is required");if(!Array.isArray(t))throw new Error("bbox must be array");if(4!==t.length)throw new Error("bbox must contain 4 numbers");if(o&&-1===["Polygon","MultiPolygon"].indexOf(Y(o)))throw new Error("options.mask must be a (Multi)Polygon");for(var s=t[0],a=t[1],l=t[2],h=t[3],u=r/et([s,a],[l,a],e)*(l-s),c=r/et([s,a],[s,h],e)*(h-a),f=l-s,p=h-a,g=Math.floor(f/u),v=(p-Math.floor(p/c)*c)/2,d=s+(f-g*u)/2;d<=l;){for(var y=a+v;y<=h;){var m=T([d,y],n);o?$(m,o)&&i.push(m):i.push(m),y+=c}d+=u}return j(i)}(i,a,{units:"degrees"}),this.calcGridValue(),e&&this.initReady(e)},calcGridValue:function(){var t=this.option,r=this.pointGrid,e=this._v,o=this._x,n=this._y,s=t.model;switch(t.type){case"kriging":if(t.worker&&window.Worker&&!wt){var a=new Worker(t.worker+"/"+t.type+".js"),l=this;return a.onmessage=function(t){l.pointGrid=t.data,l.pointGridState=!0,l.calcIso()},a.postMessage([r,e,o,n,s,.1,100]),!1}for(var h=i.train(e,o,n,s,.1,100),u=0;u<r.features.length;u++){var c=i.predict(r.features[u].geometry.coordinates[0],r.features[u].geometry.coordinates[1],h);r.features[u].properties.val=c}this.pointGridState=!0,this.calcIso();break;default:var f=this.points;if(t.worker&&window.Worker&&!wt){var p=new Worker(t.worker+"/"+t.type+".js");l=this;return p.onmessage=function(t){l.pointGrid=t.data,l.pointGridState=!0,l.calcIso()},p.postMessage([f,r,t.pow]),!1}this.pointGrid=function(t,r,e){null==e&&(e=3);var o=r.features;if(t.length<3)return r;for(var n=t.length,i=o.length,s=[],a=0;a<i;a++)for(var l=0;l<n;l++){var h=Math.sqrt(Math.pow(o[a].geometry.coordinates[0]-t[l].x,2)+Math.pow(o[a].geometry.coordinates[1]-t[l].y,2));s.push(h)}for(a=0;a<i;a++){var u=!1;for(l=n*a;l<n*a+n;l++)if(Math.abs(s[l])<1e-4){o[a].properties.val=t[l-n*a].v,u=!0;break}if(!u){var c=0,f=0;for(l=n*a;l<n*a+n;l++)c+=t[l-n*a].v/Math.pow(s[l],e),f+=1/Math.pow(s[l],e);o[a].properties.val=c/f}}return r}(f,r,t.pow),this.pointGridState=!0,this.calcIso()}},calcIso:function(){for(var t=this.option,r=this.pointGrid,e=t.level,o=[],n=this,i=0,s=e.length;i<s;i++)o.push(e[i].value);if(t.worker&&window.Worker&&!wt){var a=new Worker(t.worker+"/turf.js");n=this;return a.onmessage=function(o){var i=o.data;n.isoline=i;var s=function(t){for(var r,e,o,n,i=0,s=t.length;i<s;i++)for(var a=t[i].geometry.coordinates,l=0,h=a.length;l<h;l++){var u=a[l].length;u&&(null==r&&(r=o=a[l][0][0],e=n=a[l][0][1]),r=Math.min(r,a[l][0][0],a[l][u-1][0]),e=Math.min(e,a[l][0][1],a[l][u-1][1]),o=Math.max(o,a[l][0][0],a[l][u-1][0]),n=Math.max(n,a[l][0][1],a[l][u-1][1]))}return[r,e,o,n]}(i.features);try{n.isosurface=w(i,s,r,e)}catch(t){console.log(t)}t.smooth&&(n.isoline=n.smooth(n.isoline),n.isosurface&&(n.isosurface=n.smooth(n.isosurface))),n.fmtLatlngsIsoline=P(n.isoline),n.isosurface&&(n.fmtLatlngsIsosurface=P(n.isosurface)),n.isoLinesState=!0},a.postMessage(["isolines",r,o,{zProperty:"val"},e]),!1}var l=ct(r,o,{zProperty:"val"}),h=l.features;for(i=0,s=h.length;i<s;i++)for(var u=h[i].properties.val,c=0;e[c];c++)if(e[c].value==u){h[i].properties.color=e[c].color;break}this.isoline=l,this.isosurface=w(l,t.extent,r,e),t.smooth&&(this.isoline=this.smooth(this.isoline),this.isosurface=this.smooth(this.isosurface)),this.fmtLatlngsIsoline=P(this.isoline),this.fmtLatlngsIsosurface=P(this.isosurface),this.isoLinesState=!0},smooth:function(t){for(var r=t.features,e=0;e<r.length;e++){for(var o=r[e].geometry.coordinates,n=[],i=0;i<o.length;i++){var s=o[i],a=dt(s,5);n.push(a)}r[e].geometry.coordinates=n}return t},smooth2:function(t){for(var r=t.features,e=0;e<r.length;e++){for(var o=r[e].geometry.coordinates,n=[],i=0;i<o.length;i++){var s=o[i],a=pt(_(s),{resolution:600*s.length,sharpness:.85,stepLength:1});n.push(a.geometry.coordinates)}r[e].geometry.coordinates=n}return t},alow:function(){return this.pointGrid&&this.isoline},initReady:function(t,r){var e=null,o=this;e=setInterval(function(){o.pointGridState&&o.isoLinesState&&(clearInterval(e),t&&t(o,r))},10)},remove:function(){for(var t in this)delete this[t];return this}},At.merge=function(t,r,e){var o=c(t)?t:[],n=Object.assign({},{width:800,height:600,child:[]},r);if(!e||!o.length||!n.child.length)return!1;var i=n.child,s=0,a=n.width,l=n.height,h=document.createElement("canvas");h.width=a,h.height=l;var u=h.getContext("2d");u.clearRect(0,0,a,l);for(var f=0,p=i.length;f<p;f++){var g=i[f],v=o[g.target];v&&(s++,v[g.type]&&v.initReady(function(t,r){var o=t[r.type](r.config,1),n=r.scale||1;s--;var i=u.createPattern(o,"no-repeat");if(u.fillStyle=i,u.save(),u.translate(r.x,r.y),u.scale(n,n),u.fillRect(0,0,o.width,o.height),u.restore(),!s)return e(h)},g))}},At});
