!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(r=r||self).IsoImage=t()}(this,function(){"use strict";Object.assign||(Object.assign=function(r){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];for(var o,n=Object(r),a=Object.prototype.hasOwnProperty,i=0,s=t.length;i<s;i++)for(var l in o=Object(t[i]))a.call(o,l)&&(n[l]=o[l]);return n});var r=Math.max,t=Math.min,e=Math.abs,o=Math.floor;function n(r){return r=Number(r),isNaN(r)?0:0===r||r===1/0||r===-1/0?r:(r<0?-1:1)*o(e(r))}Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var r,t;for(r=0,t=0;r<this.length;r++)t+=this[r];return t/this.length},Array.prototype.fill=function(e){var o=arguments[1],a=arguments[2],i=function(r){if(null==r)throw TypeError();return Object(r)}(this),s=function(r){var e=n(r);return e<=0?0:e===1/0?9007199254740991:t(e,9007199254740991)}(i.length);s=r(s,0);var l,h,f,c=n(o);for(l=c<0?r(s+c,0):t(c,s),f=(h=void 0===a?s:n(a))<0?r(s+h,0):t(h,s);l<f;){i[String(l)]=e,l+=1}return i},Array.prototype.rep=function(r){return Array.apply(null,new Array(r)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(r,t){var e,o,n=!1;for(e=0,o=this.length-1;e<this.length;o=e++)this[e][1]>t!=this[o][1]>t&&r<(this[o][0]-this[e][0])*(t-this[e][1])/(this[o][1]-this[e][1])+this[e][0]&&(n=!n);return n};var a=function(){var r={},t=function(r,t){var e,o=new Array(t*t).fill(0);for(e=0;e<t;e++)o[e*t+e]=r;return o},e=function(r,t,e,o){var n,a,i=Array(e*o);for(n=0;n<e;n++)for(a=0;a<o;a++)i[n*o+a]=r[n*o+a]+t[n*o+a];return i},o=function(r,t,e,o,n){var a,i,s,l=Array(e*n);for(a=0;a<e;a++)for(i=0;i<n;i++)for(l[a*n+i]=0,s=0;s<o;s++)l[a*n+i]+=r[a*o+s]*t[s*n+i];return l},n=function(r,t){var e,o,n,a=Array(t);for(e=0;e<t;e++)a[e]=r[e*t+e];for(e=0;e<t;e++){for(o=0;o<e;o++)a[e]-=r[e*t+o]*r[e*t+o];if(a[e]<=0)return!1;for(a[e]=Math.sqrt(a[e]),o=e+1;o<t;o++){for(n=0;n<e;n++)r[o*t+e]-=r[o*t+n]*r[e*t+n];r[o*t+e]/=a[e]}}for(e=0;e<t;e++)r[e*t+e]=a[e];return!0},a=function(r,t){var e,o,n,a;for(e=0;e<t;e++)for(r[e*t+e]=1/r[e*t+e],o=e+1;o<t;o++){for(a=0,n=e;n<o;n++)a-=r[o*t+n]*r[n*t+e];r[o*t+e]=a/r[o*t+o]}for(e=0;e<t;e++)for(o=e+1;o<t;o++)r[e*t+o]=0;for(e=0;e<t;e++){for(r[e*t+e]*=r[e*t+e],n=e+1;n<t;n++)r[e*t+e]+=r[n*t+e]*r[n*t+e];for(o=e+1;o<t;o++)for(n=o;n<t;n++)r[e*t+o]+=r[n*t+e]*r[n*t+o]}for(e=0;e<t;e++)for(o=0;o<e;o++)r[e*t+o]=r[o*t+e]},i=function(r,t){var e,o,n,a,i,s,l,h,f,c,p,u=t,g=Array(t*t),v=Array(t),d=Array(t),y=Array(t);for(e=0;e<t;e++)for(a=0;a<t;a++)g[e*t+a]=e==a?1:0;for(a=0;a<t;a++)y[a]=0;for(e=0;e<t;e++){for(h=0,a=0;a<t;a++)if(1!=y[a])for(i=0;i<t;i++)0==y[i]&&Math.abs(r[a*t+i])>=h&&(h=Math.abs(r[a*t+i]),n=a,o=i);if(++y[o],n!=o){for(s=0;s<t;s++)p=r[n*t+s],r[n*t+s]=r[o*t+s],r[o*t+s]=p;for(s=0;s<u;s++)p=g[n*t+s],g[n*t+s]=g[o*t+s],g[o*t+s]=p}if(d[e]=n,v[e]=o,0==r[o*t+o])return!1;for(c=1/r[o*t+o],r[o*t+o]=1,s=0;s<t;s++)r[o*t+s]*=c;for(s=0;s<u;s++)g[o*t+s]*=c;for(l=0;l<t;l++)if(l!=o){for(f=r[l*t+o],r[l*t+o]=0,s=0;s<t;s++)r[l*t+s]-=r[o*t+s]*f;for(s=0;s<u;s++)g[l*t+s]-=g[o*t+s]*f}}for(s=t-1;s>=0;s--)if(d[s]!=v[s])for(i=0;i<t;i++)p=r[i*t+d[s]],r[i*t+d[s]]=r[i*t+v[s]],r[i*t+v[s]]=p;return!0},s=function(r,t,e,o,n){return t+(o-t)/e*(1-Math.exp(-1/n*Math.pow(r/e,2)))},l=function(r,t,e,o,n){return t+(o-t)/e*(1-Math.exp(-1/n*(r/e)))},h=function(r,t,e,o,n){return r>e?t+(o-t)/e:t+(o-t)/e*(r/e*1.5-.5*Math.pow(r/e,3))};return r.train=function(r,f,c,p,u,g){var v={t:r,x:f,y:c,nugget:0,range:0,sill:0,A:1/3,n:0};switch(p){case"gaussian":v.model=s;break;case"exponential":v.model=l;break;case"spherical":v.model=h}var d,y,b,m,M=r.length,w=Array((M*M-M)/2);for(d=0,b=0;d<M;d++)for(y=0;y<d;y++,b++)w[b]=Array(2),w[b][0]=Math.pow(Math.pow(f[d]-f[y],2)+Math.pow(c[d]-c[y],2),.5),w[b][1]=Math.abs(r[d]-r[y]);w.sort(function(r,t){return r[0]-t[0]}),v.range=w[(M*M-M)/2-1][0];var x=(M*M-M)/2>30?30:(M*M-M)/2,A=v.range/x,k=new Array(x).fill(0),O=new Array(x).fill(0);if(x<30)for(m=0;m<x;m++)k[m]=w[m][0],O[m]=w[m][1];else{for(d=0,y=0,b=0,m=0;d<x&&y<(M*M-M)/2;d++,b=0){for(;w[y][0]<=(d+1)*A&&(k[m]+=w[y][0],O[m]+=w[y][1],b++,!(++y>=(M*M-M)/2)););b>0&&(k[m]/=b,O[m]/=b,m++)}if(m<2)return v}M=m,v.range=k[M-1]-k[0];var S=new Array(2*M).fill(1),I=Array(M),j=v.A;for(d=0;d<M;d++){switch(p){case"gaussian":S[2*d+1]=1-Math.exp(-1/j*Math.pow(k[d]/v.range,2));break;case"exponential":S[2*d+1]=1-Math.exp(-1/j*k[d]/v.range);break;case"spherical":S[2*d+1]=k[d]/v.range*1.5-.5*Math.pow(k[d]/v.range,3)}I[d]=O[d]}var N=function(r,t,e){var o,n,a=Array(e*t);for(o=0;o<t;o++)for(n=0;n<e;n++)a[n*t+o]=r[o*e+n];return a}(S,M,2),G=o(N,S,2,M,2),L=(G=e(G,t(1/g,2),2,2)).slice(0);n(G,2)?a(G,2):(i(L,2),G=L);var R=o(o(G,N,2,2,M),I,2,M,1);v.nugget=R[0],v.sill=R[1]*v.range+v.nugget,v.n=f.length,M=f.length;var C=Array(M*M);for(d=0;d<M;d++){for(y=0;y<d;y++)C[d*M+y]=v.model(Math.pow(Math.pow(f[d]-f[y],2)+Math.pow(c[d]-c[y],2),.5),v.nugget,v.range,v.sill,v.A),C[y*M+d]=C[d*M+y];C[d*M+d]=v.model(0,v.nugget,v.range,v.sill,v.A)}var J=e(C,t(u,M),M,M),z=J.slice(0);n(J,M)?a(J,M):(i(z,M),J=z);C=J.slice(0);var P=o(J,r,M,M,1);return v.K=C,v.M=P,v},r.predict=function(r,t,e){var n,a=Array(e.n);for(n=0;n<e.n;n++)a[n]=e.model(Math.pow(Math.pow(r-e.x[n],2)+Math.pow(t-e.y[n],2),.5),e.nugget,e.range,e.sill,e.A);return o(a,e.M,1,e.n,1)[0]},r}();const i=function(r,t){for(var e=r[0],o=r[1],n=!1,a=0,i=t.length-1;a<t.length;i=a++){var s=t[a][0],l=t[a][1],h=t[i][0],f=t[i][1];l>o!=f>o&&e<(h-s)*(o-l)/(f-l)+s&&(n=!n)}return n},s=function(r,t){return r[0]==t[0]&&r[1]==t[1]};var l=function(r,t,e,o,n,a,i){i=i||[];for(var h,f,c,p,u=o[o.length-1],g="t"==n||"b"==n?0:1,v="t"==n||"l"==n?1:-1,d=a?-1:1,y=0;e[n][y];y++){var b=e[n][y],m=(b.p[g]-u[g])*v*d;m>0&&(!h||h&&f>m)&&(h=b,f=m)}if(h)s(h.p,o[0])?o.push(h.p):(p=function(r){return JSON.parse(JSON.stringify(r))}(r[h.coor].coor),h.d&&p.reverse(),o=o.concat(p)),c=h.t;else if(a)switch(n){case"t":o.push(t.sa),c="l";break;case"r":o.push(t.sb),c="t";break;case"b":o.push(t.sc),c="r";break;case"l":o.push(t.sd),c="b"}else switch(n){case"t":o.push(t.sb),c="r";break;case"r":o.push(t.sc),c="b";break;case"b":o.push(t.sd),c="l";break;case"l":o.push(t.sa),c="t"}return o.length>1&&s(o[0],o[o.length-1])?[o].concat(i):(h&&p&&(i=l(r,t,e,p,c,!a,i)),o=l(r,t,e,o,c,a,i))};const h=function(r,t,e){for(var o=!1,n=0,a=r.length;n<a;n++){if(t<r[n].value){if(!o){o=JSON.parse(JSON.stringify(r[n]));break}var i=(t-o.value)/(r[n].value-o.value),s=function(t){return e?parseInt(o[t]+(r[n][t]-o[t])*i):r[n][t]};o.r=s("r"),o.g=s("g"),o.b=s("b");break}o=JSON.parse(JSON.stringify(r[n]))}return o},f=Math.abs,c=Math.max,p=Math.min,u=Math.floor,g=function(r,t){return f(r-t)},v=function(r,t){for(var e=0,o=c(g(t[0],t[2]),g(t[1],t[3])),n=0;n<4;n++){var a=g(t[n],r[n%2]);a<o&&(o=a,e=n)}return"lbrt".charAt(e)},d=function(r,t){return r[0]==t[0]&&r[1]==t[1]},y=function(r){return JSON.parse(JSON.stringify(r))};function b(r,t,e){var o=null==(e=e||{}).gradient||e.gradient,n=r.size,a=r.cellWidth,i=r.level,s=r.ex,l=e.width||1e3,f=Math.abs(l/n[0]*n[1]),c=document.createElement("canvas");c.width=l,c.height=f;var p=c.getContext("2d");p.clearRect(0,0,l,f);for(var u=t.features,g=Math.abs(a/n[0]*l),v=Math.abs(a/n[1]*f),d=0,y=u.length;d<y;d++){var b=u[d].geometry.coordinates,m=(b[0]-s[0][0])/n[0]*l-g/2,M=(b[1]-s[0][1])/n[1]*f-v/2,w=h(i,u[d].properties.val,o);p.strokeStyle=p.fillStyle="rgb("+w.r+","+w.g+","+w.b+")",p.beginPath(),p.fillRect(m-1,M-1,g+2,v+2)}return c}function m(r,t,e){e=e||{};var o=r.size,n=r.ex,a=e.width||1e3,i=Math.abs(a/o[0]*o[1]),s=e.isolineColor||"#333",l=document.createElement("canvas");l.width=a,l.height=i;var h=l.getContext("2d");h.clearRect(0,0,a,i),h.lineWidth=1,h.font="12px 微软雅黑",h.textBaseline="middle",h.textAlign="center";for(var f=t.features,c={},p=0,u=f.length;p<u;p++){var g=f[p].geometry.coordinates,v="level"==s?f[p].properties.color:s;h.strokeStyle=h.fillStyle=v;for(var d=0,y=g.length;d<y;d++){h.beginPath();for(var b=0,m=0,M=g[d].length;m<M;m++){var w=(g[d][m][0]-n[0][0])/o[0]*a,x=(g[d][m][1]-n[0][1])/o[1]*i;h[m?"lineTo":"moveTo"](w,x);var A=Math.round(w/16)+"-"+Math.round(x/16);c[A]||b||(c[A]=1,b=1,h.fillText(f[p].properties.val,w,x))}h.stroke()}}return l}const M=Object.prototype.toString,w=function(r){return"[object Array]"===M.call(r)};function x(r,t,e){if(!r[0])return!1;var o=(e=e||{}).opacity||1,n=r[0].width,a=r[0].height,i=document.createElement("canvas");i.width=n,i.height=a;var s=i.getContext("2d");s.clearRect(0,0,n,a),s.globalAlpha=o,s.strokeStyle=e.clipColor||"#333",s.lineWidth=e.clipWidth||1;var l=t.clip;if(l&&w(l)){var h=t.ex,f=t.size,c=t.key||{},p=c.clipX||0,u=c.clipY||1;s.beginPath();var g=function(r){if(w(r[0])&&w(r[0][0]))for(var t=0,e=r.length;t<e;t++)g(r[t]);else if(w(r))for(t=0,e=r.length;t<e;t++){var o=(r[t][p]-h[0][0])/f[0]*n,i=(r[t][u]-h[0][1])/f[1]*a;s[t?"lineTo":"moveTo"](o,i)}};g(l),e.clip&&s.stroke(),s.clip()}for(var v=0;r[v];v++){var d=s.createPattern(r[v],"repeat");s.fillStyle=d,s.fillRect(0,0,n,a)}return i}const A=window.turf,k="IsoImage",O="image/png",S=Object.prototype.toString,I=Math.min,j=Math.max,N=Math.abs,G=Math.round,L={x:"x",y:"y",v:"v",clipX:"0",clipY:"1"};function R(r,t){this.name=k,this.initialize(r,t),this.getLegend=function(){return function(r){if(r.legend<2)return!1;var t=document.createElement("canvas");t.width=200,t.height=30;for(var e=t.getContext("2d"),o=e.createLinearGradient(0,0,200,0),n=0,a=r.length;n<a;n++){var i=r[n].color;o.addColorStop(1/a*n,i)}return e.fillStyle=o,e.fillRect(0,0,200,30),t.toDataURL("image/png")}(this.option.level||[])},this.getIsosurface=function(r){return!!this.alow()&&x([b(this.option,this.pointGrid,r)],this.option,r).toDataURL(O)},this.getIsoline=function(r){return!!this.alow()&&x([m(this.option,this.isoline,r)],this.option,r).toDataURL(O)},this.getIsoImage=function(r){return!!this.alow()&&x([b(this.option,this.pointGrid,r),m(this.option,this.isoline,r)],this.option,r).toDataURL(O)}}return R.prototype={constructor:R,initialize:function(r,t){var e=t.extent,o=t.level;if(!e)return console.log("缺少参数extent(画布左上右下坐标)");if(!o)return console.log("缺少参数level(色阶)");o=this.fmtLevel(o);var n=[I(e[0][0],e[1][0]),I(e[0][1],e[1][1]),j(e[0][0],e[1][0]),j(e[0][1],e[1][1])],a=[e[1][0]-e[0][0],e[1][1]-e[0][1]],i=t.cellWidth||G(N(a[0])/200*1e6)/1e6,s=Object.assign({},L,t.keyConfig);this.option={type:t.type||"idw",pow:t.pow||3,model:t.model||"spherical",clip:t.clip,smooth:t.smooth,ex:e,extent:n,size:a,cellWidth:i,level:o,key:s};var l=[],h=[],f=[],c=[];if(function(r){return"[object Array]"===S.call(r)}(r))for(var p=0,u=r.length;p<u;p++)if(null!=r[p][s.v]){var g=r[p][s.v],v=r[p][s.x],d=r[p][s.y];l.push({x:v,y:d,v:g}),h.push(g),f.push(v),c.push(d)}this.points=l,this._v=h,this._x=f,this._y=c,this.pointGrid=A.pointGrid(n,i,{units:"degrees"}),this.build()},build:function(){this.calcGridValue(),this.calcIsoLines()},calcGridValue:function(){var r=this.option,t=this.pointGrid;switch(r.type){case"kriging":for(var e=a.train(this._v,this._x,this._y,r.model,.1,100),o=0;o<t.features.length;o++){var n=a.predict(t.features[o].geometry.coordinates[0],t.features[o].geometry.coordinates[1],e);t.features[o].properties.val=n}break;default:var i=this.points;this.pointGrid=function(r,t,e){null==e&&(e=3);var o=t.features;if(r.length<3)return t;for(var n=r.length,a=o.length,i=[],s=0;s<a;s++)for(var l=0;l<n;l++){var h=Math.sqrt(Math.pow(o[s].geometry.coordinates[0]-r[l].x,2)+Math.pow(o[s].geometry.coordinates[1]-r[l].y,2));i.push(h)}for(s=0;s<a;s++){var f=!1;for(l=n*s;l<n*s+n;l++)if(Math.abs(i[l])<1e-4){o[s].properties.val=r[l-n*s].v,f=!0;break}if(!f){var c=0,p=0;for(l=n*s;l<n*s+n;l++)c+=r[l-n*s].v/Math.pow(i[l],e),p+=1/Math.pow(i[l],e);o[s].properties.val=c/p}}return t}(i,t,r.pow)}},calcIsoLines:function(){for(var r=this.option,t=this.pointGrid,e=r.level,o=[],n=0,a=e.length;n<a;n++)o.push(e[n].value);var s=A.isolines(t,o,{zProperty:"val"}),g=s.features;for(n=0,a=g.length;n<a;n++)for(var b=g[n].properties.val,m=0;e[m];m++)if(e[m].value==b){g[n].properties.color=e[m].color;break}this.isoline=s,this.isosurface=function(r,t,e,o){for(var n,a=[],s=[],g={t:[],b:[],l:[],r:[]},b=r.features,m=0,M=b.length;m<M;m++)for(var w=b[m],x=0,A=(Y=w.geometry.coordinates).length;x<A;x++){var k=Y[x],O=k[0],S=k[k.length-1];if(d(O,S))a.push({coor:k,properties:w.properties,child:[],parent:[],i:a.length});else{s.push({coor:k,properties:w.properties});var I=v(O,t),j=v(S,t);g[I].push({p:O,end:S,d:0,t:j,coor:s.length-1}),g[j].push({p:S,end:O,d:1,t:I,coor:s.length-1})}}for(var N={sa:[t[0],t[3]],sb:[t[2],t[3]],sc:[t[2],t[1]],sd:[t[0],t[1]]},G=(m=0,(n=l(s,N,g,[N.sa],"t",!1)).length);m<G;m++)a.push({coor:n[m],properties:{type:"open"},child:[],parent:[],i:a.length});for(m=0,M=a.length;m<M;m++)for(var L=m+1;L<M;L++){var R=a[m].properties.type,C=a[L].properties.type;"open"!=R&&i(a[m].coor[0],a[L].coor)?(a[L].child.push(m),a[m].parent.push(L)):"open"!=C&&i(a[L].coor[0],a[m].coor)&&(a[m].child.push(L),a[L].parent.push(m))}var J=y(a),z=[],P=[],T=[],W=function(){if(J.length){for(var r=[],t=0,e=J.length;t<e;t++){for(var o=J[t],n=o.child,a=1,i=n.length-1;i>-1;i--)-1==P.indexOf(n[i])&&(a=0);if(a){var s=[];for(i=n.length-1;i>-1;i--){var l=T.indexOf(n[i]);l>-1&&(s.push(n[i]),T.splice(l,1))}T.push(o.i),P.push(o.i),J[t].child=s,z.push(J[t])}else r.push(J[t])}r.length&&(J=r,W())}};W();var _=[],E=e.features,D=E.length,U=E[0].geometry.coordinates,q=1,F=1,V=1;for(m=0;m<D;m++){var X=E[m].geometry.coordinates;if(1==m&&(V=f(X[1]-U[1])),X[0]!=U[0]){q=m,F=f(X[0]-U[0]);break}}for(m=0,M=z.length;m<M;m++){for(var Y,B=[(Y=z[m]).coor],K="rgba(0, 0, 0, 0)",H=(L=0,Y.child.length);L<H;L++)B.push(a[Y.child[L]].coor);var Q,Z=u(Y.coor.length/2),$=Y.coor[Z],rr=($[0]-U[0])/F,tr=c(u(rr)*q+u(($[1]-U[1])/V),0),er=rr%1?0:1,or=er?1:q,nr=er?V:F,ar=nr/100;if(E[tr]&&E[tr+or]){var ir=E[tr].geometry.coordinates,sr=E[tr+or].geometry.coordinates,lr=Object.assign([],$,[]);lr[er]=c($[er]-ar,ir[er]);var hr=E[tr].properties.val,fr=E[tr+or].properties.val;i(lr,Y.coor)?Q=hr+(fr-hr)*(f(lr[er]-E[tr].geometry.coordinates[er])/nr):(lr[er]=p($[er]+2*ar,sr[er]),i(lr,Y.coor)&&(Q=hr+(fr-hr)*(f(lr[er]-E[tr].geometry.coordinates[er])/nr)))}else E[tr]&&(Q=E[tr].properties.val);if(null!=Q){var cr=h(o,Q,!1);K="rgb("+cr.r+","+cr.g+","+cr.b+")"}_.push({geometry:{coordinates:B,type:"MultiLineString"},properties:{color:K},type:"Feature"})}return{features:_,type:"FeatureCollection"}}(s,r.extent,t,e)},fmtLevel:function(r){for(var t=0,e=r.length;t<e;t++){var o=r[t].color;r[t].r=parseInt(o.substr(1,2),16),r[t].g=parseInt(o.substr(3,2),16),r[t].b=parseInt(o.substr(5,2),16)}return r},alow:function(){return this.pointGrid&&this.isoline}},R});
