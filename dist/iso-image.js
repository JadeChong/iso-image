!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t=t||self).IsoImage=r()}(this,function(){"use strict";Object.assign||(Object.assign=function(t){for(var r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];for(var o,n=Object(t),i=Object.prototype.hasOwnProperty,a=0,l=r.length;a<l;a++)for(var h in o=Object(r[a]))i.call(o,h)&&(n[h]=o[h]);return n});var t=Math.max,r=Math.min,e=Math.abs,o=Math.floor;function n(t){return t=Number(t),isNaN(t)?0:0===t||t===1/0||t===-1/0?t:(t<0?-1:1)*o(e(t))}Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var t,r;for(t=0,r=0;t<this.length;t++)r+=this[t];return r/this.length},Array.prototype.fill=function(e){var o=arguments[1],i=arguments[2],a=function(t){if(null==t)throw TypeError();return Object(t)}(this),l=function(t){var e=n(t);return e<=0?0:e===1/0?9007199254740991:r(e,9007199254740991)}(a.length);l=t(l,0);var h,f,s,u=n(o);for(h=u<0?t(l+u,0):r(u,l),s=(f=void 0===i?l:n(i))<0?t(l+f,0):r(f,l);h<s;){a[String(h)]=e,h+=1}return a},Array.prototype.rep=function(t){return Array.apply(null,new Array(t)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(t,r){var e,o,n=!1;for(e=0,o=this.length-1;e<this.length;o=e++)this[e][1]>r!=this[o][1]>r&&t<(this[o][0]-this[e][0])*(r-this[e][1])/(this[o][1]-this[e][1])+this[e][0]&&(n=!n);return n};var i=function(){var t={},r=function(t,r){var e,o=new Array(r*r).fill(0);for(e=0;e<r;e++)o[e*r+e]=t;return o},e=function(t,r,e,o){var n,i,a=Array(e*o);for(n=0;n<e;n++)for(i=0;i<o;i++)a[n*o+i]=t[n*o+i]+r[n*o+i];return a},o=function(t,r,e,o,n){var i,a,l,h=Array(e*n);for(i=0;i<e;i++)for(a=0;a<n;a++)for(h[i*n+a]=0,l=0;l<o;l++)h[i*n+a]+=t[i*o+l]*r[l*n+a];return h},n=function(t,r){var e,o,n,i=Array(r);for(e=0;e<r;e++)i[e]=t[e*r+e];for(e=0;e<r;e++){for(o=0;o<e;o++)i[e]-=t[e*r+o]*t[e*r+o];if(i[e]<=0)return!1;for(i[e]=Math.sqrt(i[e]),o=e+1;o<r;o++){for(n=0;n<e;n++)t[o*r+e]-=t[o*r+n]*t[e*r+n];t[o*r+e]/=i[e]}}for(e=0;e<r;e++)t[e*r+e]=i[e];return!0},i=function(t,r){var e,o,n,i;for(e=0;e<r;e++)for(t[e*r+e]=1/t[e*r+e],o=e+1;o<r;o++){for(i=0,n=e;n<o;n++)i-=t[o*r+n]*t[n*r+e];t[o*r+e]=i/t[o*r+o]}for(e=0;e<r;e++)for(o=e+1;o<r;o++)t[e*r+o]=0;for(e=0;e<r;e++){for(t[e*r+e]*=t[e*r+e],n=e+1;n<r;n++)t[e*r+e]+=t[n*r+e]*t[n*r+e];for(o=e+1;o<r;o++)for(n=o;n<r;n++)t[e*r+o]+=t[n*r+e]*t[n*r+o]}for(e=0;e<r;e++)for(o=0;o<e;o++)t[e*r+o]=t[o*r+e]},a=function(t,r){var e,o,n,i,a,l,h,f,s,u,c,p=r,g=Array(r*r),v=Array(r),d=Array(r),y=Array(r);for(e=0;e<r;e++)for(i=0;i<r;i++)g[e*r+i]=e==i?1:0;for(i=0;i<r;i++)y[i]=0;for(e=0;e<r;e++){for(f=0,i=0;i<r;i++)if(1!=y[i])for(a=0;a<r;a++)0==y[a]&&Math.abs(t[i*r+a])>=f&&(f=Math.abs(t[i*r+a]),n=i,o=a);if(++y[o],n!=o){for(l=0;l<r;l++)c=t[n*r+l],t[n*r+l]=t[o*r+l],t[o*r+l]=c;for(l=0;l<p;l++)c=g[n*r+l],g[n*r+l]=g[o*r+l],g[o*r+l]=c}if(d[e]=n,v[e]=o,0==t[o*r+o])return!1;for(u=1/t[o*r+o],t[o*r+o]=1,l=0;l<r;l++)t[o*r+l]*=u;for(l=0;l<p;l++)g[o*r+l]*=u;for(h=0;h<r;h++)if(h!=o){for(s=t[h*r+o],t[h*r+o]=0,l=0;l<r;l++)t[h*r+l]-=t[o*r+l]*s;for(l=0;l<p;l++)g[h*r+l]-=g[o*r+l]*s}}for(l=r-1;l>=0;l--)if(d[l]!=v[l])for(a=0;a<r;a++)c=t[a*r+d[l]],t[a*r+d[l]]=t[a*r+v[l]],t[a*r+v[l]]=c;return!0},l=function(t,r,e,o,n){return r+(o-r)/e*(1-Math.exp(-1/n*Math.pow(t/e,2)))},h=function(t,r,e,o,n){return r+(o-r)/e*(1-Math.exp(-1/n*(t/e)))},f=function(t,r,e,o,n){return t>e?r+(o-r)/e:r+(o-r)/e*(t/e*1.5-.5*Math.pow(t/e,3))};return t.train=function(t,s,u,c,p,g){var v={t:t,x:s,y:u,nugget:0,range:0,sill:0,A:1/3,n:0};switch(c){case"gaussian":v.model=l;break;case"exponential":v.model=h;break;case"spherical":v.model=f}var d,y,m,M,w=t.length,b=Array((w*w-w)/2);for(d=0,m=0;d<w;d++)for(y=0;y<d;y++,m++)b[m]=Array(2),b[m][0]=Math.pow(Math.pow(s[d]-s[y],2)+Math.pow(u[d]-u[y],2),.5),b[m][1]=Math.abs(t[d]-t[y]);b.sort(function(t,r){return t[0]-r[0]}),v.range=b[(w*w-w)/2-1][0];var A=(w*w-w)/2>30?30:(w*w-w)/2,x=v.range/A,k=new Array(A).fill(0),S=new Array(A).fill(0);if(A<30)for(M=0;M<A;M++)k[M]=b[M][0],S[M]=b[M][1];else{for(d=0,y=0,m=0,M=0;d<A&&y<(w*w-w)/2;d++,m=0){for(;b[y][0]<=(d+1)*x&&(k[M]+=b[y][0],S[M]+=b[y][1],m++,!(++y>=(w*w-w)/2)););m>0&&(k[M]/=m,S[M]/=m,M++)}if(M<2)return v}w=M,v.range=k[w-1]-k[0];var I=new Array(2*w).fill(1),O=Array(w),j=v.A;for(d=0;d<w;d++){switch(c){case"gaussian":I[2*d+1]=1-Math.exp(-1/j*Math.pow(k[d]/v.range,2));break;case"exponential":I[2*d+1]=1-Math.exp(-1/j*k[d]/v.range);break;case"spherical":I[2*d+1]=k[d]/v.range*1.5-.5*Math.pow(k[d]/v.range,3)}O[d]=S[d]}var z=function(t,r,e){var o,n,i=Array(e*r);for(o=0;o<r;o++)for(n=0;n<e;n++)i[n*r+o]=t[o*e+n];return i}(I,w,2),R=o(z,I,2,w,2),G=(R=e(R,r(1/g,2),2,2)).slice(0);n(R,2)?i(R,2):(a(G,2),R=G);var C=o(o(R,z,2,2,w),O,2,w,1);v.nugget=C[0],v.sill=C[1]*v.range+v.nugget,v.n=s.length,w=s.length;var L=Array(w*w);for(d=0;d<w;d++){for(y=0;y<d;y++)L[d*w+y]=v.model(Math.pow(Math.pow(s[d]-s[y],2)+Math.pow(u[d]-u[y],2),.5),v.nugget,v.range,v.sill,v.A),L[y*w+d]=L[d*w+y];L[d*w+d]=v.model(0,v.nugget,v.range,v.sill,v.A)}var N=e(L,r(p,w),w,w),P=N.slice(0);n(N,w)?i(N,w):(a(P,w),N=P);L=N.slice(0);var T=o(N,t,w,w,1);return v.K=L,v.M=T,v},t.predict=function(t,r,e){var n,i=Array(e.n);for(n=0;n<e.n;n++)i[n]=e.model(Math.pow(Math.pow(t-e.x[n],2)+Math.pow(r-e.y[n],2),.5),e.nugget,e.range,e.sill,e.A);return o(i,e.M,1,e.n,1)[0]},t.variance=function(t,r,e){var n,i=Array(e.n);for(n=0;n<e.n;n++)i[n]=e.model(Math.pow(Math.pow(t-e.x[n],2)+Math.pow(r-e.y[n],2),.5),e.nugget,e.range,e.sill,e.A);return e.model(0,e.nugget,e.range,e.sill,e.A)+o(o(i,e.K,1,e.n,e.n),i,1,e.n,1)[0]},t.grid=function(r,e,o){var n,i,a,l=r.length;if(0!=l){var h,f,s=[r[0][0][0],r[0][0][0]],u=[r[0][0][1],r[0][0][1]];for(n=0;n<l;n++)for(i=0;i<r[n].length;i++)r[n][i][0]<s[0]&&(s[0]=r[n][i][0]),r[n][i][0]>s[1]&&(s[1]=r[n][i][0]),r[n][i][1]<u[0]&&(u[0]=r[n][i][1]),r[n][i][1]>u[1]&&(u[1]=r[n][i][1]);var c=Array(2),p=Array(2),g=Array(2),v=Array(2),d=Math.ceil((s[1]-s[0])/o),y=Math.ceil((u[1]-u[0])/o),m=Array(d+1);for(n=0;n<=d;n++)m[n]=Array(y+1);for(n=0;n<l;n++){for(g[0]=r[n][0][0],g[1]=g[0],v[0]=r[n][0][1],v[1]=v[0],i=1;i<r[n].length;i++)r[n][i][0]<g[0]&&(g[0]=r[n][i][0]),r[n][i][0]>g[1]&&(g[1]=r[n][i][0]),r[n][i][1]<v[0]&&(v[0]=r[n][i][1]),r[n][i][1]>v[1]&&(v[1]=r[n][i][1]);for(c[0]=Math.floor((g[0]-(g[0]-s[0])%o-s[0])/o),c[1]=Math.ceil((g[1]-(g[1]-s[1])%o-s[0])/o),p[0]=Math.floor((v[0]-(v[0]-u[0])%o-u[0])/o),p[1]=Math.ceil((v[1]-(v[1]-u[1])%o-u[0])/o),i=c[0];i<=c[1];i++)for(a=p[0];a<=p[1];a++)h=s[0]+i*o,f=u[0]+a*o,r[n].pip(h,f)&&(m[i][a]=t.predict(h,f,e))}return m.xlim=s,m.ylim=u,m.zlim=[e.t.min(),e.t.max()],m.width=o,m}},t.contour=function(t,r,e){},t.plot=function(t,r,e,o,n){var i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);var a,l,h,f,s,u=[e[1]-e[0],o[1]-o[0],r.zlim[1]-r.zlim[0]],c=r.length,p=r[0].length,g=Math.ceil(r.width*t.width/(e[1]-e[0])),v=Math.ceil(r.width*t.height/(o[1]-o[0]));for(a=0;a<c;a++)for(l=0;l<p;l++)null!=r[a][l]&&(h=t.width*(a*r.width+r.xlim[0]-e[0])/u[0],f=t.height*(1-(l*r.width+r.ylim[0]-o[0])/u[1]),(s=(r[a][l]-r.zlim[0])/u[2])<0&&(s=0),s>1&&(s=1),i.fillStyle=n[Math.floor((n.length-1)*s)],i.fillRect(Math.round(h-g/2),Math.round(f-v/2),g,v))},t}();function a(t,r,e){var o=null==(e=e||{}).gradient||e.gradient,n=t.size,i=t.cellWidth,a=t.level,h=t.ex,f=e.width||1e3,s=Math.abs(f/n[0]*n[1]),u=document.createElement("canvas");u.width=f,u.height=s;var c=u.getContext("2d");c.clearRect(0,0,f,s);for(var p=r.features,g=Math.abs(i/n[0]*f),v=Math.abs(i/n[1]*s),d=0,y=p.length;d<y;d++){var m=p[d].geometry.coordinates,M=(m[0]-h[0][0])/n[0]*f-g/2,w=(m[1]-h[0][1])/n[1]*s-v/2,b=l(a,p[d].properties.val,o);c.strokeStyle=c.fillStyle="rgb("+b.r+","+b.g+","+b.b+")",c.beginPath(),c.fillRect(M-1,w-1,g+2,v+2)}return u}function l(t,r,e){for(var o=!1,n=0,i=t.length;n<i;n++){if(r<t[n].value){if(!o){o=JSON.parse(JSON.stringify(t[n]));break}var a=(r-o.value)/(t[n].value-o.value);o.r=e?parseInt(o.r+(t[n].r-o.r)*a):t[n].r,o.g=e?parseInt(o.g+(t[n].g-o.g)*a):t[n].g,o.b=e?parseInt(o.b+(t[n].b-o.b)*a):t[n].b;break}o=JSON.parse(JSON.stringify(t[n]))}return o}function h(t,r,e){e=e||{};var o=t.size,n=t.ex,i=e.width||1e3,a=Math.abs(i/o[0]*o[1]),l=t.level,h=e.isolineColor||"#333",f=document.createElement("canvas");f.width=i,f.height=a;var s=f.getContext("2d");s.clearRect(0,0,i,a),s.lineWidth=1,s.font="12px 微软雅黑",s.textBaseline="middle",s.textAlign="center";for(var u=r.features,c={},p=0,g=u.length;p<g;p++){var v=u[p].geometry.coordinates,d=u[p].properties.val,y=h;if("level"==h)for(var m=0;l[m];m++)if(l[m].value==d){y=l[m].color;break}s.strokeStyle=s.fillStyle=y;for(var M=0,w=v.length;M<w;M++){s.beginPath();for(var b=0,A=0,x=v[M].length;A<x;A++){var k=(v[M][A][0]-n[0][0])/o[0]*i,S=(v[M][A][1]-n[0][1])/o[1]*a;s[A?"lineTo":"moveTo"](k,S);var I=Math.round(k/16)+"-"+Math.round(S/16);c[I]||b||(c[I]=1,b=1,s.fillText(u[p].properties.val,k,S))}s.stroke()}}return f}const f=Object.prototype.toString,s=function(t){return"[object Array]"===f.call(t)};function u(t,r,e){if(!t[0])return!1;var o=(e=e||{}).opacity||1,n=t[0].width,i=t[0].height,a=document.createElement("canvas");a.width=n,a.height=i;var l=a.getContext("2d");l.clearRect(0,0,n,i),l.globalAlpha=o,l.strokeStyle=e.clipColor||"#333",l.lineWidth=e.clipWidth||1;var h=r.clip;if(h&&s(h)){var f=r.ex,u=r.size,c=r.key||{},p=c.clipX||0,g=c.clipY||1;l.beginPath();var v=function(t){if(s(t[0])&&s(t[0][0]))for(var r=0,e=t.length;r<e;r++)v(t[r]);else if(s(t))for(r=0,e=t.length;r<e;r++){var o=(t[r][p]-f[0][0])/u[0]*n,a=(t[r][g]-f[0][1])/u[1]*i;l[r?"lineTo":"moveTo"](o,a)}};v(h),e.clip&&l.stroke(),l.clip()}for(var d=0;t[d];d++){var y=l.createPattern(t[d],"repeat");l.fillStyle=y,l.fillRect(0,0,n,i)}return a}const c=window.turf,p="IsoImage",g="image/png",v=Object.prototype.toString,d=Math.min,y=Math.max,m=Math.abs,M=Math.round,w={x:"x",y:"y",v:"v",clipX:"0",clipY:"1"};function b(t,r){this.name=p,this.initialize(t,r),this.getLegend=function(){return function(t){if(t.legend<2)return!1;var r=document.createElement("canvas");r.width=200,r.height=30;for(var e=r.getContext("2d"),o=e.createLinearGradient(0,0,200,0),n=0,i=t.length;n<i;n++){var a=t[n].color;o.addColorStop(1/i*n,a)}return e.fillStyle=o,e.fillRect(0,0,200,30),r.toDataURL("image/png")}(this.option.level||[])},this.getIsosurface=function(t){return!!this.alow()&&u([a(this.option,this.pointGrid,t)],this.option,t).toDataURL(g)},this.getIsoline=function(t){return!!this.alow()&&u([h(this.option,this.lines,t)],this.option,t).toDataURL(g)},this.getIsoImage=function(t){return!!this.alow()&&u([a(this.option,this.pointGrid,t),h(this.option,this.lines,t)],this.option,t).toDataURL(g)}}return b.prototype={constructor:b,initialize:function(t,r){var e=r.extent,o=r.level;if(!e)return console.log("缺少参数extent(画布左上右下坐标)");if(!o)return console.log("缺少参数level(色阶)");for(var n=[d(e[0][0],e[1][0]),d(e[0][1],e[1][1]),y(e[0][0],e[1][0]),y(e[0][1],e[1][1])],i=[e[1][0]-e[0][0],e[1][1]-e[0][1]],a=r.cellWidth||M(m(i[0])/200*1e6)/1e6,l=Object.assign({},w,r.keyConfig),h=0,f=o.length;h<f;h++){var s=o[h].color;o[h].r=parseInt(s.substr(1,2),16),o[h].g=parseInt(s.substr(3,2),16),o[h].b=parseInt(s.substr(5,2),16)}this.option={type:r.type||"idw",pow:r.pow||3,model:r.model||"spherical",clip:r.clip,smooth:r.smooth,ex:e,extent:n,size:i,cellWidth:a,level:o,key:l};var u=[],p=[],g=[],b=[];if(function(t){return"[object Array]"===v.call(t)}(t))for(h=0,f=t.length;h<f;h++)if(null!=t[h][l.v]){var A=t[h][l.v],x=t[h][l.x],k=t[h][l.y];u.push({x:x,y:k,v:A}),p.push(A),g.push(x),b.push(k)}this.points=u,this._v=p,this._x=g,this._y=b,this.pointGrid=c.pointGrid(n,a,{units:"degrees"}),this.build()},build:function(){this.calcGridValue(),this.calcIsoLines()},calcGridValue:function(){var t=this.option,r=this.pointGrid;switch(t.type){case"kriging":for(var e=i.train(this._v,this._x,this._y,t.model,.1,100),o=0;o<r.features.length;o++)r.features[o].properties.val=i.predict(r.features[o].geometry.coordinates[0],r.features[o].geometry.coordinates[1],e);break;default:var n=this.points;this.pointGrid=function(t,r,e){null==e&&(e=3);var o=r.features;if(t.length<3)return r;for(var n=t.length,i=o.length,a=[],l=0;l<i;l++)for(var h=0;h<n;h++){var f=Math.sqrt(Math.pow(o[l].geometry.coordinates[0]-t[h].x,2)+Math.pow(o[l].geometry.coordinates[1]-t[h].y,2));a.push(f)}for(l=0;l<i;l++){var s=!1;for(h=n*l;h<n*l+n;h++)if(Math.abs(a[h])<1e-4){o[l].properties.val=t[h-n*l].v,s=!0;break}if(!s){var u=0,c=0;for(h=n*l;h<n*l+n;h++)u+=t[h-n*l].v/Math.pow(a[h],e),c+=1/Math.pow(a[h],e);o[l].properties.val=u/c}}return r}(n,r,t.pow)}},calcIsoLines:function(){for(var t=this.option,r=this.pointGrid,e=t.level,o=[],n=0,i=e.length;n<i;n++)o.push(e[n].value);var a=c.isolines(r,o,{zProperty:"val"});if(t.smooth){var l=a.features;for(n=0;n<l.length;n++){for(var h=l[n].geometry.coordinates,f=[],s=0;s<h.length;s++){var u=h[s],p=c.lineString(u),g=c.bezierSpline(p);f.push(g.geometry.coordinates)}l[n].geometry.coordinates=f}}this.lines=a},alow:function(){return this.pointGrid&&this.lines}},b});
