<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>iso-image</title>
    <!-- <script src="./turf.js"></script>
    <script src="./pointGrid.js"></script> -->
    <script src="./iso-image-dev.js"></script>
    <script type="text/javascript" src="leaflet-1.0.2/leaflet-src.js"></script>
    <link rel="stylesheet" type="text/css" href="leaflet-1.0.2/leaflet.css">
    <style>
      * { padding: 0; margin: 0; }
      html, body, #map { height: 100%; width: 100%;}
    </style>
  </head>
  <body>
    <div id="map" ></div>
    <script>
      var map = L.map('map', {
        center: [25.763889, 119.469167],
        crs:L.CRS.EPSG3857,
        zoom: 8,
        maxZoom: 18,
        minZoom: 1,
        zoomControl: false,
        attributionControl: false
      })
      L.tileLayer('http://{s}.google.cn/vt/lyrs=t@130,r@203000000&hl=zh-CN&gl=cn&src=app&x={x}&y={y}&z={z}&s=Gal', {subdomains: ["mt0", "mt1", "mt2", "mt3"] }).addTo(map)
      var clip = []
      var areacode = [350102, 350103, 350104, 350105, 350111, 350121, 350122, 350123, 350124, 350125, 350181, 350182]
      var ajax = 0
      var getJson = function (url) {
        var xmlhttp = new XMLHttpRequest()
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState === 4) {
              if (xmlhttp.status === 200) {
                var ret = JSON.parse(xmlhttp.responseText)
                var features = ret.features || []
                for (var j = 0; features[j]; j++) {
                  var rings = features[j].geometry.rings
                  clip = clip.concat(rings) 
                }
              } else {
                error(xmlhttp.responseText)
              }
              ajax++
              doNext()
            }
        };
        xmlhttp.open('GET', url)
        xmlhttp.send()
      }
      setTimeout(function(){
        for (var i = 0; areacode[i]; i++) {
          var url = '/35_福建省/01_福州/福州市防汛指挥图、内涝风险图服务应用平台项目/地图标绘/MapPlotting/src/data/areas/' + areacode[i] + '.json'
          getJson(url)
        }
      }, 0)

      function doNext () {
        if (!(areacode.length == ajax)) return
        draw()
        // setInterval(function () {draw()}, 5000)
      }
      function draw() {
        var url = './data.json'
        var xmlhttp = new XMLHttpRequest()
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState === 4) {
              if (xmlhttp.status === 200) {
                var data = JSON.parse(xmlhttp.responseText)

                // kriging
                var krigingImg = new IsoImage(data, {
                  type: 'kriging', // idw
                  extent: [[118.3, 26.8], [120.3, 25]],
                  clip: clip,
                  level: [
                    { value: 0, color: '#ffffff', unit: 'mm' },
                    { value: 5, color: '#A9F18D', unit: 'mm' },
                    { value: 10, color: '#38A801', unit: 'mm' },
                    { value: 25, color: '#61B8FF', unit: 'mm' },
                    { value: 30, color: '#81BcaF', unit: 'mm' },
                    { value: 50, color: '#0100FC', unit: 'mm' },
                    { value: 100, color: '#FA00FA', unit: 'mm' },
                    { value: 250, color: '#FF0000', unit: 'mm' }
                  ],
                  cellWidth: 0.01,
                  keyConfig: {
                    x: 'X',
                    y: 'Y',
                    v: 'VAL',
                    clipX: '0',
                    clipY: '1'
                  }
                })
                var krigingImgIsosurface = krigingImg.getIsoImage({
                  width: 600,
                  opacity: 0.8,
                  gradient: true,
                  isolineColor: '#666',
                  clip: false,
                  clipColor: '#333',
                  clipWidth: 1
                })

                var canvasLayer = krigingImg.layer().addTo(map)

                // L.polyline( [
                //   {lat: 25.763889, lng: 119.469167},
                //   {lat: 26.763889, lng: 119.469167}
                // ], { renderer: canvasLayer } ).addTo(map)

                // var isf = L.geoJSON(krigingImg.isosurface, {
                //   style: function (feature) {
                //       return {
                //         fill: true,
                //         stroke: true,
                //         weight: 1,
                //         opacity: 0.7,
                //         fillOpacity: 0.7,
                //         fillColor: feature.properties.color
                //       }
                //   },
                //   renderer: canvasLayer
                // }).addTo(map)

                // var fmtLatLng = function (latlngs, deep) {
                //   if (!deep) return [latlngs[1], latlngs[0]]
                //   deep--
                //   for (var i = 0, len = latlngs.length; i < len; i++) {
                //     latlngs[i] = fmtLatLng(latlngs[i], deep)
                //   }
                //   return latlngs
                // }

                // for (var i = 0; krigingImg.fmtLatlngsIsosurface.features[i]; i++) {
                //   var v = krigingImg.fmtLatlngsIsosurface.features[i]
                //   // var latlngs = fmtLatLng(v.geometry.coordinates, 2)
                  
                //   L.polygon(v.geometry.coordinates, {
                //     stroke: false,
                //     opacity: 0.7,
                //     fillOpacity: 0.7,
                //     fillColor: v.properties.color,
                //     renderer: canvasLayer
                //   }).addTo(map)
                // }
                // layer.addLayer(isf)
                // console.log(isf)
                // canvasLayer.addLayer(isf)
                // .addTo(canvasLayer)
                
                // L.geoJSON(krigingImg.isoline, {
                //   style: function (feature) {
                //       return {
                //         color: feature.properties.color
                //       }
                //   }
                // }).addTo(map)

                // krigingImg.drawIsosurface(canvasLayer).addTo(map)
                // krigingImg.drawIsoline(canvasLayer, {color: "#333"}).addTo(map)
                krigingImg.drawIsoImage(canvasLayer, {color: "#333", filter: [5, 25]}).addTo(map)
                // var legend = krigingImg.getLegend()
                // var legendImg = new Image()
                // legendImg.src = legend
                // document.body.appendChild(legendImg)
                krigingImg.drawLegend({
                  position: 'bottomleft'
                  // gradient: false,
                  // direction: 'horizontal'
                }).addTo(map)
                console.log(krigingImg)
              }
              else {
                error(xmlhttp.responseText)
              }
            }
        };
        xmlhttp.open('GET', url)
        xmlhttp.send()
      }
    </script>
  </body>
</html>
